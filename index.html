<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Ù…Ù†ØµØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ© ğŸš€</title>
    <!-- Meta Tags -->
    <meta property="og:title" content="Ù…Ù†ØµØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ© ğŸš€" />
    <meta property="og:description" content="Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„ØªØ¹Ù„Ù… Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„ØªÙŠ ØªØ¯Ù…Ø¬ Ø§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø¨Ø§Ù„ØªØ¹Ù„ÙŠÙ…!" />
    <meta property="og:image" content="https://i.postimg.cc/3RBYLnd3/818334fa-20ba-431a-ad38-6bec7ef02203.png" />
    <!-- PWA -->
    <link rel="manifest" href="./manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ©">
    <link rel="apple-touch-icon" href="https.i.postimg.cc/3RBYLnd3/818334fa-20ba-431a-ad38-6bec7ef02203.png">
    <meta name="theme-color" content="#0d1117">
    <!-- Fonts and Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- Font for Overlap Text Effect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bowlby+One&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- General & Base Styles --- */
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #010409;
            --border-primary: #30363d;
            --border-secondary: #21262d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --accent-primary: #2f81f7;
            --accent-primary-gradient: linear-gradient(180deg, #3081f7 0%, #1f6feb 100%);
            --accent-primary-border: #1158c7;
            --accent-secondary: #58a6ff;
            --success-gradient: linear-gradient(180deg, #238636 0%, #1a6328 100%);
            --success-border: #134b1f;
            --danger-primary: #da3633;
            --danger-border: #c82333;
            --warning-primary: #ffc107;
            --shadow-color-heavy: rgba(0,0,0,0.5);
            --shadow-color-light: rgba(0,0,0,0.4);
            --inset-shadow-light: rgba(255,255,255,0.05);
            --inset-shadow-dark: rgba(0,0,0,0.6);
        }

        .desert-mode {
            --bg-primary: #fdf6e3;
            --bg-secondary: #f5eeda;
            --bg-tertiary: #eee8d5;
            --border-primary: #d3cbbd;
            --border-secondary: #e6e0d2;
            --text-primary: #2c2622;
            --text-secondary: #8a7a66;
            --accent-primary: #d2691e;
            --accent-primary-gradient: linear-gradient(180deg, #e67e22 0%, #d35400 100%);
            --accent-primary-border: #a84300;
            --accent-secondary: #d35400;
            --success-gradient: linear-gradient(180deg, #28a745 0%, #218838 100%);
            --success-border: #1e7e34;
            --danger-primary: #dc3545;
            --danger-border: #c82333;
            --warning-primary: #b58900;
            --shadow-color-heavy: rgba(88, 76, 60, 0.3);
            --shadow-color-light: rgba(88, 76, 60, 0.2);
            --inset-shadow-light: rgba(0,0,0,0.05);
            --inset-shadow-dark: rgba(255,255,255,0.8);
        }
        
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            direction: rtl;
            text-align: center;
            overflow-x: hidden;
            transition: background-color 0.4s, color 0.4s;
        }
        .hidden { display: none !important; }
        .no-select { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }

        /* --- Global 3D Effects --- */
        h1, h2, h3, h4, h5, h6 {
             text-shadow: 0 2px 4px var(--shadow-color-light);
        }
        .portal-container button, .btn-3d {
            text-shadow: 0px 1px 2px var(--shadow-color-light);
            box-shadow: 0px 4px 8px var(--shadow-color-light), inset 0px -2px 1px var(--inset-shadow-light);
            transition: all 0.1s ease-in-out !important;
            transform: translateY(0);
        }
        .portal-container button:not(:disabled):hover, .btn-3d:hover {
            transform: translateY(-2px);
            box-shadow: 0px 6px 12px var(--shadow-color-heavy), inset 0px -2px 1px var(--inset-shadow-light);
        }
        .portal-container button:not(:disabled):active, .btn-3d:active {
            transform: translateY(1px);
            box-shadow: 0px 2px 4px var(--shadow-color-light), inset 0px 1px 1px var(--inset-shadow-dark);
        }
        input, select, textarea {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            color: var(--text-primary);
            border-radius: 8px;
            padding: 12px;
            width: 100%;
            margin-bottom: 15px;
            box-shadow: inset 0 2px 5px var(--inset-shadow-dark), 0 1px 0 var(--inset-shadow-light);
            transition: box-shadow 0.3s, border-color 0.3s, background-color 0.3s, color 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: inset 0 2px 5px var(--inset-shadow-dark), 0 0 10px var(--accent-primary);
        }
        .list-item, .test-item {
             background-color: var(--bg-secondary);
             border: 1px solid var(--border-primary);
             border-radius: 12px;
             padding: 15px;
             margin-bottom: 12px;
             display: flex;
             align-items: center;
             justify-content: space-between;
             box-shadow: 0 4px 10px var(--shadow-color-heavy), inset 0 1px 1px var(--inset-shadow-light);
             transition: transform 0.2s, box-shadow 0.2s, background-color 0.4s;
        }
        .list-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px var(--shadow-color-heavy);
        }
        .modal-content {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 15px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 40px var(--shadow-color-heavy), inset 0 2px 2px var(--inset-shadow-light);
            margin: auto;
        }

        .question-image-preview {
            width: 100%; max-height: 650px; border-radius: 12px; margin: 15px auto;
            display: block; cursor: pointer; object-fit: contain;
            border: 1px solid var(--border-primary);
            box-shadow: 0 4px 15px var(--shadow-color-heavy);
            transition: transform 0.2s ease;
        }
        .question-image-preview:hover { transform: scale(1.02); }

        /* --- Landing Page Styles --- */
        #canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            display: block;
            touch-action: none;
        }

        #main-landing-page {
            display: flex; flex-direction: column; justify-content: flex-start; align-items: center;
            min-height: 100vh; padding: 15vh 20px 5vh 20px;
            background-color: transparent; /* Make background transparent to see canvas */
            position: relative;
        }
        
        /* START: Overlapping Text Effect for Title */
        .landing-title.overlap-title {
            font-family: "Bowlby One", sans-serif;
            font-weight: 400;
            font-size: clamp(2.2rem, 10vw, 4.5rem);
            letter-spacing: -0.05em;
            color: #fff;
            text-shadow: 3px 3px 0px #000;
            display: flex;
            margin-bottom: 20px; /* Adjusted margin */
            transform: perspective(500px) rotateX(10deg);
        }
        .landing-title.overlap-title > span {
            z-index: calc(1 * var(--i, 1));
            min-width: 0.25ch;
        }
        /* END: Overlapping Text Effect */

        /* START: New Subtitle Styles */
        .landing-subtitles {
            color: #fff;
            text-align: center;
            margin-bottom: 40px; /* Space before buttons */
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        .landing-subtitles p {
            margin: 0;
            font-size: 1.5rem;
            line-height: 1.4;
            font-weight: 600;
        }
        .landing-subtitles p:last-child {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        /* END: New Subtitle Styles */

        .role-selection { display: flex; gap: 25px; flex-wrap: wrap; justify-content: center; }
        
        .btn-3d {
            padding: 20px 40px; border: none; border-radius: 99px; font-size: 1.5rem; 
            font-family: 'Cairo', sans-serif; font-weight: 800; color: #fff; cursor: pointer;
            position: relative; background-size: 300% 100%; border: 2px solid transparent;
            background-image: linear-gradient(45deg, #007bff, #00c6ff, #2f81f7, #007bff);
            transition: all 0.4s ease-in-out !important;
            box-shadow: 0 5px 15px rgba(47, 129, 247, 0.4);
            animation: gradient-animation 6s ease infinite; text-decoration: none;
        }
        
        @keyframes gradient-animation { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .btn-3d:hover { transform: translateY(-5px) scale(1.05); box-shadow: 0 10px 25px rgba(47, 129, 247, 0.6); }
        .btn-3d:active { transform: translateY(0) scale(1); box-shadow: 0 5px 15px rgba(47, 129, 247, 0.4); }
        .btn-3d i { margin-left: 15px; font-size: 1.8rem; }
        
        #main-landing-page.special-button-style .btn-3d {
            background-image: linear-gradient(45deg, #b0b0b0, #f8f8f8, #cccccc, #b0b0b0);
            color: #ffffff; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.6);
            box-shadow: 0 5px 15px rgba(150, 150, 150, 0.5); animation: none;
        }
        #main-landing-page.special-button-style .btn-3d:hover { box-shadow: 0 10px 25px rgba(150, 150, 150, 0.7); }
        #main-landing-page.special-button-style .btn-3d:active { box-shadow: 0 5px 15px rgba(150, 150, 150, 0.5); }

        /* --- General Portal Styles --- */
        .portal-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg-primary); animation: fadeIn 0.6s ease-out;
            color: var(--text-primary); overflow-y: auto; padding: 40px 20px 120px 20px;
        }
        .portal-content { max-width: 600px; margin: 0 auto; }
        .portal-container .icon-btn {
            width: 40px; height: 40px; border-radius: 50%; background: var(--border-secondary);
            border: 1px solid var(--border-primary); color: var(--text-primary); display: flex; align-items: center;
            justify-content: center; cursor: pointer; font-size: 18px; position: relative; 
            transition: background-color 0.2s, transform 0.2s;
        }
        .portal-container .icon-btn:hover { background-color: var(--border-primary); transform: scale(1.1); }
        .portal-container .icon-btn .notification-badge {
            position: absolute; top: -2px; right: -2px; width: 14px; height: 14px;
            background-color: var(--danger-primary); border-radius: 50%; 
            border: 2px solid var(--bg-primary); display: none;
        }
        .portal-container .spinner {
            border: 4px solid var(--border-primary); border-top: 4px solid var(--accent-primary);
            border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto;
        }
        .portal-container p { text-align: center; margin-top: 15px; font-size: 0.9rem; color: var(--text-secondary); }
        .portal-container p a { color: var(--accent-secondary); text-decoration: none; font-weight: 600; }
        .portal-container hr { border: none; border-top: 1px solid var(--border-primary); margin: 25px 0; }
        .portal-container button { width: 100%; padding: 14px 15px; border: none; border-radius: 12px; font-size: 1.1rem; font-family: 'Cairo', sans-serif; font-weight: 700; color: #fff; cursor: pointer; }
        .portal-container button:disabled { cursor: not-allowed; background: var(--border-secondary); border-bottom-color: var(--border-primary); opacity: 0.6; }
        .portal-container .btn-primary { background: var(--accent-primary-gradient); border-bottom: 4px solid var(--accent-primary-border); }
        .portal-container .btn-primary:not(:disabled):hover { border-bottom-width: 6px; }
        .portal-container .btn-primary:not(:disabled):active { border-bottom-width: 3px; }
        .portal-container .btn-secondary { background: var(--border-secondary); color: var(--text-primary); border-bottom: 4px solid var(--bg-tertiary); }
        .portal-container .btn-secondary:not(:disabled):hover { border-bottom-width: 6px; }
        .portal-container .btn-secondary:not(:disabled):active { border-bottom-width: 3px; }
        
        /* START: Interactive Bottom Navigation Bar */
        /* Ø¨Ø¯Ø§ÙŠØ©: Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ */
        .bottom-nav {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            padding: 8px;
            background-color: rgba(22, 27, 34, 0.75);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border-primary);
            border-radius: 99px;
            box-shadow: 0 8px 32px 0 var(--shadow-color-heavy);
            z-index: 1000;
            gap: 8px;
            filter: url(#gooey-filter); /* Gooey effect */
        }
        .bottom-nav .nav-blob {
            position: absolute;
            top: 8px;
            left: var(--blob-left, 8px);
            width: var(--blob-width, 0px);
            height: calc(100% - 16px);
            background-color: var(--accent-primary);
            border-radius: 99px;
            transition: left 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275), width 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1;
        }
        .bottom-nav .nav-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            opacity: 0.9;
            border-radius: 99px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: color 0.3s ease;
            z-index: 2; /* Must be above the blob */
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
        }
        .bottom-nav .nav-btn.active {
            color: #fff;
            opacity: 1;
        }
        /* END: Interactive Bottom Navigation Bar */

        .header-menu-container { position: relative; }
        .header-dropdown-menu { display: none; position: absolute; top: 50px; left: 0; background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 10px; box-shadow: 0 8px 20px var(--shadow-color-heavy); z-index: 1100; width: 200px; overflow: hidden; }
        .header-dropdown-menu.show { display: block; }
        .dropdown-item { display: flex; align-items: center; gap: 12px; padding: 12px 15px; color: var(--text-primary); text-decoration: none; font-size: 0.95rem; text-align: right; cursor: pointer; transition: background-color 0.2s ease; }
        .dropdown-item:hover { background-color: var(--border-secondary); }
        .dropdown-item i { width: 20px; text-align: center; color: var(--accent-secondary); text-shadow: none; }
        
        #teacher-portal .header-icons { position: absolute; top: 40px; left: 25px; display: flex; gap: 10px; z-index: 100; }
        #teacher-portal label { font-weight: 600; display: block; margin-bottom: 5px; text-align: right; }
        .file-input-label { background: var(--border-secondary); border: 2px dashed var(--border-primary); text-align: center; padding: 15px; border-radius: 10px; cursor: pointer; transition: border-color 0.3s, background-color 0.3s; }
        .file-input-label:hover { border-color: var(--accent-secondary); background-color: var(--border-primary); }
        .image-preview { max-width: 100px; max-height: 100px; border-radius: 8px; border: 1px solid #444; cursor: pointer; }
        .action-btn { padding: 6px 10px !important; font-size: 0.8rem !important; margin:0 !important; width: auto !important; display: flex; align-items: center; gap: 5px; }
        .test-countdown { font-size: 0.8rem; color: var(--warning-primary); font-weight: bold; margin-top: 5px; text-align: left; }
        .action-btn.btn-danger { background:var(--danger-primary); border-color:var(--danger-border); }

        .student-test-item-container { background: var(--bg-secondary); border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 15px var(--shadow-color-heavy), inset 0 1px 1px var(--inset-shadow-light); border: 1px solid var(--border-primary); overflow: hidden; transition: all 0.3s ease; }
        .student-test-item-container:hover { border-color: var(--accent-secondary); transform: translateY(-3px); box-shadow: 0 8px 25px var(--accent-primary); }
        .student-test-actions-bar { display: flex; justify-content: space-around; background: var(--border-secondary); padding: 8px; border-bottom: 1px solid var(--border-primary); }
        .student-test-actions-bar .action-icon { background: var(--border-primary); color: var(--text-secondary); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 2px 5px var(--shadow-color-heavy), inset 0 1px 1px var(--inset-shadow-light); font-size: 1.1rem; }
        .student-test-actions-bar .action-icon:hover { color: #fff; transform: translateY(-3px) scale(1.1); box-shadow: 0 4px 10px var(--shadow-color-heavy); }
        .action-icon[title="Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±"]:hover { background-color: #238636; }
        .action-icon[title="Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø©"]:hover { background-color: #8957e5; }
        .action-icon[title^="Ù…Ø±Ø§Ø³Ù„Ø©"]:hover { background-color: #1f6feb; }
        .action-icon[title="Ù…Ø´Ø§Ø±ÙƒØ© Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±"]:hover { background-color: #e3b341; }
        .action-icon[title="Ø¥Ø¹Ø§Ø¯Ø© (ØªØ¯Ø±ÙŠØ¨)"]:hover { background-color: #bf5507; }
        .student-test-card { padding: 12px 15px; display: flex; flex-direction: column; gap: 6px; }
        .test-main-info { display: flex; align-items: center; gap: 10px; }
        .test-grade-badge { background-color: color-mix(in srgb, var(--accent-secondary) 20%, transparent); color: var(--accent-secondary); padding: 3px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; flex-shrink: 0; border: 1px solid color-mix(in srgb, var(--accent-secondary) 50%, transparent); }
        .test-name { font-weight: bold; font-size: 1.1rem; text-align: right; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-shadow: 0 1px 2px #000; }
        .desert-mode .test-name { text-shadow: none; }
        .test-expiry { font-size: 0.75rem; color: var(--warning-primary); text-align: right; }
        
        #my-student-results-container .test-item:not(:last-child) { border-bottom: 2px solid var(--border-primary); }
        #my-student-results-container .test-item { border-radius: 0; margin-bottom: 0; border-left: none; border-right: none; border-top: none; }
        #my-student-results-container-wrapper { border: 1px solid var(--border-primary); border-radius: 12px; overflow: hidden; }
        #my-student-results-container-wrapper .test-item:first-child { border-top: none;}

        #search-bar { background-color: var(--bg-primary); border: 1px solid var(--border-primary); border-radius: 25px; padding: 10px 20px 10px 45px; font-size: 1rem; position: relative; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%238b949e' class='bi bi-search' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: 15px center; transition: all 0.3s ease-in-out; }
        .desert-mode #search-bar { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23584c3c' class='bi bi-search' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E"); }
        #search-bar:focus { background-color: var(--bg-tertiary); }
        #search-bar.hidden { transform: translateY(-20px); opacity: 0; pointer-events: none; }
        .dashboard-header-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .dashboard-header-controls .header-buttons { display: flex; gap: 10px; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 2000; display: flex; justify-content: center; align-items: flex-start; opacity: 0; visibility: hidden; transition: opacity 0.3s ease; overflow-y: auto; padding: 40px 15px; }
        .desert-mode .modal-overlay { background: rgba(253, 246, 227, 0.7); }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        
        /* START: 3D Prominent Close Button */
        /* Ø¨Ø¯Ø§ÙŠØ©: Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ ÙˆØ§Ù„Ø¨Ø§Ø±Ø² */
        .modal-close-btn {
            position: absolute;
            top: 15px;
            left: 15px;
            width: 40px; 
            height: 40px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
            border-radius: 50%;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            z-index: 10;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.3s, background-color 0.3s;
            box-shadow: 0 4px 8px var(--shadow-color-heavy), inset 0 1px 2px var(--inset-shadow-light);
        }
        .modal-close-btn:hover {
            background-color: var(--border-primary);
            transform: rotate(90deg) scale(1.1);
            box-shadow: 0 6px 12px var(--shadow-color-heavy), inset 0 1px 2px var(--inset-shadow-light);
        }
        .modal-close-btn:active {
            transform: rotate(90deg) scale(1.05);
            box-shadow: 0 2px 4px var(--shadow-color-heavy), inset 0 2px 4px var(--inset-shadow-dark);
        }
        .desert-mode .modal-close-btn { background: var(--bg-secondary); color: var(--text-primary); border-color: var(--border-primary); }
        /* END: 3D Prominent Close Button */

        .modal-body { flex-grow: 1; }
        .modal-footer { margin-top: 20px; flex-shrink: 0; }
        
        #teacher-review-modal .modal-content { max-width: 800px; }

        .image-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); z-index: 3000; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s ease; touch-action: none; }
        .image-modal-overlay.visible { opacity: 1; visibility: visible; }
        #image-viewer-content-wrapper { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; overflow: hidden; cursor: grab; }
        .image-modal-content { max-width: 90vw; max-height: 80vh; border-radius: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); transition: transform 0.2s ease-out; will-change: transform; pointer-events: none; }
        .image-viewer-controls { display: none; }
        .image-modal-download-btn { position: absolute; top: 20px; right: 20px; z-index: 3010; border-radius: 50%; text-decoration: none; background: rgba(40, 40, 40, 0.8); color: #fff; border: none; width: 45px; height: 45px; font-size: 18px; display: flex; align-items: center; justify-content: center; }
        
        .custom-dialog-overlay { position:fixed; inset:0; display:flex; justify-content:center; align-items:center; background:rgba(0,0,0,.7); backdrop-filter: blur(5px); opacity:0; visibility:hidden; transition:opacity .3s; z-index:9999; }
        .desert-mode .custom-dialog-overlay { background: rgba(253, 246, 227, 0.6); }
        .custom-dialog-overlay.show { opacity:1; visibility:visible; }
        .custom-dialog-overlay.show .custom-dialog { transform: scale(1); opacity: 1; animation: dialog-pop-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .custom-dialog { background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 20px; padding: 25px 30px; width: 90%; max-width: 420px; text-align: center; box-shadow: 0 10px 40px var(--shadow-color-heavy); border-top: 5px solid var(--accent-primary); transform:scale(0.9); opacity:0; transition:transform .3s,opacity .3s, background-color 0.4s, border-color 0.4s; }
        .dialog-icon { font-size: 4rem; line-height: 1; margin-bottom: 20px; color: var(--accent-secondary); animation: icon-bounce 0.6s 0.2s; }
        .custom-dialog h3 { font-size: 1.5rem; font-weight: 800; margin-bottom: 10px; }
        .custom-dialog p { font-size: 1rem; color: var(--text-secondary); line-height: 1.6; }
        .custom-dialog .dialog-buttons { display: flex; gap: 15px; justify-content: center; margin-top: 25px; }
        
        .dialog-buttons button { flex-grow: 1; font-weight: 800 !important; font-size: 1rem !important; padding: 12px 20px !important; border: none; border-radius: 10px; color: #fff; cursor: pointer; text-shadow: 0 1px 2px rgba(0,0,0,0.3); transition: all 0.15s ease-out; }
        .dialog-buttons button.btn-primary { background: var(--accent-primary-gradient); border-bottom: 4px solid var(--accent-primary-border); box-shadow: 0 4px 10px -2px var(--accent-primary); }
        .dialog-buttons button.btn-primary:hover { transform: translateY(-2px); border-bottom-width: 6px; box-shadow: 0 6px 15px -2px var(--accent-primary); }
        .dialog-buttons button.btn-primary:active { transform: translateY(1px); border-bottom-width: 3px; box-shadow: 0 2px 5px -2px var(--accent-primary); }
        .dialog-buttons button.btn-secondary { background: var(--border-secondary); color: var(--text-primary); border-bottom: 4px solid var(--bg-tertiary); }
        .dialog-buttons button.btn-secondary:hover { transform: translateY(-2px); border-bottom-width: 6px; background: var(--border-primary); }
        .dialog-buttons button.btn-secondary:active { transform: translateY(1px); border-bottom-width: 3px; }
        
        @keyframes dialog-pop-in { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes icon-bounce { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-20px); } 60% { transform: translateY(-10px); } }

        #text-chat-modal .chat-body { display: flex; flex-direction: column; gap: 12px; padding: 15px; max-height: 60vh; overflow-y: auto; }
        .chat-message { max-width: 80%; padding: 10px 15px; border-radius: 18px; line-height: 1.5; word-wrap: break-word; box-shadow: 0 2px 4px var(--shadow-color-light); }
        .chat-message.sent { background: var(--accent-primary); color: #fff; align-self: flex-end; border-bottom-right-radius: 4px; text-align: left; }
        .chat-message.received { background: var(--border-secondary); align-self: flex-start; border-bottom-left-radius: 4px; text-align: right; }
        .chat-message .msg-time { display: block; font-size: 0.7rem; color: var(--text-secondary); margin-top: 5px; opacity: 0.8; }
        .chat-message.sent .msg-time { color: rgba(255,255,255,0.7); }
        #text-chat-modal .chat-input-area { display: flex; gap: 10px; align-items: center; }
        #text-chat-modal textarea { flex-grow: 1; margin: 0; resize: none; }
        #text-chat-modal .chat-action-btn { width: 50px !important; height: 50px; padding: 0 !important; font-size: 1.2rem !important; flex-shrink: 0; border-radius: 50% !important; }
        #speech-to-text-btn.listening { color: var(--danger-primary); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 color-mix(in srgb, var(--danger-primary) 70%, transparent); } 70% { box-shadow: 0 0 0 10px color-mix(in srgb, var(--danger-primary) 0%, transparent); } 100% { box-shadow: 0 0 0 0 color-mix(in srgb, var(--danger-primary) 0%, transparent); } }

        .question-options { display: flex; flex-direction: column; gap: 10px; }
        .question-options label, .checkbox-container { display: flex; align-items: center; padding: 15px; background-color: var(--border-secondary); border: 1px solid var(--border-primary); border-radius: 10px; cursor: pointer; transition: all 0.3s ease; position: relative; }
        .question-options label:hover, .checkbox-container:hover { border-color: var(--accent-secondary); background-color: var(--border-primary); }
        .question-options input[type="radio"], .checkbox-container input[type="checkbox"] { display: none; }
        .question-options input[type="radio"] + span::before, .checkbox-container input[type="checkbox"] + label::before { content: ''; width: 22px; height: 22px; border: 2px solid var(--text-secondary); background-color: var(--bg-primary); display: inline-block; margin-left: 15px; vertical-align: middle; transition: all 0.2s; }
        .question-options input[type="radio"] + span::before { border-radius: 50%; }
        .checkbox-container input[type="checkbox"] + label::before { border-radius: 6px; }
        .question-options input[type="radio"]:checked + span::before, .checkbox-container input[type="checkbox"]:checked + label::before { background-color: var(--accent-primary); border-color: var(--accent-secondary); box-shadow: 0 0 0 3px var(--bg-primary), 0 0 0 5px var(--accent-primary); }
        .checkbox-container input[type="checkbox"]:checked + label::after { content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; position: absolute; right: 23px; top: 50%; transform: translateY(-50%); font-size: 14px; color: #fff; }
        .desert-mode .checkbox-container input[type="checkbox"]:checked + label::after { color: var(--bg-primary); }
        
        #app-install-prompt-modal .custom-dialog { padding: 0; overflow: hidden; border-top: none; }
        .app-install-header { padding: 20px; text-align: center; }
        .app-install-header img { width: 80px; height: 80px; border-radius: 15px; margin-bottom: 15px; box-shadow: 0 4px 15px var(--shadow-color-heavy); }
        .app-install-header h3 { font-size: 1.4rem; margin: 0; }
        .app-install-body { padding: 0 25px 25px 25px; }
        .app-install-body p { font-size: 1rem; color: var(--text-secondary); line-height: 1.6; }
        .app-install-footer { display: flex; flex-direction: column; gap: 10px; padding: 0 25px 25px 25px; }
        .app-install-footer .btn-install { display: inline-block; text-align: center; padding: 20px 40px; }

        /* START: Glassy Slogan Widget */
        /* Ø¨Ø¯Ø§ÙŠØ©: ØªØµÙ…ÙŠÙ… Ø´Ø±ÙŠØ· Ø§Ù„Ø´Ø¹Ø§Ø± Ø§Ù„Ø²Ø¬Ø§Ø¬ÙŠ */
        #slogan-widget {
            position: fixed;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            /* Changed to a semi-transparent background with blur */
            /* ØªÙ… Ø§Ù„ØªØºÙŠÙŠØ± Ù„Ø®Ù„ÙÙŠØ© Ø´Ø¨Ù‡ Ø´ÙØ§ÙØ© Ù…Ø¹ ØªØ£Ø«ÙŠØ± Ø¶Ø¨Ø§Ø¨ÙŠ */
            background: rgba(22, 27, 34, 0.7);
            backdrop-filter: blur(10px);
            color: #fff;
            padding: 5px 12px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            border: 1px solid rgba(255, 255, 255, 0.15);
            cursor: pointer;
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .desert-mode #slogan-widget {
            background: rgba(253, 246, 227, 0.7);
            backdrop-filter: blur(10px);
            color: var(--text-primary);
            border-color: rgba(0,0,0,0.1);
        }
        /* END: Glassy Slogan Widget */

        #slogan-widget:hover {
            transform: translateX(-50%) scale(1.05);
            box-shadow: 0 6px 20px var(--shadow-color-light);
        }
        #slogan-widget img { width: 30px; height: 30px; }
        #slogan-widget span { font-weight: bold; text-shadow: 1px 1.5px 3px var(--shadow-color-heavy); }

        /* Animations & Responsiveness */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes floating { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        @media (max-width: 767px) {
            .landing-title.overlap-title { font-size: 2rem; }
            .btn-3d { font-size: 1.2rem; padding: 18px 30px; }
             .landing-subtitles p { font-size: 1.1rem; }
             .landing-subtitles p:last-child { font-size: 0.9rem; }
        }
        
        .tab-content-header { display: flex; justify-content: space-between; align-items: center; gap: 15px; margin-bottom: 10px; }
        .tab-content-header h2 { margin: 0; }

    </style>
</head>
<body class="no-select">
    
    <canvas id="canvas"></canvas>

    <!-- ======== Fixed Slogan/Logo ======== -->
    <div id="slogan-widget">
        <img src="https://i.postimg.cc/BZw2BtL8/yourself-pharmacy-nutritional.png" alt="Ø´Ø¹Ø§Ø±ÙŠ">
        <span>Ø´Ø¹Ø§Ø±ÙŠ</span>
    </div>

    <!-- ======== Main Landing Page Section ======== -->
    <main id="main-landing-page">
        <h2 class="landing-title overlap-title" style="direction: ltr;">Smart Test Platform</h2>
        <div class="landing-subtitles">
            <p>Your gateway to interactive learning</p>
            <p>Bridging technology and education.</p>
        </div>
        <div class="role-selection">
            <button id="show-teacher-portal" class="btn-3d">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† <i class="fas fa-chalkboard-teacher"></i></button>
            <button id="show-student-portal" class="btn-3d">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ <i class="fas fa-user-graduate"></i></button>
        </div>
    </main>

    <!-- ======== Teacher Portal Section (Initially Hidden) ======== -->
    <div id="teacher-portal" class="portal-container hidden">
        <div class="portal-content">
            <div class="header-icons">
                <button class="icon-btn theme-toggle-btn" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¸Ù‡Ø±"><i class="fas fa-sun"></i></button>
                <div class="header-menu-container">
                    <div id="teacher-menu-icon" class="icon-btn" title="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©"><i class="fas fa-ellipsis-v"></i><span class="notification-badge"></span></div>
                    <div id="teacher-dropdown-menu" class="header-dropdown-menu">
                        <div class="dropdown-item" id="teacher-chat-btn"><i class="fas fa-comments"></i><span>Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</span></div>
                        <div class="dropdown-item" id="teacher-settings-btn"><i class="fas fa-cog"></i><span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span></div>
                        <div class="dropdown-item" id="teacher-share-platform-btn"><i class="fas fa-share-alt"></i><span>Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ù†ØµØ©</span></div>
                        <hr style="margin: 0;">
                        <div class="dropdown-item" id="teacher-logout-btn" style="color: var(--warning-primary);"><i class="fas fa-sign-out-alt"></i><span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span></div>
                    </div>
                </div>
            </div>
            <section id="teacher-register-section">
                <h1>ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ - Ù…Ø¹Ù„Ù…</h1>
                <input type="text" id="teacher-register-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ (Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©)" required />
                <input type="password" id="teacher-register-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required />
                <button id="teacher-register-btn" class="btn-primary">ØªØ³Ø¬ÙŠÙ„</button>
                <p>Ù‡Ù„ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <a href="#" class="to-login">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</a></p>
            </section>
            <section id="teacher-login-section" class="hidden">
                <h1>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ - Ù…Ø¹Ù„Ù…</h1>
                <input type="text" id="teacher-login-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ (Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©)" required />
                <input type="password" id="teacher-login-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required />
                <button id="teacher-login-btn" class="btn-primary">Ø¯Ø®ÙˆÙ„</button>
                <p>Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <a href="#" class="to-register">ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</a></p>
            </section>
            <section id="teacher-dashboard-section" class="hidden">
                <div class="dashboard-header-controls">
                     <h1>Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨ÙƒØŒ <span id="teacher-name"></span>!</h1>
                </div>
                <hr />
                <div id="teacher-tests-content" class="tab-content">
                    <div class="tab-content-header">
                        <h2>Ø§Ø®ØªØ¨Ø§Ø±Ø§ØªÙŠ Ø§Ù„Ù…Ù†Ø´Ø£Ø©</h2>
                        <button id="teacher-refresh-btn" class="icon-btn" title="ØªØ­Ø¯ÙŠØ«"><i class="fas fa-sync-alt"></i></button>
                    </div>
                    <div id="my-tests-container"></div>
                </div>
                <div id="teacher-results-content" class="tab-content hidden"><h2>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨</h2><select id="results-test-selector"></select><div id="student-results-container"></div></div>
                <div id="teacher-create-test-content" class="tab-content hidden">
                    <h2 id="create-edit-title">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯</h2>
                    <label for="test-name">Ø§Ø³Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</label><input type="text" id="test-name" />
                    <label for="test-grade">Ø§Ù„ØµÙ:</label>
                    <select id="test-grade"><option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„ØµÙ</option><option value="Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option><option value="Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option><option value="Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option><option value="Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option><option value="Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option><option value="Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option></select>
                    <label for="test-duration">Ù…Ø¯Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚:</label><input type="number" id="test-duration" min="1" />
                    <div class="checkbox-container"><input type="checkbox" id="prevent-go-back-checkbox"><label for="prevent-go-back-checkbox">Ù…Ù†Ø¹ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ù† Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø®Ù„Ù</label></div>
                    <div class="checkbox-container"><input type="checkbox" id="shuffle-questions-checkbox"><label for="shuffle-questions-checkbox">ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠÙ‹Ø§</label></div>
                    <div class="checkbox-container"><input type="checkbox" id="fateful-test-checkbox"><label for="fateful-test-checkbox">Ø§Ø®ØªØ¨Ø§Ø± Ù…ØµÙŠØ±ÙŠ (Ø£Ù…Ø§Ù† Ø¹Ø§Ù„ÙŠ)</label></div>
                    <hr/><h3>Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯</h3>
                    <div style="display: flex; border: 1px solid var(--border-primary); border-radius: 12px; overflow: hidden; margin-bottom: 15px;">
                        <button class="switch-button active" data-type="mcq" style="flex:1; padding:10px; background: var(--accent-primary); border:none; color: #fff; cursor: pointer; transition: all 0.3s ease;">Ø³Ø¤Ø§Ù„ Ø§Ø®ØªÙŠØ§Ø±ÙŠ</button>
                        <button class="switch-button" data-type="essay" style="flex:1; padding:10px; background: var(--border-secondary); border:none; color: var(--text-primary); cursor: pointer; transition: all 0.3s ease;">Ø³Ø¤Ø§Ù„ Ù…Ù‚Ø§Ù„ÙŠ</button>
                    </div>
                    <label for="question-text">Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„:</label><textarea id="question-text" rows="3"></textarea>
                    <label for="question-image-input" class="file-input-label"><i class="fas fa-image"></i> <span>Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© Ù„Ù„Ø³Ø¤Ø§Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span></label>
                    <input type="file" id="question-image-input" accept="image/*" class="hidden" /><div class="image-preview-container hidden"><img class="image-preview" src="#" alt="Ù…Ø¹Ø§ÙŠÙ†Ø©" /></div>
                    <div id="mcq-fields">
                        <label>Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© (4):</label>
                        <input type="text" class="option-input" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± 1" /><input type="text" class="option-input" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± 2" /><input type="text" class="option-input" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± 3" /><input type="text" class="option-input" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± 4" />
                        <label for="correct-answer">Ø±Ù‚Ù… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© (1 - 4):</label><input type="number" id="correct-answer" min="1" max="4" />
                    </div>
                    <div id="essay-fields" class="hidden">
                        <label for="model-answer-image-input" class="file-input-label"><i class="fas fa-file-image"></i> <span>Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© Ø¥Ø¬Ø§Ø¨Ø© Ù†Ù…ÙˆØ°Ø¬ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span></label>
                        <input type="file" id="model-answer-image-input" accept="image/*" class="hidden"><div class="image-preview-container hidden"><img class="image-preview" src="#" alt="Ù…Ø¹Ø§ÙŠÙ†Ø©" /></div>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
                        <label for="question-points" style="margin: 0; flex-shrink: 0;">Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø³Ø¤Ø§Ù„:</label>
                        <input type="number" id="question-points" min="1" placeholder="1" style="margin: 0; width: 80px;">
                        <button id="add-question-btn" class="btn-secondary" style="margin: 0; flex-grow: 1;">Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
                        <button id="cancel-question-edit-btn" class="btn-secondary hidden" style="margin: 0; width: auto; background: #5a6268; border-color: #495057;">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
                    </div>
                    <div id="questions-list-container" style="margin-top: 15px;"></div>
                    <button id="save-test-btn" class="btn-primary" style="margin-top: 20px; background: var(--success-gradient); border-bottom-color: var(--success-border);">Ø­ÙØ¸ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
                    <button id="cancel-test-edit-btn" class="btn-secondary hidden" style="margin-top: 10px;">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
                </div>
            </section>
        </div>
        <!-- Teacher Modals -->
        <div id="teacher-review-modal" class="modal-overlay">
            <div class="modal-content">
                <button class="modal-close-btn">&times;</button>
                <h2 id="review-modal-title">Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h2>
                <div id="review-modal-body" class="modal-body"></div>
                <div id="review-modal-footer" class="modal-footer hidden">
                    <button id="finalize-grades-btn" class="btn-primary">Ø­ÙØ¸ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</button>
                </div>
            </div>
        </div>
        <div id="teacher-settings-modal" class="modal-overlay">
            <div class="modal-content" style="max-width: 450px;">
                <button class="modal-close-btn">&times;</button>
                <h2>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
                <label for="teacher-update-name">Ø§Ù„Ø§Ø³Ù… (Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©):</label>
                <input type="text" id="teacher-update-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯">
                <label for="teacher-update-password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:</label>
                <input type="password" id="teacher-update-password" placeholder="Ø§ØªØ±ÙƒÙ‡Ø§ ÙØ§Ø±ØºØ© Ù„Ø¹Ø¯Ù… Ø§Ù„ØªØºÙŠÙŠØ±">
                <button id="teacher-update-btn" class="btn-primary" style="margin-top: 10px;">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø³Ø§Ø¨</button>
            </div>
        </div>
        <!-- START: New Teacher Bottom Nav -->
        <!-- Ø¨Ø¯Ø§ÙŠØ©: Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…Ø¹Ù„Ù… -->
        <nav class="bottom-nav hidden" id="teacher-bottom-nav">
            <div class="nav-blob"></div>
            <button class="nav-btn active" data-target="teacher-tests-content"><i class="fas fa-file-alt"></i><span>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</span></button>
            <button class="nav-btn" data-target="teacher-results-content"><i class="fas fa-poll-h"></i><span>Ø§Ù„Ù†ØªØ§Ø¦Ø¬</span></button>
            <button class="nav-btn" data-target="teacher-create-test-content"><i class="fas fa-plus-circle"></i><span>Ø¥Ù†Ø´Ø§Ø¡</span></button>
        </nav>
        <!-- END: New Teacher Bottom Nav -->
    </div>

    <!-- ======== Student Portal Section (Initially Hidden) ======== -->
    <div id="student-portal" class="portal-container hidden">
         <div class="portal-content">
             <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h1 style="font-size:1.8rem; margin:0;"><i class="fas fa-graduation-cap"></i> Ù…Ù†ØµØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</h1>
                <div class="header-icons" style="position: static; display: flex; gap: 10px;">
                     <button class="icon-btn theme-toggle-btn" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¸Ù‡Ø±"><i class="fas fa-sun"></i></button>
                     <div class="header-menu-container">
                        <div id="student-menu-icon" class="icon-btn" title="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©"><i class="fas fa-ellipsis-v"></i><span class="notification-badge"></span></div>
                        <div id="student-dropdown-menu" class="header-dropdown-menu">
                            <div class="dropdown-item" id="student-chat-btn"><i class="fas fa-comments"></i><span>Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</span></div>
                            <div class="dropdown-item" id="student-settings-btn"><i class="fas fa-cog"></i><span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span></div>
                            <div class="dropdown-item" id="student-share-platform-btn"><i class="fas fa-share-alt"></i><span>Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ù†ØµØ©</span></div>
                            <hr style="margin: 0;">
                            <div class="dropdown-item" id="student-logout-btn" style="color: var(--warning-primary);"><i class="fas fa-sign-out-alt"></i><span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <section id="student-register-section">
                <h2>ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h2>
                <input type="text" id="student-register-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ (Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©)" required autocomplete="off">
                <input type="password" id="student-register-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required autocomplete="new-password">
                <button id="student-register-btn" class="btn-primary">ØªØ³Ø¬ÙŠÙ„</button><p>Ù‡Ù„ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <a href="#" class="to-login">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</a></p>
            </section>
            <section id="student-login-section" class="hidden">
                <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
                <input type="text" id="student-login-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ (Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©)" required autocomplete="off">
                <input type="password" id="student-login-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required autocomplete="current-password">
                <button id="student-login-btn" class="btn-primary">Ø¯Ø®ÙˆÙ„</button><p>Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <a href="#" class="to-register">ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</a></p>
            </section>
            <section id="student-dashboard-section" class="hidden">
                 <div class="dashboard-header-controls">
                    <h1>Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨ÙƒØŒ <span id="student-name"></span>!</h1>
                 </div>
                <hr />
                <div class="tab-content" id="student-tests-content">
                    <div class="dashboard-header-controls">
                        <h2>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</h2>
                        <div class="header-buttons">
                             <button id="refresh-tests-btn" class="icon-btn" title="ØªØ­Ø¯ÙŠØ«"><i class="fas fa-sync-alt"></i></button>
                             <button id="show-search-btn" class="icon-btn" title="Ø¨Ø­Ø«"><i class="fas fa-search"></i></button>
                        </div>
                    </div>
                    <input type="text" id="search-bar" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø®ØªØ¨Ø§Ø±..." class="hidden" style="margin-bottom:20px;"/>
                    <div id="available-tests-container"></div>
                </div>
                <div class="tab-content hidden" id="student-results-content"><h2>Ù†ØªØ§Ø¦Ø¬ÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h2><div id="my-student-results-container-wrapper"><div id="my-student-results-container"></div></div></div>
            </section>
            <section id="take-test-section" class="hidden">
                <h2 id="current-test-title"></h2>
                <div id="timer" style="font-size:1.6rem; font-weight:700; color:var(--warning-primary); margin-bottom:8px;"></div>
                <div style="width:100%; height:8px; background:var(--border-secondary); border-radius:4px; overflow:hidden; margin-bottom:20px;"><div id="timer-progress" style="height:100%; width:100%; background:var(--accent-primary-gradient); transition:width .5s linear;"></div></div>
                <div id="questions-display"></div>
                <div id="question-navigation-container" style="display:flex; gap:10px; margin-top: 20px;" class="hidden">
                    <button id="prev-question-btn" class="btn-secondary">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
                    <button id="next-question-btn" class="btn-primary">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                </div>
                <button id="submit-test-btn" class="btn-primary" style="margin-top: 20px; background: var(--success-gradient); border-bottom-color: var(--success-border);">ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
                <button id="cancel-test-btn" class="btn-secondary" style="margin-top: 10px;">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
            </section>
            <section id="test-result-section" class="hidden">
                <h1>Ù†ØªÙŠØ¬ØªÙƒ</h1>
                <h2 id="final-score" style="font-size:2rem; margin:15px 0;"></h2>
                <div id="feedback-message" style="padding:15px; border-radius:12px; margin-top:15px; font-weight:600; font-size: 1.1rem;"></div>
                <button id="review-answers-btn" class="btn-primary">Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</button>
                <button id="back-to-dashboard-btn" class="btn-secondary" style="margin-top: 10px;">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
            </section>
            <section id="review-section" class="hidden">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                     <h1>Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</h1>
                     <button id="back-to-dashboard-from-review-btn" class="btn-secondary" style="width: auto; padding: 10px 20px !important; margin:0;">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
                </div>
                <hr/>
                <div id="review-container"></div>
            </section>
         </div>
         <div id="student-settings-modal" class="modal-overlay">
            <div class="modal-content" style="max-width: 450px;">
                <button class="modal-close-btn">&times;</button>
                <h2>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
                <label for="student-update-name">Ø§Ù„Ø§Ø³Ù… (Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©):</label>
                <input type="text" id="student-update-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯">
                <label for="student-update-password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:</label>
                <input type="password" id="student-update-password" placeholder="Ø§ØªØ±ÙƒÙ‡Ø§ ÙØ§Ø±ØºØ© Ù„Ø¹Ø¯Ù… Ø§Ù„ØªØºÙŠÙŠØ±">
                <button id="student-update-btn" class="btn-primary" style="margin-top:10px;">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø³Ø§Ø¨</button>
            </div>
        </div>
        <div id="student-chat-list-modal" class="modal-overlay">
            <div class="modal-content" style="max-width: 500px;">
                <button class="modal-close-btn">&times;</button>
                <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</h2>
                <div id="student-chat-list-body" class="modal-body"></div>
            </div>
        </div>
         <!-- START: New Student Bottom Nav -->
         <!-- Ø¨Ø¯Ø§ÙŠØ©: Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø·Ø§Ù„Ø¨ -->
         <nav class="bottom-nav hidden" id="student-bottom-nav">
            <div class="nav-blob"></div>
            <button class="nav-btn active" data-target="student-tests-content"><i class="fas fa-book-open"></i><span>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</span></button>
            <button class="nav-btn" data-target="student-results-content"><i class="fas fa-poll-h"></i><span>Ù†ØªØ§Ø¦Ø¬ÙŠ</span></button>
        </nav>
        <!-- END: New Student Bottom Nav -->
    </div>
    
    <!-- ======== Universal Modals ======== -->
    <div id="image-viewer-modal" class="image-modal-overlay">
        <div class="image-viewer-controls"></div>
        <button class="modal-close-btn">&times;</button>
        <a href="#" class="image-modal-download-btn" download="image.jpg"><i class="fas fa-download"></i></a>
        <div id="image-viewer-content-wrapper">
             <img src="" alt="Image Preview" class="image-modal-content">
        </div>
    </div>

    <div id="text-chat-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <button class="modal-close-btn">&times;</button>
            <h2 id="chat-modal-title">Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹</h2>
            <div class="chat-body" id="chat-modal-body"></div>
            <div class="modal-footer">
                <p id="message-limit-text" style="font-size: 0.9rem; color: var(--warning-primary); margin-bottom: 10px;"></p>
                <div class="chat-input-area">
                    <button id="speech-to-text-btn" class="chat-action-btn btn-secondary"><i class="fas fa-microphone"></i></button>
                    <textarea id="chat-message-input" rows="1" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." style="height: 50px;"></textarea>
                    <button id="send-chat-message-btn" class="chat-action-btn btn-primary"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="teacher-chat-list-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <button class="modal-close-btn">&times;</button>
            <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</h2>
            <div id="teacher-chat-list-body" class="modal-body"></div>
        </div>
    </div>

    <!-- ======== Custom Dialogs (Alerts/Confirms) ======== -->
    <div id="custom-alert-container" class="custom-dialog-overlay">
        <div class="custom-dialog">
            <div class="dialog-icon"><i class="fas fa-check-circle"></i></div>
            <h3 id="custom-alert-title"></h3>
            <p id="custom-alert-message"></p>
            <div class="dialog-buttons">
                <button id="custom-alert-close-btn" class="btn-primary">Ù…ÙˆØ§ÙÙ‚</button>
            </div>
        </div>
    </div>
    <div id="custom-confirm-container" class="custom-dialog-overlay">
        <div class="custom-dialog">
            <div class="dialog-icon"><i class="fas fa-question-circle"></i></div>
            <h3 id="custom-confirm-title"></h3>
            <p id="custom-confirm-message"></p>
            <div class="dialog-buttons">
                <button id="custom-confirm-cancel-btn" class="btn-secondary">Ø¥Ù„ØºØ§Ø¡</button>
                <button id="custom-confirm-ok-btn" class="btn-primary">ØªØ£ÙƒÙŠØ¯</button>
            </div>
        </div>
    </div>

    <!-- ======== App Install Prompt Modal ======== -->
    <div id="app-install-prompt-modal" class="custom-dialog-overlay">
        <div class="custom-dialog">
            <div class="app-install-header">
                <img src="https://i.postimg.cc/rm50gg3z/Whats-App-Image-2025-10-02-at-4-15-54-PM.jpg" alt="Ø´Ø¹Ø§Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚">
                <h3>Ø­Ø§Ù† Ø§Ù„ÙˆÙ‚Øª Ù„ØªØ¬Ø±Ø¨Ø© Ø£ÙØ¶Ù„!</h3>
            </div>
            <div class="app-install-body">
                <p>Ø¹Ù„ÙŠÙƒ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ø±Ø¤ÙŠØ© ÙƒØ§ÙØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§ØªØŒ Ù…Ø¹Ø±ÙØ© Ø¯Ø±Ø¬Ø§ØªÙƒØŒ ÙˆØ§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ø¨Ø³Ù‡ÙˆÙ„Ø©.</p>
            </div>
            <div class="app-install-footer">
                <a href="https://apk.e-droid.net/apk/app3760290-c4w5f2.apk?v=5" download class="btn-3d btn-install">ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¢Ù†</a>
                <button id="app-install-cancel-btn" class="btn-secondary" style="width:100%; padding: 12px 20px;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <!-- START: SVG Filter for Gooey Effect -->
    <!-- Ø¨Ø¯Ø§ÙŠØ©: ÙÙ„ØªØ± SVG Ù„ØªØ£Ø«ÙŠØ± Ø§Ù„Ù€ Gooey -->
    <svg width="0" height="0" style="position: absolute;">
        <defs>
            <filter id="gooey-filter">
                <feGaussianBlur in="SourceGraphic" stdDeviation="10" result="blur" />
                <feColorMatrix in="blur" mode="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 18 -7" result="gooey" />
                <feComposite in="SourceGraphic" in2="gooey" operator="atop"/>
            </filter>
        </defs>
    </svg>
    <!-- END: SVG Filter for Gooey Effect -->

    <!-- Shader Code for Background -->
    <script type="x-shader/x-fragment" class="hidden">#version 300 es
    /*********
    * made by Matthias Hurrle (@atzedent)
    * Cubemap texture made by Emil Persson, aka Humus.
    * http://www.humus.name
    * licensed under a Creative Commons Attribution 3.0 Unported License.
    * http://creativecommons.org/licenses/by/3.0/
    */
    precision highp float;
    out vec4 O;
    uniform float time;
    uniform vec2 resolution;
    uniform vec2 move;
    uniform samplerCube cubeMap;
    uniform int pointerCount;
    #define P pointerCount
    #define FC gl_FragCoord.xy
    #define R resolution
    #define T time
    #define N normalize
    #define S smoothstep
    #define MN min(R.x,R.y)
    #define rot(a) mat2(cos((a)-vec4(0,11,33,0)))
    #define hue(a) (.5+.5*sin(6.3*(a)+vec3(1,2,3)))
    #define cmul(a,b) vec2(a.x*b.x-a.y*b.y,a.x*b.y+a.y*b.x)
    float swirls(in vec3 p, float k) {
        vec3 c=p;
        float d=.2;
        for (float i=.0; i<5.; i++) {
            p=.7*abs(p)/dot(p,p)-.7;
            p.z-=.0618*(1.+i);
            p.yz=cmul(p.yz,p.yz);
            p=p.zxy;
        d+=exp(-9.*abs(dot(p,c)))*k/(5.-i);
        }
        return d;
    }
    vec3 march(in vec3 p, in vec3 rd) {
        vec3 col=vec3(0), q=p;
        float t=.0, d=.2, c=.0;
        for (float i=.0; i<60.; i++) {
            t+=d*exp(-1.4*c);
            c=swirls(p+rd*t, 2.1/t);
            col+=3e-2*c*hue(1.57*exp(-log(dot(p,p))*.9)*(i+1.)*c+.25);
        }
        return col;
    }
    float box(in vec3 p, in vec3 s, float r) {
        p=abs(p)-s+r;
        return length(max(p,.0))+min(.0,max(max(p.x,p.y),p.z))-r;
    }
    float map(in vec3 p) {
        return abs(box(p,vec3(1.1),25e-2))-.0085;
    }
    vec3 norm(in vec3 p) {
        float h=1e-3; vec2 k=vec2(-1,1);
        return N(
            k.xyy*map(p+k.xyy*h)+
            k.yxy*map(p+k.yxy*h)+
            k.yyx*map(p+k.yyx*h)+
            k.xxx*map(p+k.xxx*h)
        );
    }
    void cam(inout vec3 p) {
        p.yz*=rot(-.84 + move.y*6.3/MN + T * .15);
        p.xz*=rot(.42 - move.x*6.3/MN + T * .2);
    }
    vec3 blur(vec3 p) {
        vec2 uv=(FC-.5*R)/MN;
        uv.y+=.2;
        float s=clamp(dot(uv,uv),.001,1.);
        s=sqrt(s);
        s=5.*s/MN;
    vec3 col=vec3(0);
        for (float x=-1.; x<2.; x++)
        for (float y=-1.; y<2.; y++) {
        for (float z=-1.; z<2.; z++) {
            vec3 o=vec3(x,y,z)*s;
            col+=max(col,texture(cubeMap,p+o).rgb)/27.;
        }}
    return col;
    }
    void main() {
        vec2 uv=(FC-.5*R)/MN;
        vec3 col=vec3(0),
        p=vec3(0,0,-4),
        rd=N(vec3(uv,1)), lp=vec3(1,3,-3);
        cam(p); cam(rd);
        float side=1., bnz=.0, dd=.0, at=.0;
        for (float i=.0; i<400.; i++) {
            float d=map(p)*side;
            if (abs(d)<1e-3) {
                if (bnz++>2.) break;
                vec3 n=norm(p)*side,
                l=N(lp-p),
                bg=texture(cubeMap,reflect(rd,n)).rrr;
                if (dot(l,n)<.0) l=-l;
                float dif=clamp(dot(l,n),.0,1.),
                spk=pow(clamp(dot(reflect(rd,n),N(vec3(0,5,0)-p)),.0,1.),12.),
                fres=pow(clamp(1.+dot(rd,n),.0,1.),5.),
                ldst=max(length(p),3e-3),
                attn=1./(10.+ldst*.5+ldst*ldst*.1);
                col=mix(vec3(.3)*mix(.5+dif,.0,fres),col,.9);
                col=mix(vec3(1)*sqrt(dif)*1./max(5e-2,length(p)),col,.975);
                col=mix(mix(col*vec3(.6,.8,1).bgr,vec3(1.-attn),fres),col,.75);
    col=mix(col,bg,fres);
    col+=spk*spk*spk*(3.-bnz)*.5*hue(sqrt(spk));
                if (bnz==1.) {
                    vec3 rdd=N(vec3(uv,.2));
                    cam(rdd);
                    col+=fres*.3;
                    rd=refract(rdd,n,.88);
                    col=mix(march(4.*p,rd),col,fres);
            col*=1.2;
            col=S(-.5,1.5,col);
                    if ((col.r+col.g+col.b)/3. > .85) {
                        col+=spk*.25;
                        break;
                    }
                    col=S(.1,.65,col);
                    col=tanh(col*col*col);
                    col=pow(col,vec3(.4545));
            col=mix(col,bg,fres);
                    col+=spk*.75;
                }
                side=-side;
                d=55e-3;
            }
            if (d>10.){
                vec3 rdd=N(vec3(uv,.3));
                cam(rdd);
                vec3 c=blur(rdd);
    c=mix(c,vec3(dot(c,vec3(.21,.71,.07))),.5);
                col=mix(vec3(.1,.2,.3),vec3(.01,.02,.03),pow(S(.0,.95,dot(uv,uv)),.9));
                col=mix(col,(c+c.r*2.)/3.5,S(1.5,.125,dot(uv,uv)));
                col+=sqrt(at*vec3(1,.95,.8))*1.5;
                break;
            }
            p+=rd*d;
            dd+=d;
            at+=.05*(.05/dd);
        }
        float t=min((time-.5)*.3,1.);
        col=mix(vec3(0),col,t);
        col=S(-.15,1.1,.9*col);
    O=vec4(col,1);
    }</script>

    <!-- ======== Main JavaScript Logic =======-->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";
        import { getDatabase, ref, set, get, onValue, push, serverTimestamp, remove, update, query, orderByChild, equalTo, off } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDb19zrwV84CCbI8s2q8utFdIhasokmrpQ",
            authDomain: "saif-28e78.firebaseapp.com",
            databaseURL: "https://saif-28e78-default-rtdb.firebaseio.com",
            projectId: "saif-28e78",
            storageBucket: "saif-28e78.appspot.com",
            messagingSenderId: "979905571539",
            appId: "1:979905571539:web:3ff28289e17d3180964226",
            measurementId: "G-47JV5KDDTP"
        };

        const app = initializeApp(firebaseConfig);
        getAnalytics(app);
        const db = getDatabase(app);

        const mainLandingPage = document.getElementById('main-landing-page');
        const teacherPortal = document.getElementById('teacher-portal');
        const studentPortal = document.getElementById('student-portal');
        let countdownInterval = null;

        document.getElementById('show-teacher-portal').addEventListener('click', (e) => { e.preventDefault(); mainLandingPage.classList.add('hidden'); teacherPortal.classList.remove('hidden'); initTeacherApp(); });
        document.getElementById('show-student-portal').addEventListener('click', (e) => { e.preventDefault(); mainLandingPage.classList.add('hidden'); studentPortal.classList.remove('hidden'); initStudentApp(); });
        
        const getBase64 = (file) => new Promise((resolve, reject) => { const reader=new FileReader();reader.readAsDataURL(file);reader.onload=()=>resolve(reader.result);reader.onerror=e=>reject(e) });
        
        const alertCont = document.getElementById('custom-alert-container');
        const confirmCont = document.getElementById('custom-confirm-container');
        const appInstallPrompt = document.getElementById('app-install-prompt-modal');
        
        const showCustomAlert = (title, message) => { alertCont.querySelector('#custom-alert-title').textContent = title; alertCont.querySelector('#custom-alert-message').innerHTML = message; alertCont.classList.add('show'); };
        alertCont.querySelector('#custom-alert-close-btn').onclick = () => alertCont.classList.remove('show');
        appInstallPrompt.querySelector('#app-install-cancel-btn').onclick = () => appInstallPrompt.classList.remove('show');

        const showCustomConfirm = (title, message) => {
            return new Promise(resolve => {
                confirmCont.querySelector('#custom-confirm-title').textContent = title; confirmCont.querySelector('#custom-confirm-message').textContent = message; confirmCont.classList.add('show');
                const okBtn = confirmCont.querySelector('#custom-confirm-ok-btn'), cancelBtn = confirmCont.querySelector('#custom-confirm-cancel-btn');
                const newOkBtn = okBtn.cloneNode(true); okBtn.parentNode.replaceChild(newOkBtn, okBtn);
                const newCancelBtn = cancelBtn.cloneNode(true); cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
                const cleanup = (result) => { confirmCont.classList.remove('show'); resolve(result); };
                newOkBtn.addEventListener('click', () => cleanup(true), { once: true });
                newCancelBtn.addEventListener('click', () => cleanup(false), { once: true });
            });
        };

        async function sharePlatform() { const shareData = { title: 'Ù…Ù†ØµØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ©', text: 'Ø§ÙƒØªØ´Ù Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„ØªØ¹Ù„Ù… Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„ØªÙŠ ØªØ¯Ù…Ø¬ Ø§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø¨Ø§Ù„ØªØ¹Ù„ÙŠÙ…!', url: window.location.origin + window.location.pathname, }; try { if (navigator.share) { await navigator.share(shareData); } else { await navigator.clipboard.writeText(shareData.url); showCustomAlert('ØªÙ… Ø§Ù„Ù†Ø³Ø®', 'ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù†ØµØ© Ø¨Ù†Ø¬Ø§Ø­!'); } } catch (err) { console.error("Share failed:", err); } }
        
        const themeToggleButtons = document.querySelectorAll('.theme-toggle-btn'), body = document.body;
        function applyTheme(theme) { themeToggleButtons.forEach(button => { const icon = button.querySelector('i'); if (theme === 'desert') { body.classList.add('desert-mode'); icon.classList.remove('fa-sun'); icon.classList.add('fa-moon'); } else { body.classList.remove('desert-mode'); icon.classList.remove('fa-moon'); icon.classList.add('fa-sun'); } }); }
        function toggleTheme() { const currentTheme = body.classList.contains('desert-mode') ? 'desert' : 'night'; const newTheme = currentTheme === 'desert' ? 'night' : 'desert'; applyTheme(newTheme); localStorage.setItem('preferredTheme', newTheme); }
        function initializeTheme() { const savedTheme = localStorage.getItem('preferredTheme'); if (savedTheme) { applyTheme(savedTheme); } else { applyTheme('night'); } }
        themeToggleButtons.forEach(button => button.addEventListener('click', toggleTheme));
        initializeTheme();

        // START: Bottom Navigation Bar Logic
        // Ø¨Ø¯Ø§ÙŠØ©: Ù…Ù†Ø·Ù‚ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ
        function setupInteractiveNav(navElement) {
            const blob = navElement.querySelector('.nav-blob');
            const buttons = navElement.querySelectorAll('.nav-btn');

            function moveBlob(targetButton) {
                if (!targetButton) return;
                const navRect = navElement.getBoundingClientRect();
                const targetRect = targetButton.getBoundingClientRect();
                
                const left = targetRect.left - navRect.left;
                const width = targetRect.width;

                blob.style.setProperty('--blob-left', `${left}px`);
                blob.style.setProperty('--blob-width', `${width}px`);
            }

            buttons.forEach(button => {
                button.addEventListener('click', () => {
                    buttons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    moveBlob(button);
                });
            });

            // Set initial position
            const initialActive = navElement.querySelector('.nav-btn.active');
            if (initialActive) {
                // Use a small timeout to ensure the element is rendered and has dimensions
                setTimeout(() => moveBlob(initialActive), 100);
            }
        }
        // END: Bottom Navigation Bar Logic

        function initTeacherApp() {
            const allSections = teacherPortal.querySelectorAll('section'), dashboardSection = teacherPortal.querySelector('#teacher-dashboard-section'), loginSection = teacherPortal.querySelector('#teacher-login-section'), registerSection = teacherPortal.querySelector('#teacher-register-section');
            const menuIcon = teacherPortal.querySelector('#teacher-menu-icon'), dropdownMenu = teacherPortal.querySelector('#teacher-dropdown-menu');
            const settingsModal = teacherPortal.querySelector('#teacher-settings-modal');
            const teacherNameSpan = teacherPortal.querySelector("#teacher-name"), bottomNav = teacherPortal.querySelector('#teacher-bottom-nav'), myTestsContainer = teacherPortal.querySelector("#my-tests-container");
            const resultsTestSelector = teacherPortal.querySelector("#results-test-selector"), studentResultsContainer = teacherPortal.querySelector("#student-results-container");
            const createTestSection = teacherPortal.querySelector('#teacher-create-test-content'), testNameInput = teacherPortal.querySelector("#test-name"), testGradeSelect = teacherPortal.querySelector("#test-grade"), testDurationInput = teacherPortal.querySelector("#test-duration");
            const preventGoBackCheckbox = teacherPortal.querySelector("#prevent-go-back-checkbox"), shuffleQuestionsCheckbox = teacherPortal.querySelector('#shuffle-questions-checkbox'), fatefulTestCheckbox = document.getElementById('fateful-test-checkbox');
            const questionText = teacherPortal.querySelector("#question-text"), optionInputs = teacherPortal.querySelectorAll(".option-input"), correctAnswerInput = teacherPortal.querySelector("#correct-answer"), questionPointsInput = teacherPortal.querySelector("#question-points");
            const questionsListContainer = teacherPortal.querySelector("#questions-list-container"), questionImageInput = teacherPortal.querySelector("#question-image-input"), modelAnswerImageInput = teacherPortal.querySelector("#model-answer-image-input");
            const addQuestionBtn = teacherPortal.querySelector('#add-question-btn'), cancelQuestionEditBtn = teacherPortal.querySelector('#cancel-question-edit-btn'), saveTestBtn = teacherPortal.querySelector('#save-test-btn'), cancelTestEditBtn = teacherPortal.querySelector('#cancel-test-edit-btn');
            const reviewModal = teacherPortal.querySelector('#teacher-review-modal'), reviewModalBody = teacherPortal.querySelector('#review-modal-body'), reviewModalTitle = teacherPortal.querySelector('#review-modal-title'), reviewModalFooter = teacherPortal.querySelector('#review-modal-footer'), finalizeGradesBtn = teacherPortal.querySelector('#finalize-grades-btn');
            const updateNameInput = teacherPortal.querySelector('#teacher-update-name'), updatePasswordInput = teacherPortal.querySelector('#teacher-update-password'), updateBtn = teacherPortal.querySelector('#teacher-update-btn');
            const refreshBtn = teacherPortal.querySelector('#teacher-refresh-btn');
            let currentUser = null, myTests = {}, questionsArray = [], currentQuestionImageBase64 = null, currentModelAnswerImageBase64 = null, currentQuestionType = 'mcq', currentEditingTestId = null, currentEditingQuestionIndex = -1;
            const loggedInUser = localStorage.getItem('loggedInTeacher');
            if (loggedInUser) { currentUser = loggedInUser; showSection(dashboardSection); updateDashboard(); } else { showSection(loginSection); }
            function showSection(section) { allSections.forEach(s=>s.classList.add('hidden')); if(section) section.classList.remove('hidden'); bottomNav.classList.toggle('hidden', !section || section.id !== 'teacher-dashboard-section'); };
            const showLoadingSpinner = (container) => { container.innerHTML = `<div class="spinner"></div>`; };
            const navButtons = teacherPortal.querySelectorAll('.nav-btn');
            navButtons.forEach(button => { button.addEventListener('click', () => { teacherPortal.querySelectorAll('.tab-content').forEach(c=>c.classList.add('hidden')); teacherPortal.querySelector(`#${button.dataset.target}`).classList.remove('hidden'); if(button.dataset.target === 'teacher-create-test-content' && !currentEditingTestId) resetCreateFormState(); }); });
            const setDefaultTab = () => navButtons[0].click();
            teacherPortal.querySelectorAll('.switch-button').forEach(btn => btn.addEventListener('click', () => { teacherPortal.querySelectorAll('.switch-button').forEach(b => { b.classList.remove('active'); b.style.background = 'var(--border-secondary)'; }); btn.classList.add('active'); btn.style.background = 'var(--accent-primary)'; currentQuestionType = btn.dataset.type; teacherPortal.querySelector("#mcq-fields").classList.toggle('hidden', currentQuestionType !== 'mcq'); teacherPortal.querySelector("#essay-fields").classList.toggle('hidden', currentQuestionType !== 'essay'); }));
            const clearQuestionForm = () => { questionText.value=""; questionImageInput.value=""; modelAnswerImageInput.value=""; currentQuestionImageBase64=null; currentModelAnswerImageBase64=null; teacherPortal.querySelectorAll('.image-preview-container').forEach(c=>c.classList.add('hidden')); teacherPortal.querySelectorAll('.image-preview').forEach(i=>i.src='#'); optionInputs.forEach(i=>i.value=""); correctAnswerInput.value=""; questionPointsInput.value = ""; currentEditingQuestionIndex = -1; addQuestionBtn.textContent = 'Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©'; cancelQuestionEditBtn.classList.add('hidden'); };
            async function updateDashboard() { if(!currentUser) return; teacherNameSpan.textContent = currentUser; menuIcon.classList.remove('hidden'); setupInteractiveNav(bottomNav); setDefaultTab(); showLoadingSpinner(myTestsContainer); const testsRef = ref(db, `tests/${currentUser}`); onValue(testsRef, (snapshot) => { myTests = snapshot.exists() ? snapshot.val() : {}; renderMyTests(); populateResultsSelector(); }); initChatSystem(currentUser, 'teacher'); }
            refreshBtn.onclick = updateDashboard;
            function renderMyTests() { myTestsContainer.innerHTML = ""; if (countdownInterval) clearInterval(countdownInterval); const activeTests = Object.entries(myTests).filter(([id, test]) => (Date.now() - test.timestamp < 48 * 60 * 60 * 1000)); if (activeTests.length === 0) { myTestsContainer.innerHTML = "<p>Ù„Ù… ØªÙ‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙŠ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù†Ø´Ø·Ø©.</p>"; return; } activeTests.sort((a,b) => b[1].timestamp - a[1].timestamp).forEach(([testId, test]) => { const testCard = document.createElement('div'); testCard.className = 'list-item'; testCard.style.cssText = `flex-direction: column; align-items: stretch; padding: 12px; gap: 10px;`; testCard.innerHTML = ` <div style="font-weight: bold; font-size: 1.1rem; text-align: right;">${test.name}</div> <div style="font-size: 0.9rem; color: var(--text-secondary); text-align: right;">${test.grade} - ${test.duration} Ø¯Ù‚ÙŠÙ‚Ø©</div> <div class="test-countdown" data-timestamp="${test.timestamp}"></div> <div style="display: flex; gap: 8px; margin-top: 10px;"> <button class="action-btn btn-secondary" data-action="share" title="Ù…Ø´Ø§Ø±ÙƒØ©" style="flex-grow: 1;"><i class="fas fa-share-alt"></i></button> <button class="action-btn btn-secondary" data-action="results" title="Ø§Ù„Ù†ØªØ§Ø¦Ø¬" style="flex-grow: 1;"><i class="fas fa-poll-h"></i></button> <button class="action-btn btn-secondary" data-action="edit" title="ØªØ¹Ø¯ÙŠÙ„" style="flex-grow: 1;"><i class="fas fa-edit"></i></button> <button class="action-btn btn-secondary btn-danger" data-action="delete" title="Ø­Ø°Ù" style="flex-grow: 1;"><i class="fas fa-trash"></i></button> </div> `; testCard.querySelector('[data-action="share"]').onclick = () => copyTestLink(currentUser, testId); testCard.querySelector('[data-action="results"]').onclick = () => { navButtons[1].click(); resultsTestSelector.value = testId; loadStudentResultsForTest(testId); }; testCard.querySelector('[data-action="edit"]').onclick = () => startEditingTest(testId, test); testCard.querySelector('[data-action="delete"]').onclick = async () => { if (await showCustomConfirm("ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù", "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡.")) deleteTest(testId); }; myTestsContainer.appendChild(testCard); }); startCountdownTimers(); }
            function startCountdownTimers(){ const update = () => { document.querySelectorAll('.test-countdown').forEach(el => { const timestamp = parseInt(el.dataset.timestamp); const endTime = timestamp + 48 * 60 * 60 * 1000; const remaining = endTime - Date.now(); if(remaining > 0){ const hours = Math.floor(remaining / (1000 * 60 * 60)); const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60)); el.textContent = `ÙŠÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„: ${hours} Ø³ Ùˆ ${minutes} Ø¯`; } else { el.textContent = "Ø§Ù†ØªÙ‡Ù‰"; el.parentElement.style.opacity = '0.5'; } }); }; update(); countdownInterval = setInterval(update, 60000); }
            async function deleteTest(testId) { try { await remove(ref(db, `tests/${currentUser}/${testId}`)); await remove(ref(db, `results/${currentUser}/${testId}`)); showCustomAlert("Ù†Ø¬Ø§Ø­", "ØªÙ… Ø­Ø°Ù Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­."); } catch (e) { showCustomAlert("Ø®Ø·Ø£", "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±."); } }
            function startEditingTest(testId, testData) { navButtons[2].click(); currentEditingTestId = testId; createTestSection.querySelector('#create-edit-title').textContent = "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±"; saveTestBtn.textContent = "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±"; cancelTestEditBtn.classList.remove('hidden'); testNameInput.value = testData.name; testGradeSelect.value = testData.grade; testDurationInput.value = testData.duration; preventGoBackCheckbox.checked = !!testData.preventGoBack; shuffleQuestionsCheckbox.checked = !!testData.shuffle; fatefulTestCheckbox.checked = !!testData.fateful; questionsArray = [...(testData.questions || [])]; renderQuestionsList(); }
            function resetCreateFormState() { currentEditingTestId = null; createTestSection.querySelector('#create-edit-title').textContent = "Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯"; saveTestBtn.textContent = "Ø­ÙØ¸ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±"; cancelTestEditBtn.classList.add('hidden'); testNameInput.value = ""; testGradeSelect.value = ""; testDurationInput.value = ""; preventGoBackCheckbox.checked=false; shuffleQuestionsCheckbox.checked=false; fatefulTestCheckbox.checked=false; questionsArray = []; renderQuestionsList(); clearQuestionForm(); }
            cancelTestEditBtn.onclick = resetCreateFormState;
            async function loadStudentResultsForTest(testId) { if (!testId) { studentResultsContainer.innerHTML = ""; return; } showLoadingSpinner(studentResultsContainer); const snapshot = await get(ref(db, `results/${currentUser}/${testId}`)); studentResultsContainer.innerHTML = ""; if (!snapshot.exists()) { studentResultsContainer.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø¹Ø¯.</p>"; return; } Object.entries(snapshot.val()).forEach(([studentName, result]) => { const div = document.createElement('div'); div.className = 'list-item'; const pendingIndicator = result.status === 'pending' ? `<span style="color:var(--warning-primary); font-weight:bold; margin-inline:10px;">(Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©)</span>` : ''; div.innerHTML = `<span style="flex-grow:1; text-align: right;">Ø§Ù„Ø·Ø§Ù„Ø¨: <strong>${studentName}</strong></span><span>Ø§Ù„Ø¯Ø±Ø¬Ø©: <strong>${result.score}</strong></span>${pendingIndicator}<i class="fas fa-comment-dots" title="Ù…Ø±Ø§Ø³Ù„Ø© Ø§Ù„Ø·Ø§Ù„Ø¨" style="margin: 0 15px; color: var(--accent-secondary); cursor: pointer; font-size: 1.2rem;"></i><button class="action-btn btn-secondary" data-action="details">Ø§Ù„ØªÙØ§ØµÙŠÙ„</button>`; div.querySelector('[data-action="details"]').onclick = () => showStudentAnswerReview(studentName, testId, result); div.querySelector('.fa-comment-dots').onclick = () => openChatModal(currentUser, studentName); studentResultsContainer.appendChild(div); }); }
            function showStudentAnswerReview(studentName, testId, result) { const test = myTests[testId], answers = result.answers; reviewModalTitle.textContent = `Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¥Ø¬Ø§Ø¨Ø§Øª: ${studentName}`; reviewModalBody.innerHTML = ''; reviewModalFooter.classList.add('hidden'); if (result.status === 'pending' && test.questions.some(q => q.type === 'essay')) reviewModalFooter.classList.remove('hidden'); test.questions.forEach((q, index) => { const studentAnswer = answers[index] || {}; let reviewHtml = ''; if (q.type === 'mcq') { const isCorrect = studentAnswer.answer === q.correct; reviewHtml = `<div style="background: ${isCorrect ? 'rgba(35, 134, 54, 0.2)' : 'rgba(218, 54, 51, 0.2)'}; padding: 10px; border-radius: 8px;"><b>Ø¥Ø¬Ø§Ø¨ØªÙ‡:</b> ${studentAnswer.answer ? q.options[studentAnswer.answer - 1] : '<i>Ù„Ù… ÙŠØ¬Ø¨</i>'}<br><b>Ø§Ù„ØµØ­ÙŠØ­Ø©:</b> ${q.options[q.correct - 1]}</div>`; } else { const studentText = studentAnswer.textAnswer || '<em>Ù„Ù… ÙŠÙ‚Ø¯Ù… Ø¥Ø¬Ø§Ø¨Ø© Ù†ØµÙŠØ©.</em>', studentImage = studentAnswer.imageAnswer ? `<p><b>ØµÙˆØ±ØªÙ‡:</b></p><img src="${studentAnswer.imageAnswer}" style="max-width:80%; border-radius:8px; cursor:pointer;">` : '', modelImage = q.modelAnswerImage ? `<p><b>Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©:</b></p><img src="${q.modelAnswerImage}" style="max-width:80%; border-radius:8px; cursor:pointer;">` : ''; let gradingInput = (result.status === 'pending') ? `<div style="margin-top:15px; text-align: left; display:flex; align-items:center; gap:10px;"><label for="grade-q-${index}" style="margin:0;"><b>Ø¶Ø¹ Ø§Ù„Ø¯Ø±Ø¬Ø©:</b></label><input type="number" id="grade-q-${index}" data-question-index="${index}" class="essay-grade-input" min="0" max="${q.points || 1}" style="width:80px; margin:0;"><span>/ ${q.points || 1}</span></div>` : `<p><b>Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù„Ù„Ø³Ø¤Ø§Ù„:</b> ${studentAnswer.pointsAwarded || 0}/${q.points || 1}</p>`; reviewHtml = `<div><p><b>Ø¥Ø¬Ø§Ø¨ØªÙ‡ Ø§Ù„Ù†ØµÙŠØ©:</b></p><div style="background:var(--border-secondary); padding:10px; border-radius:8px; white-space: pre-wrap;">${studentText}</div>${studentImage}${modelImage}${gradingInput}</div>`; } const qDiv = document.createElement('div'); qDiv.className = 'list-item'; qDiv.style.cssText = 'flex-direction: column; align-items: flex-start;'; qDiv.innerHTML = `<h4 style="margin-bottom:10px;">Ø³ ${index+1} (${q.points || 1} Ø¯Ø±Ø¬Ø§Øª): ${q.question}</h4>${q.image ? `<img class="question-image-preview" src="${q.image}">` : ''}${reviewHtml}`; reviewModalBody.appendChild(qDiv); }); finalizeGradesBtn.onclick = () => finalizeGrades(studentName, testId, test, result); reviewModal.classList.add('visible'); }
            async function finalizeGrades(studentName, testId, test, originalResult) { let totalEssayScore = 0, allGraded = true; const updatedAnswers = [...originalResult.answers]; reviewModalBody.querySelectorAll('.essay-grade-input').forEach(input => { const questionIndex = parseInt(input.dataset.questionIndex), points = parseInt(input.value), maxPoints = test.questions[questionIndex].points || 1; if (isNaN(points) || points < 0 || points > maxPoints) { showCustomAlert("Ø®Ø·Ø£", `Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¯Ø±Ø¬Ø© ØµØ­ÙŠØ­Ø© Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…Ù‚Ø§Ù„ÙŠ Ø±Ù‚Ù… ${questionIndex + 1}.`); allGraded = false; return; } totalEssayScore += points; updatedAnswers[questionIndex] = {...(updatedAnswers[questionIndex] || {type: 'essay'}), pointsAwarded: points}; }); if (!allGraded) return; const finalScore = originalResult.mcqScore + totalEssayScore, totalTestPoints = test.questions.reduce((sum, q) => sum + (q.points || 1), 0); const finalResult = { ...originalResult, score: `${finalScore} / ${totalTestPoints}`, status: 'graded', answers: updatedAnswers }; try { await update(ref(db), { [`results/${currentUser}/${testId}/${studentName}`]: finalResult, [`studentResults/${studentName}/${testId}`]: finalResult }); showCustomAlert("Ù†Ø¬Ø§Ø­", "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø¨Ù†Ø¬Ø§Ø­."); reviewModal.classList.remove('visible'); loadStudentResultsForTest(testId); } catch (e) { showCustomAlert("Ø®Ø·Ø£", "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª."); } }
            reviewModal.querySelector('.modal-close-btn').onclick = () => reviewModal.classList.remove('visible');
            const populateResultsSelector = () => { resultsTestSelector.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ø®ØªØ¨Ø§Ø±Ù‹Ø§</option>'; Object.entries(myTests).forEach(([testId, test]) => resultsTestSelector.innerHTML += `<option value="${testId}">${test.name}</option>`); };
            const handleImagePreview = (input, container, previewImg, storage) => { const f=input.files[0]; if(f) getBase64(f).then(d=>{ if(storage==='q') currentQuestionImageBase64=d; else currentModelAnswerImageBase64=d; previewImg.src=d; container.classList.remove('hidden'); }) };
            questionImageInput.onchange = () => handleImagePreview(questionImageInput, questionImageInput.nextElementSibling, questionImageInput.nextElementSibling.querySelector('img'), 'q');
            modelAnswerImageInput.onchange = () => handleImagePreview(modelAnswerImageInput, modelAnswerImageInput.nextElementSibling, modelAnswerImageInput.nextElementSibling.querySelector('img'), 'm');
            const renderQuestionsList = () => { questionsListContainer.innerHTML = questionsArray.length > 0 ? "<h3>Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ©:</h3>" : ""; questionsArray.forEach((q, i) => { const d=document.createElement('div'); d.className='list-item'; d.innerHTML=`<span style="flex-grow:1; text-align:right;">${i+1}. [${q.type==='mcq'?'Ø§Ø®ØªÙŠØ§Ø±ÙŠ':'Ù…Ù‚Ø§Ù„ÙŠ'}] ${q.question ? q.question.substring(0,30) : 'Ø³Ø¤Ø§Ù„ Ø¨ØµÙˆØ±Ø©'}... (${q.points} Ø¯Ø±Ø¬Ø§Øª)</span><div style="display:flex; gap: 5px;"><button data-index="${i}" class="action-btn btn-secondary edit-q-btn" title="ØªØ¹Ø¯ÙŠÙ„"><i class="fas fa-edit"></i></button><button data-index="${i}" class="action-btn btn-secondary btn-danger delete-q-btn" title="Ø­Ø°Ù"><i class="fas fa-trash"></i></button></div>`; questionsListContainer.appendChild(d); d.querySelector('.delete-q-btn').onclick = () => { questionsArray.splice(i,1); renderQuestionsList(); }; d.querySelector('.edit-q-btn').onclick = () => startEditingQuestion(i); }); };
            const startEditingQuestion = (index) => { const q = questionsArray[index]; if (!q) return; currentEditingQuestionIndex = index; questionText.value = q.question; questionPointsInput.value = q.points; addQuestionBtn.textContent = "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¤Ø§Ù„"; cancelQuestionEditBtn.classList.remove('hidden'); };
            cancelQuestionEditBtn.onclick = clearQuestionForm;
            addQuestionBtn.onclick = () => { const q = questionText.value.trim(), points = parseInt(questionPointsInput.value) || 1; if (!q && !currentQuestionImageBase64) { showCustomAlert("Ø®Ø·Ø£", "ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø£Ùˆ Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© Ù„Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„."); return; } let questionData = { question: q, type: currentQuestionType, image: currentQuestionImageBase64, points: points }; if (currentQuestionType === 'mcq') { const opts = Array.from(optionInputs).map(i => i.value.trim()), correct = parseInt(correctAnswerInput.value); if (opts.some(o => o === "") || !correct || correct < 1 || correct > 4) { showCustomAlert("Ø®Ø·Ø£", "ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£Ø±Ø¨Ø¹Ø© ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© (1-4)."); return; } questionData = { ...questionData, options: opts, correct }; } else { questionData.modelAnswerImage = currentModelAnswerImageBase64; } if (currentEditingQuestionIndex > -1) questionsArray[currentEditingQuestionIndex] = questionData; else questionsArray.push(questionData); renderQuestionsList(); clearQuestionForm(); };
            saveTestBtn.onclick = async (e) => { const button = e.target, originalText = button.textContent; button.disabled = true; button.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸..."; const n=testNameInput.value.trim(),g=testGradeSelect.value,d=testDurationInput.value.trim(),p=preventGoBackCheckbox.checked, s=shuffleQuestionsCheckbox.checked, f=fatefulTestCheckbox.checked; if(!n||!g||!d||questionsArray.length===0){ showCustomAlert("Ø®Ø·Ø£", "ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„."); button.disabled = false; button.textContent = originalText; return; } const testData = { name:n, grade:g, duration:parseInt(d), preventGoBack:p, shuffle: s, fateful: f, questions:questionsArray, timestamp:Date.now() }; try { if (currentEditingTestId) await set(ref(db, `tests/${currentUser}/${currentEditingTestId}`), testData); else await push(ref(db, `tests/${currentUser}`), testData); showCustomAlert("Ù†Ø¬Ø§Ø­", `ØªÙ… ${currentEditingTestId ? 'ØªØ­Ø¯ÙŠØ«' : 'Ø­ÙØ¸'} Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­!`); resetCreateFormState(); setDefaultTab(); } catch(error) { showCustomAlert("Ø®Ø·Ø£", "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸."); } finally { button.disabled = false; button.textContent = originalText; } };
            async function authUser(name, password, isRegister) { if (!name || !password) { showCustomAlert("Ø®Ø·Ø£", "Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„"); return; } if (!/^[a-zA-Z0-9\s]+$/.test(name)) { showCustomAlert("Ø®Ø·Ø£", "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø­Ø±ÙˆÙ ÙˆØ§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ø§Ø³Ù…."); return; } const userRef = ref(db, `users/${name}`); const snapshot = await get(userRef); if (isRegister) { if (snapshot.exists()) { showCustomAlert("Ø®Ø·Ø£", "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„."); return; } await set(userRef, { password }); currentUser = name; } else { if (!snapshot.exists() || snapshot.val().password !== password) { showCustomAlert("Ø®Ø·Ø£", "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©."); return; } currentUser = name; } localStorage.setItem("loggedInTeacher", currentUser); showSection(dashboardSection); updateDashboard(); }
            teacherPortal.querySelector('#teacher-login-btn').onclick = () => authUser(teacherPortal.querySelector("#teacher-login-name").value.trim(), teacherPortal.querySelector("#teacher-login-password").value.trim(), false);
            teacherPortal.querySelector('#teacher-register-btn').onclick = () => authUser(teacherPortal.querySelector("#teacher-register-name").value.trim(), teacherPortal.querySelector("#teacher-register-password").value.trim(), true);
            menuIcon.addEventListener('click', () => dropdownMenu.classList.toggle('show'));
            document.addEventListener('click', (e) => { if (!menuIcon.contains(e.target) && !dropdownMenu.contains(e.target) && !e.target.closest('.theme-toggle-btn')) dropdownMenu.classList.remove('show'); });
            dropdownMenu.querySelector('#teacher-settings-btn').onclick = () => { dropdownMenu.classList.remove('show'); updateNameInput.value = currentUser; updatePasswordInput.value = ''; settingsModal.classList.add('visible'); };
            dropdownMenu.querySelector('#teacher-logout-btn').onclick = async () => { dropdownMenu.classList.remove('show'); if (await showCustomConfirm("ØªØ£ÙƒÙŠØ¯", "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) { localStorage.clear(); sessionStorage.clear(); window.location.href = window.location.pathname; } };
            dropdownMenu.querySelector('#teacher-chat-btn').onclick = () => { dropdownMenu.classList.remove('show'); openChatList(teacherChatListModal, document.getElementById('teacher-chat-list-body'), 'teacher'); };
            dropdownMenu.querySelector('#teacher-share-platform-btn').onclick = () => { dropdownMenu.classList.remove('show'); sharePlatform(); };
            settingsModal.querySelector('.modal-close-btn').onclick = () => settingsModal.classList.remove('visible');
            resultsTestSelector.onchange = (e) => loadStudentResultsForTest(e.target.value);
            teacherPortal.querySelectorAll('.to-login').forEach(el=>el.onclick=e=>{e.preventDefault();showSection(loginSection)});
            teacherPortal.querySelectorAll('.to-register').forEach(el=>el.onclick=e=>{e.preventDefault();showSection(registerSection)});
            updateBtn.onclick = async () => { const newName = updateNameInput.value.trim(), newPassword = updatePasswordInput.value.trim(); if (!newName) { showCustomAlert("Ø®Ø·Ø£", "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø§Ø³Ù… ÙØ§Ø±ØºÙ‹Ø§."); return; } if (!/^[a-zA-Z0-9\s]+$/.test(newName)) { showCustomAlert("Ø®Ø·Ø£", "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø­Ø±ÙˆÙ ÙˆØ§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ø§Ø³Ù…."); return; } if (newName === currentUser && !newPassword) { settingsModal.classList.remove('visible'); return; } try { const updates = {}; if(newPassword) updates.password = newPassword; if (newName !== currentUser) { if ((await get(ref(db, `users/${newName}`))).exists()) { showCustomAlert("Ø®Ø·Ø£", "Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„."); return; } const oldData = (await get(ref(db, `users/${currentUser}`))).val(); const dataToMove = { [`users/${newName}`]: { ...oldData, ...updates }, [`users/${currentUser}`]: null }; for (const path of ['tests', 'results', 'messageLimits']) { const snap = await get(ref(db, `${path}/${currentUser}`)); if (snap.exists()) { dataToMove[`${path}/${newName}`] = snap.val(); dataToMove[`${path}/${currentUser}`] = null; } } await update(ref(db), dataToMove); localStorage.setItem('loggedInTeacher', newName); showCustomAlert("Ù†Ø¬Ø§Ø­", "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©."); setTimeout(() => window.location.href = window.location.pathname, 1500); } else { await update(ref(db, `users/${currentUser}`), updates); showCustomAlert("Ù†Ø¬Ø§Ø­", "ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­!"); settingsModal.classList.remove('visible'); } } catch (e) { showCustomAlert("Ø®Ø·Ø£", "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø³Ø§Ø¨."); } };
        }

        function initStudentApp() {
            const allSections=studentPortal.querySelectorAll('section'),[registerSection,loginSection,dashboard,takeTest,result,review]=allSections, nameSpan=studentPortal.querySelector('#student-name');
            const menuIcon = studentPortal.querySelector('#student-menu-icon'), dropdownMenu = studentPortal.querySelector('#student-dropdown-menu');
            const settingsModal = studentPortal.querySelector('#student-settings-modal');
            const testsContainer=studentPortal.querySelector('#available-tests-container'), resultsContainer=studentPortal.querySelector('#my-student-results-container'), searchBar=studentPortal.querySelector('#search-bar');
            const timerDisplay=studentPortal.querySelector('#timer'), timerProgress=studentPortal.querySelector('#timer-progress'), testTitle=studentPortal.querySelector('#current-test-title'), questionsDisplay=studentPortal.querySelector('#questions-display');
            const finalScore=studentPortal.querySelector('#final-score'), feedbackMsg=studentPortal.querySelector('#feedback-message'), bottomNav=studentPortal.querySelector('#student-bottom-nav');
            const qNavContainer=studentPortal.querySelector('#question-navigation-container'), [prevQBtn,nextQBtn]=[studentPortal.querySelector('#prev-question-btn'),studentPortal.querySelector('#next-question-btn')], submitBtn=studentPortal.querySelector('#submit-test-btn');
            const reviewContainer=studentPortal.querySelector('#review-container'), updateNameInput = studentPortal.querySelector('#student-update-name'), updatePasswordInput = studentPortal.querySelector('#student-update-password'), updateBtn = studentPortal.querySelector('#student-update-btn');
            const showSearchBtn = studentPortal.querySelector('#show-search-btn');
            const refreshBtn = studentPortal.querySelector('#refresh-tests-btn');
            const backToDashboardBtn = studentPortal.querySelector('#back-to-dashboard-btn');
            const backFromReviewBtn = studentPortal.querySelector('#back-to-dashboard-from-review-btn');
            let currentStudent=null,takenTests={},allTests={},currentTest=null,testInterval=null,totalSec=0,remainSec=0,answers=[], qIndex=0, isDeepLinkSession = false;
            const loggedInUser = localStorage.getItem('loggedInStudent');
            if(loggedInUser){ currentStudent = loggedInUser; const deepLink=sessionStorage.getItem('deepLinkTest'); if(deepLink){ startDeepLinkTest(); } else { showSection(dashboard); loadDashboard(); } } else { showSection(loginSection); }
            function showSection(s){allSections.forEach(e=>e.classList.add('hidden'));if(s) s.classList.remove('hidden');bottomNav.classList.toggle('hidden',!s || s.id!=='student-dashboard-section' || isDeepLinkSession)};
            const showLoading=c=>{c.innerHTML='<div class="spinner"></div>'};
            async function loadDashboard(){if(!currentStudent)return;nameSpan.textContent=currentStudent;menuIcon.classList.remove('hidden'); setupInteractiveNav(bottomNav); setDefaultTab();showLoading(testsContainer);showLoading(resultsContainer);const resultsSnap=await get(ref(db,`studentResults/${currentStudent}`));takenTests=resultsSnap.exists()?resultsSnap.val():{};renderStudentResults();const testsRef=ref(db,'tests');onValue(testsRef,snap=>{allTests=snap.exists()?snap.val():{};renderAvailableTests()}); initChatSystem(currentStudent, 'student');}
            refreshBtn.onclick = loadDashboard;
            function renderAvailableTests(filter=''){ testsContainer.innerHTML=''; let found=false; const testEntries = []; Object.entries(allTests).forEach(([teacherId, teacherTests]) => { Object.entries(teacherTests) .filter(([testId, test]) => (Date.now() - test.timestamp < 48 * 60 * 60 * 1000)) .forEach(([testId, test]) => { testEntries.push({ teacherId, testId, test }); }); }); testEntries.sort((a, b) => b.test.timestamp - a.test.timestamp); testEntries.forEach(({teacherId, testId, test}) => { const isTaken = !!takenTests[testId]; const searchStr = `${test.name}${test.grade}${teacherId}`.toLowerCase(); if(filter && !searchStr.includes(filter.toLowerCase())) return; found = true; const itemContainer = document.createElement('div'); itemContainer.className = 'student-test-item-container'; const actionsBar = document.createElement('div'); actionsBar.className = 'student-test-actions-bar'; const startOrReviewIcon = document.createElement('div'); startOrReviewIcon.className = 'action-icon'; startOrReviewIcon.innerHTML = isTaken ? `<i class="fas fa-poll-h"></i>` : `<i class="fas fa-play"></i>`; startOrReviewIcon.title = isTaken ? 'Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø©' : 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±'; startOrReviewIcon.onclick = () => isTaken ? openStudentReview(testId) : startTest(teacherId, testId, test, false); const retakeIcon = document.createElement('div'); retakeIcon.className = 'action-icon'; retakeIcon.innerHTML = `<i class="fas fa-redo"></i>`; retakeIcon.title = 'Ø¥Ø¹Ø§Ø¯Ø© (ØªØ¯Ø±ÙŠØ¨)'; retakeIcon.style.display = isTaken ? 'flex' : 'none'; retakeIcon.onclick = () => startTest(teacherId, testId, test, true); const teacherIcon = document.createElement('div'); teacherIcon.className = 'action-icon'; teacherIcon.innerHTML = `<i class="fas fa-chalkboard-teacher"></i>`; teacherIcon.title = `Ù…Ø±Ø§Ø³Ù„Ø© ${teacherId}`; teacherIcon.onclick = (e) => { e.stopPropagation(); openChatModal(currentStudent, teacherId); }; const shareIcon = document.createElement('div'); shareIcon.className = 'action-icon'; shareIcon.innerHTML = `<i class="fas fa-share-alt"></i>`; shareIcon.title = 'Ù…Ø´Ø§Ø±ÙƒØ© Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±'; shareIcon.onclick = (e) => { e.stopPropagation(); copyTestLink(teacherId, testId); }; actionsBar.append(startOrReviewIcon, retakeIcon, teacherIcon, shareIcon); const card = document.createElement('div'); card.className = 'student-test-card'; const expiryTime = new Date(test.timestamp + 48 * 60 * 60 * 1000); const formattedExpiry = `ÙŠÙ†ØªÙ‡ÙŠ: ${expiryTime.toLocaleDateString('ar-EG')} ${expiryTime.toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit'})}`; card.innerHTML = ` <div class="test-main-info"> <span class="test-grade-badge">${test.grade || 'Ø¹Ø§Ù…'}</span> <div class="test-name" title="${test.name}">${test.name}</div> </div> <div class="test-expiry">${formattedExpiry}</div>`; itemContainer.append(actionsBar, card); testsContainer.appendChild(itemContainer); }); if(!found) testsContainer.innerHTML='<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§.</p>'; }
            function renderStudentResults(){resultsContainer.innerHTML='';const results=Object.values(takenTests).sort((a,b)=>b.timestamp-a.timestamp);if(results.length===0){resultsContainer.innerHTML='<p>Ù„Ù… ØªÙ‚Ù… Ø¨Ø¥Ø¬Ø±Ø§Ø¡ Ø£ÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø¹Ø¯.</p>';return}results.forEach(r=>{const d=new Date(r.timestamp).toLocaleString('ar-EG'), pendingIndicator = r.status === 'pending' ? `<span style="color:var(--warning-primary); font-weight:bold; font-size: 0.8rem;">(Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©)</span>` : '';const div=document.createElement('div');div.className='test-item';div.innerHTML=`<div style="text-align:right; flex-grow:1;"><strong>${r.testName}</strong><br><small>Ø§Ù„Ø¯Ø±Ø¬Ø©: <strong>${r.score}</strong> ${pendingIndicator}</small></div><small>${d}</small>`;resultsContainer.appendChild(div)})}
            function startTest(teacherId, testId, testData, isPractice = false) { if (isDeepLinkSession) { bottomNav.classList.add('hidden'); studentPortal.querySelector('.header-icons').classList.add('hidden'); } if (!testData.questions || testData.questions.length === 0) { showCustomAlert("Ø®Ø·Ø£", "Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„Ø© ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø¨Ø¯Ø¤Ù‡."); return; } currentTest = { ...testData, id: testId, teacherId, isPractice }; if (currentTest.shuffle) currentTest.questions.sort(() => Math.random() - 0.5); testTitle.textContent = testData.name + (isPractice ? ' (ÙˆØ¶Ø¹ Ø§Ù„ØªØ¯Ø±ÙŠØ¨)' : ''); totalSec = currentTest.duration * 60; remainSec = totalSec; answers = new Array(currentTest.questions.length).fill(null); qIndex = 0; timerDisplay.textContent = formatTime(remainSec); timerProgress.style.width = '100%'; if (testInterval) clearInterval(testInterval); testInterval = setInterval(() => { remainSec--; timerDisplay.textContent = formatTime(remainSec); timerProgress.style.width = ((remainSec / totalSec) * 100) + '%'; if (remainSec <= 0) { clearInterval(testInterval); submitTest(true) } }, 1000); if (currentTest.preventGoBack) { submitBtn.classList.add('hidden'); qNavContainer.classList.remove('hidden'); renderQuestion(qIndex) } else { submitBtn.classList.remove('hidden'); qNavContainer.classList.add('hidden'); renderAllQuestions() } showSection(takeTest) }
            async function openStudentReview(testId) { const result = takenTests[testId]; if (!result) return; const testRef = ref(db, `tests/${result.teacherName}/${testId}`), testSnap = await get(testRef); if (!testSnap.exists()) { showCustomAlert('Ø®Ø·Ø£', 'Ù„Ù… ÙŠØ¹Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…ØªØ§Ø­Ù‹Ø§ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©.'); return; } renderReview(testSnap.val(), result.answers); showSection(review); }
            function renderAllQuestions(){questionsDisplay.innerHTML='';currentTest.questions?.forEach((q,idx)=>{const qDiv=document.createElement('div');qDiv.style.marginBottom='25px';let ansHtml='';if(q.type==='mcq'){ansHtml=`<div class="question-options">${q.options.map((o,i)=>`<label><input type="radio" name="question-${idx}" value="${i+1}" onchange="saveAnswer(${idx},this.value,'mcq')"/><span>${o}</span></label>`).join('')}</div>`}else{ansHtml=`<div><label>Ø¥Ø¬Ø§Ø¨ØªÙƒ:</label><textarea id="text-answer-${idx}" oninput="saveAnswer(${idx}, this.value, 'essay-text')"></textarea><label for="image-answer-${idx}" class="file-input-label"><i class="fas fa-upload"></i> Ø±ÙØ¹ ØµÙˆØ±Ø©</label><input type="file" id="image-answer-${idx}" accept="image/*" class="hidden" onchange="handleEssayImageUpload(${idx}, this)"></div>`}qDiv.innerHTML=`<h4 style="text-align:right;margin-bottom:15px;">Ø³ ${idx+1}: ${q.question}</h4>${q.image?`<img class="question-image-preview" src="${q.image}">`:''}${ansHtml}`;questionsDisplay.appendChild(qDiv)})}
            function renderQuestion(index){const q=currentTest.questions[index];let ansHtml='';const saved=answers[index];if(q.type==='mcq'){ansHtml=`<div class="question-options">${q.options.map((o,i)=>{const checked=saved&&saved.answer===(i+1)?'checked':'';return`<label><input type="radio" name="question-${index}" value="${i+1}" ${checked}/><span>${o}</span></label>`}).join('')}</div>`}else{const text=saved&&saved.textAnswer?saved.textAnswer:'';const uploaded=saved&&saved.imageAnswer;ansHtml=`<div><label>Ø¥Ø¬Ø§Ø¨ØªÙƒ:</label><textarea id="text-answer-${index}">${text}</textarea><label for="image-answer-${index}" class="file-input-label"><i class="fas ${uploaded?'fa-check-circle':'fa-upload'}"></i> ${uploaded?'ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©':'Ø±ÙØ¹ ØµÙˆØ±Ø©'}</label><input type="file" id="image-answer-${index}" accept="image/*" class="hidden"></div>`}questionsDisplay.innerHTML=`<h4 style="margin-bottom:15px;">Ø³ ${index+1}/${currentTest.questions.length}: ${q.question}</h4>${q.image?`<img class="question-image-preview" src="${q.image}">`:''}${ansHtml}`;if(q.type==='essay'){document.getElementById(`image-answer-${index}`).onchange=()=>handleEssayImageUpload(index,document.getElementById(`image-answer-${index}`))}prevQBtn.disabled=index===0;nextQBtn.classList.toggle('hidden',index===currentTest.questions.length-1);submitBtn.classList.toggle('hidden',index!==currentTest.questions.length-1)}
            window.saveAnswer=(idx,val,type)=>{if(type==='mcq')answers[idx]={type:'mcq',answer:parseInt(val)};else if(type==='essay-text'){if(!answers[idx])answers[idx]={type:'essay'};answers[idx].textAnswer=val}};
            window.handleEssayImageUpload=async(idx,input)=>{const file=input.files[0];if(file){const b64=await getBase64(file);if(!answers[idx])answers[idx]={type:'essay'};answers[idx].imageAnswer=b64;input.previousElementSibling.innerHTML=`<i class="fas fa-check-circle"></i> ØªÙ… Ø§Ù„Ø±ÙØ¹!`}};
            function saveCurrentAnswer(){const q=currentTest.questions[qIndex];if(q.type==='mcq'){const c=questionsDisplay.querySelector(`input[name="question-${qIndex}"]:checked`);if(c)answers[qIndex]={type:'mcq',answer:parseInt(c.value)}}else{const t=questionsDisplay.querySelector(`#text-answer-${qIndex}`).value;if(t.trim()!==''||(answers[qIndex]&&answers[qIndex].imageAnswer)){if(!answers[qIndex])answers[qIndex]={type:'essay'};answers[qIndex].textAnswer=t}}}
            nextQBtn.onclick=()=>{if(qIndex<currentTest.questions.length-1){saveCurrentAnswer();qIndex++;renderQuestion(qIndex)}};
            prevQBtn.onclick=()=>{if(qIndex>0){saveCurrentAnswer();qIndex--;renderQuestion(qIndex)}};
            async function submitTest(timeUp=false){ clearInterval(testInterval); if(timeUp) showCustomAlert('Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª!','ØªÙ… ØªØ³Ù„ÙŠÙ… Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©.'); if(currentTest.preventGoBack) saveCurrentAnswer(); let mcqScore = 0, mcqTotalPoints = 0; const hasEssays = currentTest.questions.some(q => q.type === 'essay'), totalTestPoints = currentTest.questions.reduce((s, q) => s + (q.points || 1), 0); currentTest.questions.forEach((q, idx) => { if (q.type === 'mcq') { mcqTotalPoints += (q.points || 1); if (answers[idx] && answers[idx].answer === q.correct) mcqScore += (q.points || 1); } }); const scoreString = hasEssays ? `${mcqScore} / ${mcqTotalPoints} (Ù…Ø¨Ø¯Ø¦ÙŠ)` : `${mcqScore} / ${totalTestPoints}`; finalScore.textContent = `Ø¯Ø±Ø¬ØªÙƒ: ${scoreString}`; const promptShown = localStorage.getItem('appInstallPromptShown'); if (!currentTest.isPractice && !promptShown) { appInstallPrompt.classList.add('show'); localStorage.setItem('appInstallPromptShown', 'true'); } if(currentTest.isPractice){ feedbackMsg.style.cssText = "background: #17a2b8; color: #fff;"; feedbackMsg.textContent = "Ù‡Ø°Ù‡ Ù†ØªÙŠØ¬Ø© ØªØ¯Ø±ÙŠØ¨Ùƒ. Ù„Ù† ÙŠØªÙ… Ø­ÙØ¸ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø±Ø¬Ø©."; } else { const resultObj = { testId: currentTest.id, testName: currentTest.name, teacherName: currentTest.teacherId, timestamp: serverTimestamp(), answers: answers, mcqScore: mcqScore, totalPoints: totalTestPoints, status: hasEssays ? 'pending' : 'graded', score: scoreString }; await set(ref(db, `studentResults/${currentStudent}/${currentTest.id}`), resultObj); await set(ref(db, `results/${currentTest.teacherId}/${currentTest.id}/${currentStudent}`), resultObj); takenTests[currentTest.id] = resultObj; if (hasEssays) { feedbackMsg.style.cssText = "background: rgba(255, 193, 7, 0.2); color: var(--warning-primary);"; feedbackMsg.textContent = "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ Ø§Ù„Ù…Ù‚Ø§Ù„ÙŠØ© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©! Ù‡Ø°Ù‡ Ù†ØªÙŠØ¬ØªÙƒ Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠØ©."; } else { const percentage = totalTestPoints > 0 ? (mcqScore / totalTestPoints) * 100 : 0; feedbackMsg.style.background = 'var(--bg-tertiary)'; feedbackMsg.style.color = 'var(--text-primary)'; feedbackMsg.style.textAlign = 'center'; if (percentage < 60) { feedbackMsg.innerHTML = ` <p style="margin-bottom: 10px;">ÙŠØ§ Ù„Ù‡ÙˆÙŠ Ø§Ø¹Ù…Ù„ Ø§ÙŠÙ‡ Ù…Ø¹Ø§Ùƒ ØªØ§Ù†ÙŠ Ø¨Ù‚Ù‰... Ø­Ø§ÙˆÙ„ ØªØ­Ø³Ù† Ù…Ù† Ù†ÙØ³Ùƒ Ø´ÙˆÙŠÙ‡</p> <img src="https://i.postimg.cc/HntKF5f2/download-13.png" style="max-width: 150px; border-radius: 8px;"> `; } else { feedbackMsg.innerHTML = ` <p style="margin-bottom: 10px;">Ù…Ø´ Ø¨Ø·Ø§Ù„ ÙŠÙ„Ø§ Ù…Ø§Ø´ÙŠ</p> <img src="https://i.postimg.cc/2862CPvY/download-12.png" style="max-width: 150px; border-radius: 8px;"> `; } } } if (isDeepLinkSession) { backToDashboardBtn.textContent = 'Ø§Ù„Ø®Ø±ÙˆØ¬'; backFromReviewBtn.textContent = 'Ø§Ù„Ø®Ø±ÙˆØ¬'; } else { backToDashboardBtn.textContent = 'Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©'; backFromReviewBtn.textContent = 'Ø§Ù„Ø¹ÙˆØ¯Ø©'; } showSection(result); }
            submitBtn.onclick=async ()=>{ if (await showCustomConfirm('ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…', 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±ØŸ')) { submitTest(false); } };
            const handleExitTestSession = () => { if (isDeepLinkSession) { localStorage.removeItem('loggedInStudent'); sessionStorage.clear(); window.location.href = window.location.pathname; } else { showSection(dashboard); loadDashboard(); } };
            function renderReview(testData, studentAnswers){ reviewContainer.innerHTML = ''; testData.questions.forEach((q,i) => { const ans = studentAnswers[i] || {}; let html=''; if (q.type === 'mcq') { const isCorrect = ans.answer === q.correct; html=`<div style="background:${isCorrect ? 'rgba(35, 134, 54, 0.2)' : 'rgba(218, 54, 51, 0.2)'}; padding:10px; border-radius:8px;"> <b>Ø¥Ø¬Ø§Ø¨ØªÙƒ:</b> ${ans.answer ? q.options[ans.answer-1] : '<i>Ù„Ù… ØªØ¬Ø¨</i>'}<br> <b>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©:</b> ${q.options[q.correct-1]} </div>`; } else { const txt = ans.textAnswer || '<em>Ù„Ù… ØªÙ‚Ø¯Ù… Ø¥Ø¬Ø§Ø¨Ø© Ù†ØµÙŠØ©.</em>'; const img = ans.imageAnswer ? `<p><b>ØµÙˆØ±ØªÙƒ:</b></p><img src="${ans.imageAnswer}" style="max-width:80%;border-radius:8px; cursor:pointer;">` : ''; const model = q.modelAnswerImage ? `<p><b>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©:</b></p><img src="${q.modelAnswerImage}" style="max-width:80%;border-radius:8px; cursor:pointer;">` : ''; html=`<div><p><b>Ø¥Ø¬Ø§Ø¨ØªÙƒ Ø§Ù„Ù†ØµÙŠØ©:</b></p><div style="background:var(--border-secondary);padding:10px;border-radius:8px; white-space:pre-wrap;">${txt}</div>${img}${model}</div>`; } const qDiv = document.createElement('div'); qDiv.className = 'list-item'; qDiv.style.cssText = 'flex-direction: column; align-items: flex-start;'; qDiv.innerHTML = `<h4 style="margin-bottom:10px;">Ø³ ${i+1}: ${q.question}</h4>${q.image ? `<img class="question-image-preview" src="${q.image}">` : ''}${html}`; reviewContainer.appendChild(qDiv); }); }
            async function authUser(name,pass,isRegister){ if(!name||!pass) { showCustomAlert('Ø®Ø·Ø£','Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„'); return; } if (!/^[a-zA-Z0-9\s]+$/.test(name)) { showCustomAlert("Ø®Ø·Ø£", "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø­Ø±ÙˆÙ ÙˆØ§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ø§Ø³Ù…."); return; } const userRef=ref(db,`students/${name}`); const snap=await get(userRef); if(isRegister){ if(snap.exists()) { showCustomAlert('Ø®Ø·Ø£','Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯.'); return; } await set(userRef,{password:pass}); currentStudent = name; } else { if(!snap.exists()||snap.val().password!==pass) { showCustomAlert('Ø®Ø·Ø£','Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.'); return; } currentStudent=name; } localStorage.setItem('loggedInStudent',currentStudent); if(sessionStorage.getItem('deepLinkTest')){await startDeepLinkTest()}else{showSection(dashboard);loadDashboard()} }
            async function startDeepLinkTest(){ isDeepLinkSession = true; const dataJSON=sessionStorage.getItem('deepLinkTest'); if(!dataJSON)return; const{teacherId,testId}=JSON.parse(dataJSON); sessionStorage.removeItem('deepLinkTest'); const testRef=ref(db,`tests/${teacherId}/${testId}`); const testSnap=await get(testRef); if(testSnap.exists()){ startTest(teacherId,testId,testSnap.val(), false) }else{ showCustomAlert('Ø®Ø·Ø£','Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ Ù„Ù… ÙŠØ¹Ø¯ Ù…ØªØ§Ø­Ù‹Ø§.'); handleExitTestSession(); } }
            const formatTime=s=>{const m=Math.floor(s/60),r=s%60;return`${m.toString().padStart(2,'0')}:${r.toString().padStart(2,'0')}`};
            const navButtons=studentPortal.querySelectorAll('.nav-btn');navButtons.forEach(b=>{b.addEventListener('click',()=>{ studentPortal.querySelectorAll('.tab-content').forEach(c=>c.classList.add('hidden'));studentPortal.querySelector(`#${b.dataset.target}`).classList.remove('hidden')})});
            const setDefaultTab=()=>navButtons[0].click();
            studentPortal.querySelector('#student-register-btn').onclick=()=>authUser(studentPortal.querySelector('#student-register-name').value.trim(),studentPortal.querySelector('#student-register-password').value.trim(),true);
            studentPortal.querySelector('#student-login-btn').onclick=()=>authUser(studentPortal.querySelector('#student-login-name').value.trim(),studentPortal.querySelector('#student-login-password').value.trim(),false);
            studentPortal.querySelectorAll('.to-login').forEach(el=>el.onclick=e=>{e.preventDefault();showSection(loginSection)});
            studentPortal.querySelectorAll('.to-register').forEach(el=>el.onclick=e=>{e.preventDefault();showSection(registerSection)});
            backToDashboardBtn.onclick = handleExitTestSession;
            studentPortal.querySelector('#cancel-test-btn').onclick= async ()=>{ if(await showCustomConfirm('ØªØ£ÙƒÙŠØ¯', 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±ØŸ Ù„Ù† ÙŠØªÙ… Ø­ÙØ¸ ØªÙ‚Ø¯Ù…Ùƒ.')){ clearInterval(testInterval); handleExitTestSession(); } };
            studentPortal.querySelector('#review-answers-btn').onclick = () => { if (currentTest.isPractice) { renderReview(currentTest, answers); showSection(review); } else { openStudentReview(currentTest.id); } };
            backFromReviewBtn.onclick = handleExitTestSession;
            showSearchBtn.addEventListener('click', () => { searchBar.classList.toggle('hidden'); if (!searchBar.classList.contains('hidden')) { searchBar.focus(); } else { renderAvailableTests(''); searchBar.value = ''; } });
            searchBar.addEventListener('input',e=>renderAvailableTests(e.target.value));
            menuIcon.addEventListener('click', () => dropdownMenu.classList.toggle('show'));
            document.addEventListener('click', (e) => { if (!menuIcon.contains(e.target) && !dropdownMenu.contains(e.target) && !e.target.closest('.theme-toggle-btn')) dropdownMenu.classList.remove('show'); });
            dropdownMenu.querySelector('#student-settings-btn').onclick = () => { dropdownMenu.classList.remove('show'); updateNameInput.value = currentStudent; updatePasswordInput.value = ''; settingsModal.classList.add('visible'); };
            dropdownMenu.querySelector('#student-logout-btn').onclick = async () => { dropdownMenu.classList.remove('show'); if (await showCustomConfirm("ØªØ£ÙƒÙŠØ¯", "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) { localStorage.clear(); sessionStorage.clear(); window.location.href = window.location.pathname; } };
            dropdownMenu.querySelector('#student-chat-btn').onclick = () => { dropdownMenu.classList.remove('show'); openChatList(studentChatListModal, document.getElementById('student-chat-list-body'), 'student'); };
            dropdownMenu.querySelector('#student-share-platform-btn').onclick = () => { dropdownMenu.classList.remove('show'); sharePlatform(); };
            settingsModal.querySelector('.modal-close-btn').onclick = () => settingsModal.classList.remove('visible');
            updateBtn.onclick = async () => { const newName = updateNameInput.value.trim(), newPassword = updatePasswordInput.value.trim(); if (!newName) { showCustomAlert("Ø®Ø·Ø£", "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø§Ø³Ù… ÙØ§Ø±ØºÙ‹Ø§."); return; } if (!/^[a-zA-Z0-9\s]+$/.test(newName)) { showCustomAlert("Ø®Ø·Ø£", "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø­Ø±ÙˆÙ ÙˆØ§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ø§Ø³Ù…."); return; } if (newName === currentStudent && !newPassword) { settingsModal.classList.remove('visible'); return; } try { const updates = {}; if(newPassword) updates.password = newPassword; if (newName !== currentStudent) { if ((await get(ref(db, `students/${newName}`))).exists()) { showCustomAlert("Ø®Ø·Ø£", "Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„."); return; } const oldData = (await get(ref(db, `students/${currentStudent}`))).val(); const dataToMove = { [`students/${newName}`]: { ...oldData, ...updates }, [`students/${currentStudent}`]: null }; for (const path of ['studentResults', 'messageLimits']) { const snap = await get(ref(db, `${path}/${currentStudent}`)); if (snap.exists()) { dataToMove[`${path}/${newName}`] = snap.val(); dataToMove[`${path}/${currentStudent}`] = null; } } await update(ref(db), dataToMove); localStorage.setItem('loggedInStudent', newName); showCustomAlert("Ù†Ø¬Ø§Ø­", "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©."); setTimeout(() => window.location.href = window.location.pathname, 1500); } else { await update(ref(db, `students/${currentStudent}`), updates); showCustomAlert("Ù†Ø¬Ø§Ø­", "ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­!"); settingsModal.classList.remove('visible'); } } catch (e) { showCustomAlert("Ø®Ø·Ø£", "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø³Ø§Ø¨."); console.error(e) } };
        }

        function copyTestLink(teacherId, testId) { const link = `${window.location.origin}${window.location.pathname}#test/${encodeURIComponent(teacherId)}/${encodeURIComponent(testId)}`; navigator.clipboard.writeText(link).then(() => { showCustomAlert('ØªÙ… Ø§Ù„Ù†Ø³Ø®', 'ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­!'); }); }
        
        const imageViewerModal = document.getElementById('image-viewer-modal');
        const imageWrapper = document.getElementById('image-viewer-content-wrapper');
        const modalImage = imageViewerModal.querySelector('.image-modal-content');
        const modalDownloadBtn = imageViewerModal.querySelector('.image-modal-download-btn');
        let scale = 1, panning = false, start = { x: 0, y: 0 }, transform = { x: 0, y: 0 };
        let initialDistance = null, lastTap = 0;
        function setTransform() { modalImage.style.transform = `translate(${transform.x}px, ${transform.y}px) scale(${scale})`; }
        function resetZoom() { scale = 1; transform = { x: 0, y: 0 }; modalImage.style.transition = 'transform 0.2s ease-out'; setTransform(); setTimeout(() => modalImage.style.transition = 'none', 200); }
        function getDistance(p1, p2) { return Math.sqrt(Math.pow(p2.clientX - p1.clientX, 2) + Math.pow(p2.clientY - p1.clientY, 2)); }
        function openImageViewer(src) { if (!src || src.endsWith('#')) return; resetZoom(); modalImage.src = src; modalDownloadBtn.href = src; imageViewerModal.classList.add('visible'); }
        function closeImageViewer() { imageViewerModal.classList.remove('visible'); setTimeout(() => { modalImage.src = ''; resetZoom(); }, 300); }
        imageWrapper.addEventListener('wheel', (e) => { e.preventDefault(); const rect = imageWrapper.getBoundingClientRect(); const xs = (e.clientX - rect.left - transform.x) / scale; const ys = (e.clientY - rect.top - transform.y) / scale; const delta = -e.deltaY; const newScale = delta > 0 ? scale * 1.2 : scale / 1.2; const clampedScale = Math.min(Math.max(1, newScale), 10); transform.x -= xs * (clampedScale - scale); transform.y -= ys * (clampedScale - scale); scale = clampedScale; if (scale === 1) transform = { x: 0, y: 0 }; modalImage.style.transition = 'none'; setTransform(); }, { passive: false });
        imageWrapper.addEventListener('pointerdown', (e) => { const pointers = e.touches || [e]; if (pointers.length === 1) { e.preventDefault(); start = { x: pointers[0].clientX - transform.x, y: pointers[0].clientY - transform.y }; panning = true; imageWrapper.style.cursor = 'grabbing'; modalImage.style.transition = 'none'; } if (pointers.length === 2) { panning = false; initialDistance = getDistance(pointers[0], pointers[1]); } });
        imageWrapper.addEventListener('pointerup', (e) => { panning = false; imageWrapper.style.cursor = 'grab'; initialDistance = null; });
        imageWrapper.addEventListener('pointerleave', () => { panning = false; imageWrapper.style.cursor = 'grab'; initialDistance = null; });
        imageWrapper.addEventListener('pointermove', (e) => { const pointers = e.touches || [e]; if (panning && pointers.length === 1) { e.preventDefault(); transform.x = pointers[0].clientX - start.x; transform.y = pointers[0].clientY - start.y; setTransform(); } if (pointers.length === 2 && initialDistance) { e.preventDefault(); const newDist = getDistance(pointers[0], pointers[1]); const scaleMultiplier = newDist / initialDistance; const newScale = Math.min(Math.max(1, scale * scaleMultiplier), 10); const rect = imageWrapper.getBoundingClientRect(); const pinchCenterX = (pointers[0].clientX + pointers[1].clientX) / 2; const pinchCenterY = (pointers[0].clientY + pointers[1].clientY) / 2; const xs = (pinchCenterX - rect.left - transform.x) / scale; const ys = (pinchCenterY - rect.top - transform.y) / scale; transform.x -= xs * (newScale - scale); transform.y -= ys * (newScale - scale); scale = newScale; initialDistance = newDist; modalImage.style.transition = 'none'; setTransform(); } });
        imageWrapper.addEventListener('dblclick', (e) => { e.preventDefault(); modalImage.style.transition = 'transform 0.3s ease-out'; if (scale > 1) { resetZoom(); } else { const rect = imageWrapper.getBoundingClientRect(); const xs = (e.clientX - rect.left - transform.x) / scale; const ys = (e.clientY - rect.top - transform.y) / scale; scale = 3; transform.x -= xs * (scale - 1); transform.y -= ys * (scale - 1); setTransform(); } });
        imageWrapper.addEventListener('touchend', (e) => { const currentTime = new Date().getTime(); if (currentTime - lastTap < 300) { e.preventDefault(); modalImage.style.transition = 'transform 0.3s ease-out'; if (scale > 1) { resetZoom(); } else { const rect = imageWrapper.getBoundingClientRect(); const touch = e.changedTouches[0]; const xs = (touch.clientX - rect.left - transform.x) / scale; const ys = (touch.clientY - rect.top - transform.y) / scale; scale = 3; transform.x -= xs * (scale - 1); transform.y -= ys * (scale - 1); setTransform(); } } lastTap = currentTime; });
        document.addEventListener('click', (e) => { if (e.target.tagName === 'IMG' && e.target.closest('.portal-container, .modal-content')) { if (e.target.src && e.target.src.startsWith('data:image')) { e.preventDefault(); openImageViewer(e.target.src); } } });
        imageViewerModal.querySelector('.modal-close-btn').addEventListener('click', closeImageViewer);
        imageViewerModal.addEventListener('click', (e) => { if (e.target === imageViewerModal) closeImageViewer(); });
        
        const textChatModal = document.getElementById('text-chat-modal'), chatModalTitle = document.getElementById('chat-modal-title'), chatModalBody = document.getElementById('chat-modal-body'), messageInput = document.getElementById('chat-message-input');
        const sendMessageBtn = document.getElementById('send-chat-message-btn'), speechBtn = document.getElementById('speech-to-text-btn');
        const teacherChatListModal = document.getElementById('teacher-chat-list-modal'), studentChatListModal = document.getElementById('student-chat-list-modal');
        let currentUserId, currentUserType, recognition, activeChatPartnerId = null, chatMessagesListener = null;
        function initChatSystem(userId, userType) { currentUserId = userId; currentUserType = userType; initSpeechRecognition(); const badge = document.querySelector(`#${userType}-portal .notification-badge`); listenForUnreadMessages(userId, badge); if (userType === 'teacher') { teacherChatListModal.querySelector('.modal-close-btn').onclick = () => teacherChatListModal.classList.remove('visible'); } else { studentChatListModal.querySelector('.modal-close-btn').onclick = () => studentChatListModal.classList.remove('visible'); } }
        function listenForUnreadMessages(userId, badgeElement) { const chatsRef = query(ref(db, 'chats'), orderByChild(`participants/${userId}`), equalTo(true)); onValue(chatsRef, (snapshot) => { let hasUnread = false; if (snapshot.exists()) { snapshot.forEach(chatSnap => { const metadata = chatSnap.val().metadata; if (metadata && metadata.hasUnread && metadata.hasUnread[userId]) { hasUnread = true; } }); } badgeElement.style.display = hasUnread ? 'block' : 'none'; }); }
        async function openChatList(modal, listBody, userType) { modal.classList.add('visible'); listBody.innerHTML = '<div class="spinner"></div>'; const chatsRef = query(ref(db, 'chats'), orderByChild(`participants/${currentUserId}`), equalTo(true)); const snapshot = await get(chatsRef); if (!snapshot.exists()) { listBody.innerHTML = `<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†. ${userType === 'student' ? 'ÙŠÙ…ÙƒÙ†Ùƒ Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª.' : ''}</p>`; return; } listBody.innerHTML = ''; snapshot.forEach(chatSnap => { const partnerId = Object.keys(chatSnap.val().participants).find(p => p !== currentUserId); if (partnerId) { const listItem = document.createElement('div'); listItem.className = 'list-item chat-list-item'; listItem.textContent = partnerId; listItem.onclick = () => { modal.classList.remove('visible'); openChatModal(currentUserId, partnerId); }; listBody.appendChild(listItem); } }); }
        function initSpeechRecognition() { const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition; if(!SpeechRecognition) { speechBtn.style.display = 'none'; return; } recognition = new SpeechRecognition(); recognition.continuous = false; recognition.lang = 'ar-EG'; recognition.interimResults = false; recognition.onresult = (event) => { messageInput.value += event.results[0][0].transcript; }; recognition.onend = () => speechBtn.classList.remove('listening'); recognition.onerror = (event) => { speechBtn.classList.remove('listening'); console.error(event.error); }; }
        speechBtn.onclick = () => { if (recognition) { if (speechBtn.classList.contains('listening')) { recognition.stop(); } else { recognition.start(); speechBtn.classList.add('listening'); } } };
        async function openChatModal(userId, partnerId) { if (chatMessagesListener) off(chatMessagesListener); activeChatPartnerId = partnerId; chatModalTitle.textContent = `Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ ${partnerId}`; chatModalBody.innerHTML = ''; messageInput.value = ''; textChatModal.classList.add('visible'); if(currentUserType === 'student') await checkMessageLimit(userId); else { document.getElementById('message-limit-text').textContent = ''; sendMessageBtn.disabled = false; messageInput.disabled = false; } const chatId = [userId, partnerId].sort().join('_'); const metadataRef = ref(db, `chats/${chatId}/metadata/hasUnread/${userId}`); await set(metadataRef, null); const messagesRef = query(ref(db, `chats/${chatId}/messages`), orderByChild('timestamp')); chatMessagesListener = onValue(messagesRef, (snapshot) => { chatModalBody.innerHTML = ''; if (snapshot.exists()) { const now = Date.now(); const expiryPeriod = 48 * 60 * 60 * 1000; let messageFound = false; snapshot.forEach(child => { const msg = child.val(); if (now - msg.timestamp < expiryPeriod) { messageFound = true; const msgDiv = document.createElement('div'); msgDiv.className = `chat-message ${msg.sender === currentUserId ? 'sent' : 'received'}`; const time = new Date(msg.timestamp).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }); msgDiv.innerHTML = `<span>${msg.text}</span><span class="msg-time">${time}</span>`; chatModalBody.appendChild(msgDiv); } }); if(messageFound) { chatModalBody.scrollTop = chatModalBody.scrollHeight; } else { chatModalBody.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø­Ø¯ÙŠØ«Ø©. Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©!</p>'; } } else { chatModalBody.innerHTML = '<p>Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©!</p>'; } }); }
        async function checkMessageLimit(userId) { const limitRef = ref(db, `messageLimits/${userId}`), snapshot = await get(limitRef), now = Date.now(), limitPeriod = 48 * 60 * 60 * 1000; let recentMessages = 0; const updates = {}; if (snapshot.exists()) { snapshot.forEach(child => { if (now - child.val() < limitPeriod) recentMessages++; else updates[child.key] = null; }); if(Object.keys(updates).length > 0) update(limitRef, updates); } const remaining = 3 - recentMessages, canSend = remaining > 0, limitText = document.getElementById('message-limit-text'); limitText.textContent = canSend ? `Ù„Ø¯ÙŠÙƒ ${remaining} Ø±Ø³Ø§Ø¦Ù„ Ù…ØªØ¨Ù‚ÙŠØ©.` : "Ù„Ù‚Ø¯ ÙˆØµÙ„Øª Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ (3 ÙƒÙ„ 48 Ø³Ø§Ø¹Ø©)."; sendMessageBtn.disabled = !canSend; messageInput.disabled = !canSend; return canSend; }
        sendMessageBtn.onclick = async () => { const text = messageInput.value.trim(); if (text === '' || !activeChatPartnerId) return; if (currentUserType === 'student' && !(await checkMessageLimit(currentUserId))) { showCustomAlert("Ø®Ø·Ø£", "Ù„Ù‚Ø¯ ØªØ¬Ø§ÙˆØ²Øª Ø­Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡."); return; } const chatId = [currentUserId, activeChatPartnerId].sort().join('_'); const messageData = { sender: currentUserId, text: text, timestamp: serverTimestamp() }; const chatRef = ref(db, `chats/${chatId}`); try { await push(ref(db, `chats/${chatId}/messages`), messageData); const updates = {}; updates[`participants/${currentUserId}`] = true; updates[`participants/${activeChatPartnerId}`] = true; updates[`metadata/hasUnread/${activeChatPartnerId}`] = true; updates[`metadata/lastSender`] = currentUserId; await update(chatRef, updates); if(currentUserType === 'student'){ await push(ref(db, `messageLimits/${currentUserId}`), serverTimestamp()); await checkMessageLimit(currentUserId); } messageInput.value = ''; messageInput.focus(); } catch (e) { showCustomAlert("Ø®Ø·Ø£", "Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©."); console.error(e); } };
        textChatModal.querySelector('.modal-close-btn').onclick = () => { textChatModal.classList.remove('visible'); activeChatPartnerId = null; if (chatMessagesListener) off(chatMessagesListener, 'value'); };

        const handleInitialLoad = () => {
            // START: Overlapping Text JS Logic
            // Ø¨Ø¯Ø§ÙŠØ©: Ù…Ù†Ø·Ù‚ Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª Ù„ØªØ£Ø«ÙŠØ± Ø§Ù„Ù†Øµ Ø§Ù„Ù…ØªØ¯Ø§Ø®Ù„
            document.querySelectorAll(".overlap-title").forEach(el => {
                el.innerHTML = [...el.innerText].map((char, i) => `<span style="--i:${i}">${char === ' ' ? '&nbsp;' : char}</span>`).join("");
            });
            // END: Overlapping Text JS Logic

            const savedTeacher = localStorage.getItem('loggedInTeacher'); const savedStudent = localStorage.getItem('loggedInStudent');
            mainLandingPage.classList.add('hidden'); teacherPortal.classList.add('hidden'); studentPortal.classList.add('hidden');
            if(window.location.hash.startsWith('#test/')){ const parts = window.location.hash.split('/'); if(parts.length === 3) { sessionStorage.setItem('deepLinkTest',JSON.stringify({teacherId:decodeURIComponent(parts[1]),testId:decodeURIComponent(parts[2])})); history.pushState("", document.title, window.location.pathname + window.location.search); } studentPortal.classList.remove('hidden'); initStudentApp(); return; }
            if (savedTeacher) { teacherPortal.classList.remove('hidden'); initTeacherApp(); } 
            else if (savedStudent) { studentPortal.classList.remove('hidden'); initStudentApp(); } 
            else { mainLandingPage.classList.remove('hidden'); }
        };

        handleInitialLoad();

        const sloganWidget = document.getElementById('slogan-widget');
        if (sloganWidget) { sloganWidget.addEventListener('click', () => { const sloganImage = sloganWidget.querySelector('img'); if (sloganImage && sloganImage.src) { openImageViewer(sloganImage.src); } }); }

    </script>

    <!-- Screenshot Prevention Script -->
    <script>
        document.addEventListener('contextmenu', event => event.preventDefault());
        document.addEventListener('keydown', function(e) { if (e.key === 'PrintScreen' || (e.ctrlKey && e.shiftKey && e.key === 'I') || (e.ctrlKey && e.shiftKey && e.key === 'C') || e.key === 'F12' || (e.ctrlKey && e.key === 'U')) { e.preventDefault(); } });
    </script>

    <!-- Background Shader Logic -->
    <script>
    (function() {
        class Renderer {
            #vertexSrc = "#version 300 es\nprecision highp float;\nin vec4 position;\nvoid main(){gl_Position=position;}"
            #fragmtSrc = "#version 300 es\nprecision highp float;\nout vec4 O;\nuniform float time;\nuniform vec2 resolution;\nvoid main() {\n\tvec2 uv=gl_FragCoord.xy/resolution;\n\tO=vec4(uv,sin(time)*.5+.5,1);\n}"
            #vertices = [-1, 1, -1, -1, 1, 1, 1, -1]
            constructor(canvas, scale) {
                this.canvas = canvas
                this.scale = scale
                this.gl = canvas.getContext("webgl2", { antialias: false, powerPreference: "high-performance" });
                this.gl.viewport(0, 0, canvas.width, canvas.height)
                this.shaderSource = this.#fragmtSrc
                this.mouseMove = [0, 0]
                this.mouseCoords = [0, 0]
                this.pointerCoords = [0, 0]
                this.nbrOfPointers = 0
            }
            get defaultSource() { return this.#fragmtSrc }
            updateShader(source) {
                this.reset()
                this.shaderSource = source
                this.setup()
                this.init()
            }
            updateMove(deltas) { this.mouseMove = deltas }
            updateMouse(coords) { this.mouseCoords = coords }
            updatePointerCoords(coords) { this.pointerCoords = coords }
            updatePointerCount(nbr) { this.nbrOfPointers = nbr }
            updateScale(scale) {
                this.scale = scale;
                this.gl.viewport(0, 0, this.canvas.width, this.canvas.height);
            }
            compile(shader, source) {
                const gl = this.gl
                gl.shaderSource(shader, source)
                gl.compileShader(shader)
                if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
                    console.error(gl.getShaderInfoLog(shader))
                    this.canvas.dispatchEvent(new CustomEvent('shader-error', { detail: gl.getShaderInfoLog(shader) }))
                }
            }
            test(source) {
                let result = null
                const gl = this.gl
                const shader = gl.createShader(gl.FRAGMENT_SHADER)
                gl.shaderSource(shader, source)
                gl.compileShader(shader)
                if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) { result = gl.getShaderInfoLog(shader) }
                if(gl.getShaderParameter(shader, gl.DELETE_STATUS)) { gl.deleteShader(shader); }
                return result
            }
            reset() {
                const { gl, program, vs, fs } = this
                if (!program || gl.getProgramParameter(program, gl.DELETE_STATUS)) return
                if (gl.getShaderParameter(vs, gl.DELETE_STATUS)) {
                    gl.detachShader(program, vs)
                    gl.deleteShader(vs)
                }
                if (gl.getShaderParameter(fs, gl.DELETE_STATUS)) {
                    gl.detachShader(program, fs)
                    gl.deleteShader(fs)
                }
                gl.deleteProgram(program)
            }
            createCubeMap() {
                const { gl } = this
                const cubeMap = gl.createTexture()
                gl.bindTexture(gl.TEXTURE_CUBE_MAP, cubeMap)
                const imgpath = 'https://assets.codepen.io/4386748'
                const faces = [
                    [gl.TEXTURE_CUBE_MAP_POSITIVE_X, '01posx.jpg'],
                    [gl.TEXTURE_CUBE_MAP_NEGATIVE_X, '01negx.jpg'],
                    [gl.TEXTURE_CUBE_MAP_POSITIVE_Y, '01posy.jpg'],
                    [gl.TEXTURE_CUBE_MAP_NEGATIVE_Y, '01negy.jpg'],
                    [gl.TEXTURE_CUBE_MAP_POSITIVE_Z, '01posz.jpg'],
                    [gl.TEXTURE_CUBE_MAP_NEGATIVE_Z, '01negz.jpg'],
                ]
                for (let [target, url] of faces) {
                    const level = 0, internalFormat = gl.RGBA, width = 512, height = 512, format = gl.RGBA, type = gl.UNSIGNED_BYTE;
                    gl.texImage2D(target, level, internalFormat, width, height, 0, format, type, null)
                    const image = new Image()
                    image.crossOrigin = 'anonymous'
                    image.onload = () => {
                        gl.bindTexture(gl.TEXTURE_CUBE_MAP, cubeMap)
                        gl.texImage2D(target, level, internalFormat, format, type, image)
                        gl.generateMipmap(gl.TEXTURE_CUBE_MAP);
                    }
                    image.src = `${imgpath}/${url}?width=512&height=512&format=auto`
                }
                 gl.texParameteri(gl.TEXTURE_CUBE_MAP, gl.TEXTURE_MIN_FILTER, gl.LINEAR_MIPMAP_LINEAR);
                 gl.texParameteri(gl.TEXTURE_CUBE_MAP, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
            }
            setup() {
                const gl = this.gl
                this.createCubeMap()
                this.vs = gl.createShader(gl.VERTEX_SHADER)
                this.fs = gl.createShader(gl.FRAGMENT_SHADER)
                this.compile(this.vs, this.#vertexSrc)
                this.compile(this.fs, this.shaderSource)
                this.program = gl.createProgram()
                gl.attachShader(this.program, this.vs)
                gl.attachShader(this.program, this.fs)
                gl.linkProgram(this.program)
                if (!gl.getProgramParameter(this.program, gl.LINK_STATUS)) {
                    console.error(gl.getProgramInfoLog(this.program))
                }
            }
            init() {
                const { gl, program } = this
                this.buffer = gl.createBuffer()
                gl.bindBuffer(gl.ARRAY_BUFFER, this.buffer)
                gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(this.#vertices), gl.STATIC_DRAW)
                const position = gl.getAttribLocation(program, "position")
                gl.enableVertexAttribArray(position)
                gl.vertexAttribPointer(position, 2, gl.FLOAT, false, 0, 0)
                program.resolution = gl.getUniformLocation(program, "resolution")
                program.time = gl.getUniformLocation(program, "time")
                program.move = gl.getUniformLocation(program, "move")
                program.touch = gl.getUniformLocation(program, "touch")
                program.pointerCount = gl.getUniformLocation(program, "pointerCount")
                program.pointers = gl.getUniformLocation(program, "pointers")
                program.cubeMap = gl.getUniformLocation(program, "cubeMap")
            }
            render(now = 0) {
                const { gl, program, buffer, canvas, mouseMove, mouseCoords, pointerCoords, nbrOfPointers } = this
                if (!program || gl.getProgramParameter(program, gl.DELETE_STATUS)) return
                gl.clearColor(0, 0, 0, 1)
                gl.clear(gl.COLOR_BUFFER_BIT)
                gl.useProgram(program)
                gl.bindBuffer(gl.ARRAY_BUFFER, buffer)
                gl.uniform2f(program.resolution, canvas.width, canvas.height)
                gl.uniform1f(program.time, now * 1e-3)
                gl.uniform2f(program.move, ...mouseMove)
                gl.uniform2f(program.touch, ...mouseCoords)
                gl.uniform1i(program.pointerCount, nbrOfPointers)
                gl.uniform2fv(program.pointers, pointerCoords)
                gl.uniform1i(program.cubeMap, 0)
                gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4)
            }
        }
        class PointerHandler {
            constructor(element, scale) {
                this.scale = scale
                this.active = false
                this.pointers = new Map()
                this.lastCoords = [0, 0]
                this.moves = [0, 0]
                const map = (element, scale, x, y) => [x * scale, element.height - y * scale]
                element.addEventListener("pointerdown", (e) => {
                    this.active = true
                    this.pointers.set(e.pointerId, map(element, this.getScale(), e.clientX, e.clientY))
                })
                element.addEventListener("pointerup", (e) => {
                    if (this.count === 1) { this.lastCoords = this.first }
                    this.pointers.delete(e.pointerId)
                    this.active = this.pointers.size > 0
                })
                element.addEventListener("pointerleave", (e) => {
                    if (this.count === 1) { this.lastCoords = this.first }
                    this.pointers.delete(e.pointerId)
                    this.active = this.pointers.size > 0
                })
                element.addEventListener("pointermove", (e) => {
                    if (!this.active) return
                    this.lastCoords = [e.clientX, e.clientY]
                    this.pointers.set(e.pointerId, map(element, this.getScale(), e.clientX, e.clientY))
                    this.moves = [this.moves[0] + e.movementX, this.moves[1] + e.movementY]
                })
            }
            getScale() { return this.scale }
            updateScale(scale) { this.scale = scale }
            get count() { return this.pointers.size }
            get move() { return this.moves }
            get coords() { return this.pointers.size > 0 ? Array.from(this.pointers.values()).map((p) => [...p]).flat() : [0, 0] }
            get first() { return this.pointers.values().next().value || this.lastCoords }
        }

        let frm, renderer, pointers;
        const canvas = document.getElementById('canvas');
        const mainLandingPage = document.getElementById('main-landing-page');
        let resolution = 0.5;
        let dpr = Math.max(1, resolution * window.devicePixelRatio);

        function resize() {
            const { innerWidth: width, innerHeight: height } = window;
            canvas.width = width * dpr;
            canvas.height = height * dpr;
            if (renderer) {
                renderer.updateScale(dpr);
            }
        }

        function loop(now) {
            if (renderer) {
                renderer.updateMove(pointers.move);
                renderer.updateMouse(pointers.first);
                renderer.updatePointerCount(pointers.count);
                renderer.updatePointerCoords(pointers.coords);
                renderer.render(now);
            }
            frm = requestAnimationFrame(loop);
        }

        function init() {
            const source = document.querySelector("script[type='x-shader/x-fragment']");
            if (!source) {
                console.error("Shader source script not found!");
                return;
            }
            try {
                renderer = new Renderer(canvas, dpr);
                pointers = new PointerHandler(canvas, dpr);
                canvas.addEventListener('shader-error', e => console.error("Shader Error:", e.detail));
                renderer.setup();
                renderer.init();
                resize();
                if (renderer.test(source.textContent) === null) {
                    renderer.updateShader(source.textContent);
                } else {
                    console.error("Initial shader test failed.");
                }
                loop(0);
                window.onresize = resize;
            } catch(e) {
                console.error("Failed to initialize WebGL background:", e);
                canvas.style.display = 'none'; // Hide canvas if WebGL fails
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (!mainLandingPage.classList.contains('hidden')) {
                init();
            }
        });
    })();
    </script>
</body>
</html>
