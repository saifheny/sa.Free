<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>منصة الاختبارات الذكية 🚀</title>
    <!-- Meta Tags -->
    <meta property="og:title" content="منصة الاختبارات الذكية 🚀" />
    <meta property="og:description" content="بوابة التعلم الذكي التي تدمج التكنولوجيا بالتعليم!" />
    <meta property="og:image" content="https://i.postimg.cc/3RBYLnd3/818334fa-20ba-431a-ad38-6bec7ef02203.png" />
    <!-- PWA -->
    <link rel="manifest" href="./manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="الاختبارات الذكية">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/3RBYLnd3/818334fa-20ba-431a-ad38-6bec7ef02203.png">
    <meta name="theme-color" content="#0d1117">
    <!-- Fonts and Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- General & Base Styles --- */
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #010409;
            --border-primary: #30363d;
            --border-secondary: #21262d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --accent-primary: #2f81f7;
            --accent-primary-gradient: linear-gradient(180deg, #3081f7 0%, #1f6feb 100%);
            --accent-primary-border: #1158c7;
            --accent-secondary: #58a6ff;
            --success-color: #238636;
            --success-glow: rgba(35, 134, 54, 0.5);
            --success-bg: rgba(35, 134, 54, 0.2);
            --danger-color: #da3633;
            --danger-glow: rgba(218, 54, 51, 0.5);
            --danger-bg: rgba(218, 54, 51, 0.2);
            --success-gradient: linear-gradient(180deg, var(--success-color) 0%, #1a6328 100%);
            --success-border: #134b1f;
            --danger-primary: #da3633;
            --danger-border: #c82333;
            --warning-primary: #ffc107;
            --shadow-color-heavy: rgba(0,0,0,0.5);
            --shadow-color-light: rgba(0,0,0,0.4);
            --inset-shadow-light: rgba(255,255,255,0.05);
            --inset-shadow-dark: rgba(0,0,0,0.6);
            
            /* Variables for Glass Effect */
            --lg-bg-color: rgba(255, 255, 255, 0.2);
            --lg-highlight: rgba(255, 255, 255, 0.75);
            --lg-text: #ffffff;
        }

        .desert-mode {
            --bg-primary: #fdf6e3; /* Solarized Light Base */
            --bg-secondary: #f5eeda;
            --bg-tertiary: #eee8d5;
            --border-primary: #d3cbbd;
            --border-secondary: #e6e0d2;
            --text-primary: #2c2622; /* Very Dark Brown/Black */
            --text-secondary: #8a7a66;
            --accent-primary: #d2691e; /* Terracotta / Chocolate */
            --accent-primary-gradient: linear-gradient(180deg, #e67e22 0%, #d35400 100%);
            --accent-primary-border: #a84300;
            --accent-secondary: #d35400;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --success-gradient: linear-gradient(180deg, var(--success-color) 0%, #218838 100%);
            --success-border: #1e7e34;
            --danger-primary: #dc3545;
            --danger-border: #c82333;
            --warning-primary: #b58900; /* Solarized Yellow */
            --shadow-color-heavy: rgba(88, 76, 60, 0.3);
            --shadow-color-light: rgba(88, 76, 60, 0.2);
            --inset-shadow-light: rgba(0,0,0,0.05);
            --inset-shadow-dark: rgba(255,255,255,0.8);
        }
        
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            direction: rtl;
            text-align: center;
            overflow-x: hidden;
            transition: background-color 0.4s, color 0.4s;
            padding: 0 10px; /* Add side padding */
        }
        .hidden { display: none !important; }
        .no-select { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }

        /* --- Global 3D Effects --- */
        h1, h2, h3, h4, h5, h6 { text-shadow: 0 2px 4px var(--shadow-color-light); }
        .portal-container button {
            text-shadow: 0px 1px 2px var(--shadow-color-light);
            box-shadow: 0px 4px 8px var(--shadow-color-light), inset 0px -2px 1px var(--inset-shadow-light);
            transition: all 0.1s ease-in-out !important;
            transform: translateY(0);
        }
        .portal-container button:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0px 6px 12px var(--shadow-color-heavy), inset 0px -2px 1px var(--inset-shadow-light);
        }
        .portal-container button:not(:disabled):active {
            transform: translateY(1px);
            box-shadow: 0px 2px 4px var(--shadow-color-light), inset 0px 1px 1px var(--inset-shadow-dark);
        }
        input, select, textarea {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            color: var(--text-primary);
            border-radius: 8px;
            padding: 12px;
            width: 100%;
            margin-bottom: 15px;
            box-shadow: inset 0 2px 5px var(--inset-shadow-dark), 0 1px 0 var(--inset-shadow-light);
            transition: box-shadow 0.3s, border-color 0.3s, background-color 0.3s, color 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: inset 0 2px 5px var(--inset-shadow-dark), 0 0 10px var(--accent-primary);
        }
        .list-item, .test-item {
             background-color: var(--bg-secondary);
             border: 1px solid var(--border-primary);
             border-radius: 12px;
             padding: 15px;
             margin-bottom: 12px;
             display: flex;
             align-items: center;
             justify-content: space-between;
             box-shadow: 0 4px 10px var(--shadow-color-heavy), inset 0 1px 1px var(--inset-shadow-light);
             transition: transform 0.2s, box-shadow 0.2s, background-color 0.4s;
        }
        .list-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px var(--shadow-color-heavy);
        }
        .modal-content {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 15px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 40px var(--shadow-color-heavy), inset 0 2px 2px var(--inset-shadow-light);
            margin: auto; /* Center modal that is shorter than the viewport */
            position: relative;
        }

        /* --- Styling for Larger Question Images --- */
        .question-image-preview {
            width: 100%;
            max-height: 650px;
            border-radius: 12px;
            margin: 15px auto;
            display: block;
            cursor: pointer;
            object-fit: contain;
            border: 1px solid var(--border-primary);
            box-shadow: 0 4px 15px var(--shadow-color-heavy);
            transition: transform 0.2s ease;
        }
        .question-image-preview:hover { transform: scale(1.02); }
        
        /* --- NEW Landing Page Styles --- */
        @keyframes bg-move {
            from {
                transform: translateY(0%) scale(1);
            }
            to {
                transform: translateY(-5%) scale(1.05);
            }
        }

        #main-landing-page {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 40px 20px;
            gap: 40px;
            position: relative;
            overflow: hidden;
        }
        
        #main-landing-page::before {
            content: '';
            position: absolute;
            inset: -5%;
            background: url("https://images.unsplash.com/photo-1551384963-cccb0b7ed94b?q=80&w=3247&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D") center/cover;
            animation: bg-move 15s ease-in-out infinite alternate;
            z-index: -1;
        }

        #main-landing-page > * {
            position: relative;
            z-index: 1;
        }

        .landing-title {
            font-size: 2.8rem;
            font-weight: 800;
            padding: 0;
            margin: 0;
        }
        
        .glass-text-effect {
          background: linear-gradient(135deg, rgba(255,255,255,0.6), rgba(255,255,255,0.2));
          -webkit-background-clip: text;
          background-clip: text;
          color: transparent;
          text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
          filter: url(#lg-dist);
        }

        .role-selection {
            display: flex;
            gap: 25px;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* --- NEW Glass Effect Styles --- */
        .glass-container {
            position: relative;
            display: flex;
            font-weight: 800;
            color: var(--lg-text);
            cursor: pointer;
            background: transparent;
            border-radius: 2rem;
            overflow: hidden;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25), 0 0 20px rgba(0, 0, 0, 0.1);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.5); /* Adjusted bounce effect */
        }
        
        .glass-button:hover {
            transform: scale(1.05) translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        
        .glass-filter {
            position: absolute; inset: 0; z-index: 0;
            backdrop-filter: blur(8px);
            filter: url(#lg-dist);
            isolation: isolate;
        }
        
        .glass-overlay {
            position: absolute; inset: 0; z-index: 1;
            background: var(--lg-bg-color);
        }
        
        .glass-specular {
            position: absolute; inset: 0; z-index: 2;
            border-radius: inherit;
            overflow: hidden;
            box-shadow: inset 1px 1px 0 var(--lg-highlight), inset 0 0 5px rgba(255, 255, 255, 0.5);
        }
        
        .glass-content {
            position: relative; z-index: 3;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 1.5rem 2.5rem;
            font-size: 1.5rem;
        }
        
        .glass-content i {
            font-size: 1.8rem;
        }


        /* --- General Portal Styles --- */
        .portal-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg-primary); animation: fadeIn 0.6s ease-out; color: var(--text-primary);
            overflow-y: auto;
        }
        #teacher-portal.auth-view, #student-portal.auth-view {
            display: flex;
            align-items: center;
            justify-content: center;
            padding-top: 0;
        }
        .portal-content { 
            max-width: 800px; /* Increased max-width */
            margin: 0 auto; 
            padding: 120px 20px 40px 20px; /* Adjusted top padding for both headers */
        } 
        
        .portal-container .spinner { border: 4px solid var(--border-primary); border-top: 4px solid var(--accent-primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        .portal-container p { text-align: center; margin-top: 15px; font-size: 0.9rem; color: var(--text-secondary); }
        .portal-container p a { color: var(--accent-secondary); text-decoration: none; font-weight: 600; }
        .portal-container hr { border: none; border-top: 1px solid var(--border-primary); margin: 25px 0; }
        .portal-container button { width: 100%; padding: 14px 15px; border: none; border-radius: 12px; font-size: 1.1rem; font-family: 'Cairo', sans-serif; font-weight: 700; color: #fff; cursor: pointer; }
        .portal-container button:disabled { cursor: not-allowed; background: var(--border-secondary); border-bottom-color: var(--border-primary); opacity: 0.6; }
        .portal-container .btn-primary { background: var(--accent-primary-gradient); border-bottom: 4px solid var(--accent-primary-border); }
        .portal-container .btn-primary:not(:disabled):hover { border-bottom-width: 6px; }
        .portal-container .btn-primary:not(:disabled):active { border-bottom-width: 3px; }
        .portal-container .btn-secondary { background: var(--border-secondary); color: var(--text-primary); border-bottom: 4px solid var(--bg-tertiary); }
        .portal-container .btn-secondary:not(:disabled):hover { border-bottom-width: 6px; }
        .portal-container .btn-secondary:not(:disabled):active { border-bottom-width: 3px; }
        
       /* --- Top Navigation & Header Controls --- */
        .top-nav {
            position: fixed; top: 0; left: 0; right: 0;
            display: flex; justify-content: space-around; align-items: center;
            padding: 5px; 
            background: color-mix(in srgb, var(--bg-tertiary) 85%, transparent); 
            backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--border-primary); 
            box-shadow: 0 4px 20px 0 var(--shadow-color-heavy); 
            z-index: 1000;
            height: 65px;
        }
        .top-nav .nav-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 2px; padding: 6px 10px; background: transparent; border: none;
            color: var(--text-secondary); font-size: 0.75rem; font-weight: 600;
            cursor: pointer; transition: all 0.3s;
            flex: 1;
            position: relative;
        }
        .top-nav .nav-btn i { font-size: 1.5rem; margin-bottom: 2px; transition: all 0.3s; }
        .top-nav .nav-btn.active { color: var(--accent-secondary); }
        .top-nav .nav-btn.active::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 8px;
            background-color: var(--accent-secondary);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--accent-secondary);
        }
        .top-nav .nav-btn.active i {
             transform: scale(1.1);
             text-shadow: 0 0 15px var(--accent-primary);
        }
        .portal-header-controls {
            position: fixed; top: 65px; /* Positioned below top-nav */
            left: 0; right: 0;
            display: flex; justify-content: space-between; align-items: center; z-index: 999;
            background: color-mix(in srgb, var(--bg-primary) 90%, transparent);
            padding: 5px 15px;
            border-bottom: 1px solid var(--border-primary);
            height: 45px;
            margin-bottom: 10px;
        }
        .portal-content {
            padding-top: 120px; /* 65px (nav) + 45px (header) + 10px (margin) */
        }
        .portal-header-controls h1 {
            font-size: 0.9rem;
            margin: 0;
            text-align: center; /* Center the welcome message */
            flex-grow: 1;
            color: var(--text-secondary);
        }
        .portal-header-controls .header-icons {
             display: flex; gap: 8px;
        }
        .portal-header-controls .icon-btn {
            width: 32px; height: 32px; /* Smaller buttons */
            border-radius: 50%; background: transparent;
            border: 1px solid var(--border-primary); color: var(--text-secondary); display: flex; align-items: center;
            justify-content: center; cursor: pointer; font-size: 14px; /* Smaller icon */
            position: relative;
            transition: background-color 0.2s, color 0.2s;
        }
        .portal-header-controls .icon-btn:hover { background-color: var(--border-primary); color: var(--text-primary); }
        .portal-header-controls .icon-btn .notification-badge {
            position: absolute; top: -1px; right: -1px; width: 10px; height: 10px; background-color: var(--danger-primary);
            border-radius: 50%; border: 1.5px solid var(--bg-primary); display: none;
        }
        
        /* --- Modern Refresh/Search Buttons --- */
        .header-buttons .icon-btn { background-color: #000000; color: #ffffff;}
        .header-buttons .icon-btn:hover { background-color: #222222; }
        #refresh-tests-btn.loading i { animation: spin 1s linear infinite; }
        #show-search-btn i { transition: transform 0.3s ease; }
        #show-search-btn.active i { transform: rotate(90deg); color: var(--accent-secondary); }


        /* --- Header Dropdown Menu --- */
        .header-menu-container { position: relative; }
        .header-dropdown-menu {
            display: none; position: absolute; top: 40px; left: 0;
            background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 10px;
            box-shadow: 0 8px 20px var(--shadow-color-heavy); z-index: 1100;
            width: 200px; overflow: hidden;
        }
        .header-dropdown-menu.show { display: block; }
        .dropdown-item {
            display: flex; align-items: center; gap: 12px;
            padding: 12px 15px; color: var(--text-primary); text-decoration: none;
            font-size: 0.95rem; text-align: right; cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .dropdown-item:hover { background-color: var(--border-secondary); }
        .dropdown-item i { width: 20px; text-align: center; color: var(--accent-secondary); text-shadow: none; }
        
        /* --- Teacher Portal Specifics --- */
        #teacher-portal label { font-weight: 600; display: block; margin-bottom: 5px; text-align: right; }
        .file-input-label { background: var(--border-secondary); border: 2px dashed var(--border-primary); text-align: center; padding: 15px; border-radius: 10px; cursor: pointer; transition: border-color 0.3s, background-color 0.3s; }
        .file-input-label:hover { border-color: var(--accent-secondary); background-color: var(--border-primary); }
        .image-preview { max-width: 100px; max-height: 100px; border-radius: 8px; border: 1px solid #444; cursor: pointer; }
        .action-btn { padding: 6px 10px !important; font-size: 0.8rem !important; margin:0 !important; width: auto !important; display: flex; align-items: center; gap: 5px; }
        .test-countdown { font-size: 0.8rem; color: var(--warning-primary); font-weight: bold; margin-top: 5px; text-align: left; }
        .action-btn.btn-danger { background:var(--danger-primary); border-color:var(--danger-border); }
        #teacher-create-content .switch-button-container {
             display: flex; 
             border: 1px solid var(--border-primary); 
             border-radius: 12px; 
             overflow: hidden; 
             margin-bottom: 20px;
             padding: 5px;
             gap: 5px;
        }
        #mcq-fields .option-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        #mcq-fields .option-input {
            margin-bottom: 0;
            flex-grow: 1;
        }
        #mcq-fields .correct-answer-selector {
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.2s, transform 0.2s;
        }
        #mcq-fields .correct-answer-selector.selected {
            color: var(--success-color);
            transform: scale(1.2);
        }


        /* --- Student Portal --- */
        .student-test-item-container {
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px var(--shadow-color-heavy), inset 0 1px 1px var(--inset-shadow-light);
            border: 1px solid var(--border-primary);
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .student-test-item-container:hover {
            border-color: var(--accent-secondary);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px var(--accent-primary);
        }
        .student-test-actions-bar {
            display: flex;
            justify-content: space-around;
            background: var(--border-secondary);
            padding: 8px;
            border-bottom: 1px solid var(--border-primary);
        }
        .student-test-actions-bar .action-icon {
            background: var(--border-primary);
            color: var(--text-secondary);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px var(--shadow-color-heavy), inset 0 1px 1px var(--inset-shadow-light);
            font-size: 1.1rem;
        }
        .student-test-actions-bar .action-icon:hover {
            color: #fff;
            transform: translateY(-3px) scale(1.1);
            box-shadow: 0 4px 10px var(--shadow-color-heavy);
        }
        .action-icon[title="ابدأ الاختبار"]:hover { background-color: #238636; }
        .action-icon[title="مراجعة النتيجة"]:hover { background-color: #8957e5; }
        .action-icon[title^="مراسلة"]:hover { background-color: #1f6feb; }
        .action-icon[title="مشاركة رابط الاختبار"]:hover { background-color: #e3b341; }
        .action-icon[title="إعادة (تدريب)"]:hover { background-color: #bf5507; }

        .student-test-card {
            padding: 12px 15px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .test-main-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .test-grade-badge {
            background-color: color-mix(in srgb, var(--accent-secondary) 20%, transparent);
            color: var(--accent-secondary);
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            flex-shrink: 0;
            border: 1px solid color-mix(in srgb, var(--accent-secondary) 50%, transparent);
        }
        .test-name {
            font-weight: bold;
            font-size: 1.1rem;
            text-align: right;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-shadow: 0 1px 2px #000;
        }
        .desert-mode .test-name { text-shadow: none; }
        .test-expiry {
            font-size: 0.75rem;
            color: var(--warning-primary);
            text-align: right;
        }
        
        /* Separator for student results */
        #my-student-results-container .test-item:not(:last-child) {
            border-bottom: 2px solid var(--border-primary);
        }
        #my-student-results-container .test-item {
            border-radius: 0;
            margin-bottom: 0;
            border-left: none;
            border-right: none;
            border-top: none;
        }
        #my-student-results-container-wrapper {
             border: 1px solid var(--border-primary); 
             border-radius: 12px; 
             overflow: hidden;
        }
        #my-student-results-container-wrapper .test-item:first-child { border-top: none;}

        /* Advanced Search Bar */
        #search-bar {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-primary);
            border-radius: 25px;
            padding: 10px 20px 10px 45px;
            font-size: 1rem;
            position: relative;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%238b949e' class='bi bi-search' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 15px center;
            transition: all 0.3s ease-in-out;
        }
        .desert-mode #search-bar {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23584c3c' class='bi bi-search' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E");
        }
        #search-bar:focus {
            background-color: var(--bg-tertiary);
        }
        #search-bar.hidden {
            transform: translateY(-20px);
            opacity: 0;
            pointer-events: none;
        }
        .dashboard-header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .dashboard-header-controls .header-buttons {
            display: flex;
            gap: 10px;
        }

        /* --- Generic Modal --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);
            z-index: 2000; display: flex; justify-content: center; align-items: flex-start;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease;
            overflow-y: auto;
            padding: 40px 15px;
        }
        .desert-mode .modal-overlay { background: rgba(253, 246, 227, 0.7); }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-close-btn {
            position: absolute; top: 10px; left: 10px;
            width: 30px; height: 30px;
            background: rgba(255,255,255,0.1); color: #fff;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 50%;
            font-size: 18px; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            line-height: 1; z-index: 10;
            transition: transform 0.3s, background-color 0.3s;
        }
        .desert-mode .modal-close-btn { background: rgba(0,0,0,0.1); color: var(--text-primary); border-color: rgba(0,0,0,0.2); }
        .modal-close-btn:hover { background: rgba(255,255,255,0.2); transform: rotate(90deg); }
        .desert-mode .modal-close-btn:hover { background: rgba(0,0,0,0.2); }
        .modal-body { flex-grow: 1; }
        .modal-footer { margin-top: 20px; flex-shrink: 0; }
        
        #teacher-review-modal .modal-content { max-width: 800px; }
       
        /* --- Answer Review Highlighting --- */
        .review-option {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 5px;
            border: 1px solid var(--border-primary);
            background: var(--bg-secondary);
            text-align: right;
        }
        .review-option.correct-answer-highlight {
            background: var(--success-bg);
            border-color: var(--success-color);
            color: var(--text-primary);
            box-shadow: 0 0 10px var(--success-glow);
        }
        .review-option.incorrect-answer-highlight {
            background: var(--danger-bg);
            border-color: var(--danger-color);
            color: var(--text-primary);
            text-decoration: line-through;
        }


        /* --- Image Viewer Modal --- */
        .image-modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9);
            backdrop-filter: blur(10px); z-index: 3000;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease;
            touch-action: none; /* Prevent default touch actions like scrolling */
        }
        .image-modal-overlay.visible { opacity: 1; visibility: visible; }
        #image-viewer-content-wrapper {
            width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden; cursor: grab;
        }
        .image-modal-content {
            max-width: 90vw; max-height: 80vh;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            transition: transform 0.2s ease-out;
            will-change: transform;
            pointer-events: none; /* Let wrapper handle events */
        }
        .image-viewer-controls {
            display: none; /* Hidden as per user request */
        }
        .image-modal-download-btn {
            position: absolute; top: 20px; right: 20px; z-index: 3010;
            border-radius: 50%; text-decoration: none;
            background: rgba(40, 40, 40, 0.8);
            color: #fff; border: none;
            width: 45px; height: 45px; font-size: 18px;
            display: flex; align-items: center; justify-content: center;
        }
        
        /* --- Custom Dialogs (Alerts/Confirms) --- */
        .custom-dialog-overlay { position:fixed; inset:0; display:flex; justify-content:center; align-items:center; background:rgba(0,0,0,.7); backdrop-filter: blur(5px); opacity:0; visibility:hidden; transition:opacity .3s; z-index:9999; }
        .desert-mode .custom-dialog-overlay { background: rgba(253, 246, 227, 0.6); }
        .custom-dialog-overlay.show { opacity:1; visibility:visible; }
        .custom-dialog-overlay.show .custom-dialog {
            transform: scale(1); opacity: 1;
            animation: dialog-pop-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .custom-dialog {
            background: var(--bg-secondary); border: 1px solid var(--border-primary);
            border-radius: 20px; padding: 25px 30px;
            width: 90%; max-width: 420px; text-align: center;
            box-shadow: 0 10px 40px var(--shadow-color-heavy);
            border-top: 5px solid var(--accent-primary);
            transform:scale(0.9); opacity:0; transition:transform .3s,opacity .3s, background-color 0.4s, border-color 0.4s;
        }
        .dialog-icon {
            font-size: 4rem; line-height: 1; margin-bottom: 20px;
            color: var(--accent-secondary);
            animation: icon-bounce 0.6s 0.2s;
        }
        .custom-dialog h3 { font-size: 1.5rem; font-weight: 800; margin-bottom: 10px; }
        .custom-dialog p { font-size: 1rem; color: var(--text-secondary); line-height: 1.6; }
        .custom-dialog .dialog-buttons { display: flex; gap: 15px; justify-content: center; margin-top: 25px; }
        
        /* --- New Dialog Button Styles --- */
        .dialog-buttons button {
            flex-grow: 1;
            font-weight: 800 !important;
            font-size: 1rem !important;
            padding: 12px 20px !important;
            border: none;
            border-radius: 10px;
            color: #fff;
            cursor: pointer;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            transition: all 0.15s ease-out;
        }
        .dialog-buttons button.btn-primary {
            background: var(--accent-primary-gradient);
            border-bottom: 4px solid var(--accent-primary-border);
            box-shadow: 0 4px 10px -2px var(--accent-primary);
        }
        .dialog-buttons button.btn-primary:hover {
            transform: translateY(-2px);
            border-bottom-width: 6px;
            box-shadow: 0 6px 15px -2px var(--accent-primary);
        }
        .dialog-buttons button.btn-primary:active {
            transform: translateY(1px);
            border-bottom-width: 3px;
            box-shadow: 0 2px 5px -2px var(--accent-primary);
        }
        .dialog-buttons button.btn-secondary {
            background: var(--border-secondary);
            color: var(--text-primary);
            border-bottom: 4px solid var(--bg-tertiary);
        }
        .dialog-buttons button.btn-secondary:hover {
            transform: translateY(-2px);
            border-bottom-width: 6px;
            background: var(--border-primary);
        }
        .dialog-buttons button.btn-secondary:active {
            transform: translateY(1px);
            border-bottom-width: 3px;
        }
        
        @keyframes dialog-pop-in { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes icon-bounce { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-20px); } 60% { transform: translateY(-10px); } }

        /* --- Text Chat Styles --- */
        #text-chat-modal .chat-body { display: flex; flex-direction: column; gap: 12px; padding: 15px; max-height: 60vh; overflow-y: auto; }
        .chat-message { max-width: 80%; padding: 10px 15px; border-radius: 18px; line-height: 1.5; word-wrap: break-word; box-shadow: 0 2px 4px var(--shadow-color-light); }
        .chat-message.sent { background: var(--accent-primary); color: #fff; align-self: flex-end; border-bottom-right-radius: 4px; text-align: left; }
        .chat-message.received { background: var(--border-secondary); align-self: flex-start; border-bottom-left-radius: 4px; text-align: right; }
        .chat-message .msg-time { display: block; font-size: 0.7rem; color: var(--text-secondary); margin-top: 5px; opacity: 0.8; }
        .chat-message.sent .msg-time { color: rgba(255,255,255,0.7); }
        
        #text-chat-modal .chat-input-area { display: flex; gap: 10px; align-items: center; }
        #text-chat-modal textarea { flex-grow: 1; margin: 0; resize: none; }
        #text-chat-modal .chat-action-btn { width: 50px !important; height: 50px; padding: 0 !important; font-size: 1.2rem !important; flex-shrink: 0; border-radius: 50% !important; }
        #speech-to-text-btn.listening { color: var(--danger-primary); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 color-mix(in srgb, var(--danger-primary) 70%, transparent); } 70% { box-shadow: 0 0 0 10px color-mix(in srgb, var(--danger-primary) 0%, transparent); } 100% { box-shadow: 0 0 0 0 color-mix(in srgb, var(--danger-primary) 0%, transparent); } }

        /* --- Advanced Radio & Checkbox --- */
        .question-options { display: flex; flex-direction: column; gap: 10px; }
        .question-options label, .checkbox-container {
            display: flex;
            align-items: center;
            padding: 15px;
            background-color: var(--border-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        .question-options label:hover, .checkbox-container:hover {
            border-color: var(--accent-secondary);
            background-color: var(--border-primary);
        }
        .question-options input[type="radio"], .checkbox-container input[type="checkbox"] { display: none; }
        .question-options input[type="radio"] + span::before, .checkbox-container input[type="checkbox"] + label::before {
            content: '';
            width: 22px;
            height: 22px;
            border: 2px solid var(--text-secondary);
            background-color: var(--bg-primary);
            display: inline-block;
            margin-left: 15px;
            vertical-align: middle;
            transition: all 0.2s;
        }
        .question-options input[type="radio"] + span::before { border-radius: 50%; }
        .checkbox-container input[type="checkbox"] + label::before { border-radius: 6px; }
        .question-options input[type="radio"]:checked + span::before, .checkbox-container input[type="checkbox"]:checked + label::before {
            background-color: var(--accent-primary);
            border-color: var(--accent-secondary);
            box-shadow: 0 0 0 3px var(--bg-primary), 0 0 0 5px var(--accent-primary);
        }
        .checkbox-container input[type="checkbox"]:checked + label::after {
            content: '\f00c'; /* Font Awesome check icon */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            right: 23px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
            color: #fff;
        }
        .desert-mode .checkbox-container input[type="checkbox"]:checked + label::after {
             color: var(--bg-primary);
        }
        
        /* --- App Install Prompt Modal --- */
        #app-install-prompt-modal .custom-dialog {
            padding: 0;
            overflow: hidden;
            border-top: none;
        }
        .app-install-header {
            padding: 20px;
            text-align: center;
        }
        .app-install-header img {
            width: 80px;
            height: 80px;
            border-radius: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px var(--shadow-color-heavy);
        }
        .app-install-header h3 {
            font-size: 1.4rem;
            margin: 0;
        }
        .app-install-body {
            padding: 0 25px 25px 25px;
        }
        .app-install-body p {
            font-size: 1rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }
        .app-install-footer {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 0 25px 25px 25px;
        }
        .app-install-footer .btn-install {
            display: inline-block;
            text-align: center;
            padding: 20px 40px;
        }

        /* --- Custom Slogan Style --- */
        #slogan-widget {
            position: fixed;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            background: rgba(0,0,0,0.5);
            color: #fff;
            padding: 5px 10px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.2);
            cursor: pointer;
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        #slogan-widget:hover {
            transform: translateY(-2px) translateX(-50%);
            box-shadow: 0 4px 15px var(--shadow-color-light);
        }
        #slogan-widget img {
            width: 30px;
            height: 30px;
        }
        #slogan-widget span {
            font-weight: bold;
            text-shadow: 
                0.5px 0.5px 0px rgba(255,255,255,0.2), 
                1px 1px 0px rgba(255,255,255,0.2),
                1.5px 1.5px 3px var(--shadow-color-heavy);
        }
        .desert-mode #slogan-widget {
            background: rgba(255,255,255,0.5);
            color: var(--text-primary);
            border-color: rgba(0,0,0,0.2);
        }
        .desert-mode #slogan-widget span {
            text-shadow: 
                0.5px 0.5px 0px rgba(0,0,0,0.2), 
                1px 1px 0px rgba(0,0,0,0.2),
                1.5px 1.5px 3px var(--shadow-color-heavy);
        }

       /* --- New Group Chat Styles --- */
        #student-group-chat-content {
            height: calc(100vh - 120px); /* Full height minus headers */
            display: flex;
            flex-direction: column;
        }
        #group-chat-body {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 15px;
            overflow-y: auto;
            background-color: transparent; /* No container */
        }
        .group-chat-message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 18px;
            line-height: 1.5;
            word-wrap: break-word;
            position: relative;
        }
        .group-chat-message.sent {
            background-color: transparent;
            color: var(--text-primary);
            align-self: flex-end;
            text-align: left;
        }
        .group-chat-message.received {
            background-color: #8B4513; /* Brown color */
            color: #FFFFFF;
            align-self: flex-start;
            text-align: right;
            border-bottom-left-radius: 4px;
            padding-top: 25px; /* Space for sender name */
        }
        .msg-sender {
            position: absolute;
            top: 5px;
            right: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .msg-sender i { font-size: 0.7rem; }
        .group-chat-message .msg-text {
            font-size: 1rem;
        }
        .chat-input-area {
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 10px 0;
            border-top: 1px solid var(--border-primary);
            margin-top: auto; /* Push to bottom */
        }
        .chat-input-area textarea {
            flex-grow: 1;
            margin: 0;
            resize: none;
            border-radius: 25px;
            padding: 10px 20px;
        }
        .chat-input-area .chat-action-btn {
            width: 45px !important; height: 45px;
            padding: 0 !important; font-size: 1.1rem !important;
            flex-shrink: 0; border-radius: 50% !important;
        }
        .message-context-menu {
            display: none; position: absolute; background: var(--bg-tertiary);
            border: 1px solid var(--border-primary); border-radius: 8px; z-index: 10;
            box-shadow: 0 4px 10px var(--shadow-color-heavy);
        }
        .message-context-menu div { padding: 8px 12px; cursor: pointer; }
        .message-context-menu div:hover { background: var(--border-primary); }


        /* Animations & Responsiveness */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes floating { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        @media (max-width: 767px) {
            body { padding: 0 5px; }
            .landing-title { font-size: 2.2rem; }
            .glass-content { font-size: 1.2rem; padding: 1.2rem 2rem; }
            .role-selection { flex-direction: column; }
            .top-nav { flex-wrap: wrap; justify-content: space-around; height: auto; }
            .top-nav .nav-btn { font-size: 0.7rem; padding: 5px; }
            .top-nav .nav-btn i { font-size: 1.3rem; }
            .portal-header-controls h1 { font-size: 0.8rem; }
        }
        
        .tab-content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        .tab-content-header h2 {
            margin: 0;
        }

    </style>
</head>
<body class="no-select">
    <!-- ======== Fixed Slogan/Logo ======== -->
    <div id="slogan-widget" class="hidden">
        <img id="slogan-image" src="https://i.postimg.cc/BZw2BtL8/yourself-pharmacy-nutritional.png" alt="شعاري">
        <span id="slogan-text">شعاري</span>
    </div>

    <!-- ======== Main Landing Page Section ======== -->
    <main id="main-landing-page" class="hidden">
        <h2 class="landing-title glass-text-effect">اختر بوابتك للتعلم</h2>
        <div class="role-selection">
            <div id="show-teacher-portal" class="glass-container glass-button">
                <div class="glass-filter"></div>
                <div class="glass-overlay"></div>
                <div class="glass-specular"></div>
                <div class="glass-content">
                    <span>دخول المعلمين</span>
                    <i class="fas fa-chalkboard-teacher"></i>
                </div>
            </div>
            <div id="show-student-portal" class="glass-container glass-button">
                <div class="glass-filter"></div>
                <div class="glass-overlay"></div>
                <div class="glass-specular"></div>
                <div class="glass-content">
                    <span>دخول الطلاب</span>
                    <i class="fas fa-user-graduate"></i>
                </div>
            </div>
        </div>
    </main>

    <!-- ======== Teacher Portal Section (Initially Hidden) ======== -->
    <div id="teacher-portal" class="portal-container hidden">
        <nav class="top-nav hidden" id="teacher-top-nav">
            <button class="nav-btn active" data-target="teacher-tests-content"><i class="fas fa-file-alt"></i><span>الاختبارات</span></button>
            <button class="nav-btn" data-target="teacher-results-content"><i class="fas fa-poll-h"></i><span>النتائج</span></button>
            <button class="nav-btn" data-target="teacher-create-content"><i class="fas fa-plus-circle"></i><span>إنشاء</span></button>
        </nav>
        <header class="portal-header-controls hidden">
             <h1>مرحبًا بك، <span id="teacher-name"></span>!</h1>
             <div class="header-icons">
                <button class="icon-btn theme-toggle-btn" title="تبديل المظهر"><i class="fas fa-sun"></i></button>
                <div class="header-menu-container">
                    <div id="teacher-menu-icon" class="icon-btn" title="القائمة"><i class="fas fa-ellipsis-v"></i><span class="notification-badge"></span></div>
                    <div id="teacher-dropdown-menu" class="header-dropdown-menu">
                        <div class="dropdown-item" id="teacher-chat-btn"><i class="fas fa-comments"></i><span>الرسائل</span></div>
                        <div class="dropdown-item" id="teacher-settings-btn"><i class="fas fa-cog"></i><span>الإعدادات</span></div>
                        <div class="dropdown-item" id="teacher-share-platform-btn"><i class="fas fa-share-alt"></i><span>مشاركة المنصة</span></div>
                        <hr style="margin: 0;">
                        <div class="dropdown-item" id="teacher-logout-btn" style="color: var(--warning-primary);"><i class="fas fa-sign-out-alt"></i><span>تسجيل الخروج</span></div>
                    </div>
                </div>
            </div>
        </header>
        <div class="portal-content">
            <section id="teacher-register-section">
                <h1>تسجيل جديد - معلم</h1>
                <input type="text" id="teacher-register-name" placeholder="الاسم الكامل (باللغة الإنجليزية)" required />
                <input type="password" id="teacher-register-password" placeholder="كلمة المرور" required />
                <button id="teacher-register-btn" class="btn-primary">تسجيل</button>
                <p>هل لديك حساب؟ <a href="#" class="to-login">تسجيل دخول</a></p>
            </section>
            <section id="teacher-login-section" class="hidden">
                <h1>تسجيل دخول - معلم</h1>
                <input type="text" id="teacher-login-name" placeholder="الاسم الكامل (باللغة الإنجليزية)" required />
                <input type="password" id="teacher-login-password" placeholder="كلمة المرور" required />
                <button id="teacher-login-btn" class="btn-primary">دخول</button>
                <p>ليس لديك حساب؟ <a href="#" class="to-register">تسجيل جديد</a></p>
            </section>
            <section id="teacher-dashboard-section" class="hidden">
                <div id="teacher-tests-content" class="tab-content">
                    <div class="dashboard-header-controls">
                        <h2>اختباراتي المنشأة</h2>
                         <div class="header-buttons">
                             <button id="teacher-refresh-btn" class="icon-btn" title="تحديث"><i class="fas fa-sync-alt"></i></button>
                             <button id="teacher-show-search-btn" class="icon-btn" title="بحث"><i class="fas fa-search"></i></button>
                        </div>
                    </div>
                     <input type="text" id="teacher-search-bar" placeholder="ابحث عن اختبار..." class="hidden" style="margin-bottom:20px;"/>
                    <div id="my-tests-container"></div>
                </div>
                <div id="teacher-results-content" class="tab-content hidden">
                    <h2>نتائج الطلاب</h2>
                    <select id="results-test-selector"></select>
                    <div id="student-results-container"></div>
                </div>
                 <div id="teacher-create-content" class="tab-content hidden">
                    <div class="switch-button-container">
                        <button class="switch-button active" data-type="test" style="flex:1; padding:10px; background: var(--accent-primary); border:none; color: #fff; cursor: pointer; border-radius: 8px;">إنشاء اختبار</button>
                        <button class="switch-button" data-type="assessment" style="flex:1; padding:10px; background: var(--border-secondary); border:none; color: var(--text-primary); cursor: pointer; border-radius: 8px;">رفع تقييم</button>
                    </div>

                    <div id="teacher-create-test-content">
                        <h2 id="create-edit-title">إنشاء اختبار جديد</h2>
                        <label for="test-name">اسم الاختبار:</label><input type="text" id="test-name" />
                        <label for="test-grade">الصف:</label>
                        <select id="test-grade"><option value="" disabled selected>اختر الصف</option><option value="الصف الأول الإعدادي">الصف الأول الإعدادي</option><option value="الصف الثاني الإعدادي">الصف الثاني الإعدادي</option><option value="الصف الثالث الإعدادي">الصف الثالث الإعدادي</option><option value="الصف الأول الثانوي">الصف الأول الثانوي</option><option value="الصف الثاني الثانوي">الصف الثاني الثانوي</option><option value="الصف الثالث الثانوي">الصف الثالث الثانوي</option></select>
                        <label for="test-duration">مدة الاختبار بالدقائق:</label><input type="number" id="test-duration" min="1" />
                        <div class="checkbox-container"><input type="checkbox" id="prevent-go-back-checkbox"><label for="prevent-go-back-checkbox">منع الطالب من الرجوع للخلف</label></div>
                        <div class="checkbox-container"><input type="checkbox" id="shuffle-questions-checkbox"><label for="shuffle-questions-checkbox">ترتيب الأسئلة عشوائيًا</label></div>
                        <div class="checkbox-container"><input type="checkbox" id="fateful-test-checkbox"><label for="fateful-test-checkbox">اختبار مصيري (أمان عالي)</label></div>
                        <hr/><h3>إضافة سؤال جديد</h3>
                        <div class="switch-button-container" id="question-type-switcher">
                            <button class="switch-button active" data-type="mcq" style="flex:1; padding:10px; background: var(--accent-primary); border:none; color: #fff; cursor: pointer; border-radius: 8px;">سؤال اختياري</button>
                            <button class="switch-button" data-type="essay" style="flex:1; padding:10px; background: var(--border-secondary); border:none; color: var(--text-primary); cursor: pointer; border-radius: 8px;">سؤال مقالي</button>
                        </div>
                        <label for="question-text">نص السؤال:</label><textarea id="question-text" rows="3"></textarea>
                        <label for="question-image-input" class="file-input-label"><i class="fas fa-image"></i> <span>إرفاق صورة للسؤال (اختياري)</span></label>
                        <input type="file" id="question-image-input" accept="image/*" class="hidden" /><div class="image-preview-container hidden"><img class="image-preview" src="#" alt="معاينة" /></div>
                        <div id="mcq-fields">
                            <label>خيارات الإجابة (حدد الصحيحة):</label>
                            <div class="option-container"><input type="text" class="option-input" placeholder="الخيار 1" /><i class="fas fa-check-circle correct-answer-selector" data-index="1"></i></div>
                            <div class="option-container"><input type="text" class="option-input" placeholder="الخيار 2" /><i class="fas fa-check-circle correct-answer-selector" data-index="2"></i></div>
                            <div class="option-container"><input type="text" class="option-input" placeholder="الخيار 3" /><i class="fas fa-check-circle correct-answer-selector" data-index="3"></i></div>
                            <div class="option-container"><input type="text" class="option-input" placeholder="الخيار 4" /><i class="fas fa-check-circle correct-answer-selector" data-index="4"></i></div>
                        </div>
                        <div id="essay-fields" class="hidden">
                            <label for="model-answer-image-input" class="file-input-label"><i class="fas fa-file-image"></i> <span>إرفاق صورة إجابة نموذجية (اختياري)</span></label>
                            <input type="file" id="model-answer-image-input" accept="image/*" class="hidden"><div class="image-preview-container hidden"><img class="image-preview" src="#" alt="معاينة" /></div>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
                            <label for="question-points" style="margin: 0; flex-shrink: 0;">درجات السؤال:</label>
                            <input type="number" id="question-points" min="1" placeholder="1" style="margin: 0; width: 80px;">
                            <button id="add-question-btn" class="btn-secondary" style="margin: 0; flex-grow: 1;">إضافة سؤال للقائمة</button>
                            <button id="cancel-question-edit-btn" class="btn-secondary hidden" style="margin: 0; width: auto; background-color: #5a6268; border-color: #495057;">إلغاء التعديل</button>
                        </div>
                        <div id="questions-list-container" style="margin-top: 15px;"></div>
                        <button id="save-test-btn" class="btn-primary" style="margin-top: 20px; background: var(--success-gradient); border-bottom-color: var(--success-border);">حفظ الاختبار</button>
                        <button id="cancel-test-edit-btn" class="btn-secondary hidden" style="margin-top: 10px;">إلغاء التعديل</button>
                    </div>
                     <div id="teacher-create-assessment-content" class="hidden">
                        <h2>رفع تقييم جديد</h2>
                        <label for="assessment-image-input" class="file-input-label"><i class="fas fa-image"></i> <span>اختر صورة التقييم (إجباري)</span></label>
                        <input type="file" id="assessment-image-input" accept="image/*" class="hidden" required>
                        <div class="image-preview-container hidden"><img class="image-preview" src="#" alt="معاينة التقييم" /></div>
                        <label for="assessment-text">نص التقييم (اختياري):</label>
                        <textarea id="assessment-text" rows="4"></textarea>
                        <button id="save-assessment-btn" class="btn-primary" style="margin-top: 20px;">حفظ ورفع تقييم آخر</button>
                    </div>
                </div>
            </section>
        </div>
        <!-- Teacher Modals -->
        <div id="teacher-review-modal" class="modal-overlay">
            <div class="modal-content">
                <button class="modal-close-btn">&times;</button>
                <h2 id="review-modal-title">مراجعة إجابات الطالب</h2>
                <div id="review-modal-body" class="modal-body"></div>
                <div id="review-modal-footer" class="modal-footer hidden">
                    <button id="finalize-grades-btn" class="btn-primary">حفظ الدرجات النهائية</button>
                </div>
            </div>
        </div>
        <div id="teacher-settings-modal" class="modal-overlay">
            <div class="modal-content" style="max-width: 450px;">
                <button class="modal-close-btn">&times;</button>
                <h2>الإعدادات</h2>
                <label for="teacher-update-name">الاسم (باللغة الإنجليزية):</label>
                <input type="text" id="teacher-update-name" placeholder="الاسم الكامل الجديد">
                <label for="teacher-update-password">كلمة المرور الجديدة:</label>
                <input type="password" id="teacher-update-password" placeholder="اتركها فارغة لعدم التغيير">
                <button id="teacher-update-btn" class="btn-primary" style="margin-top: 10px;">تحديث الحساب</button>
            </div>
        </div>
    </div>

    <!-- ======== Student Portal Section (Initially Hidden) ======== -->
    <div id="student-portal" class="portal-container hidden">
         <nav class="top-nav hidden" id="student-top-nav">
            <button class="nav-btn active" data-target="student-tests-content"><i class="fas fa-book-open"></i><span>الاختبارات</span></button>
            <button class="nav-btn" data-target="student-assessments-content"><i class="fas fa-clipboard-check"></i><span>التقييمات</span></button>
            <button class="nav-btn" data-target="student-results-content"><i class="fas fa-poll-h"></i><span>نتائجي</span></button>
            <button class="nav-btn" data-target="student-group-chat-content"><i class="fas fa-users"></i><span>دردشة</span></button>
        </nav>
         <header class="portal-header-controls hidden">
            <h1>مرحبًا بك، <span id="student-name"></span>!</h1>
            <div class="header-icons">
                 <button class="icon-btn theme-toggle-btn" title="تبديل المظهر"><i class="fas fa-sun"></i></button>
                 <div class="header-menu-container">
                    <div id="student-menu-icon" class="icon-btn" title="القائمة"><i class="fas fa-ellipsis-v"></i><span class="notification-badge"></span></div>
                    <div id="student-dropdown-menu" class="header-dropdown-menu">
                        <div class="dropdown-item" id="student-chat-btn"><i class="fas fa-comments"></i><span>الرسائل</span></div>
                        <div class="dropdown-item" id="student-settings-btn"><i class="fas fa-cog"></i><span>الإعدادات</span></div>
                        <div class="dropdown-item" id="student-share-platform-btn"><i class="fas fa-share-alt"></i><span>مشاركة المنصة</span></div>
                        <hr style="margin: 0;">
                        <div class="dropdown-item" id="student-logout-btn" style="color: var(--warning-primary);"><i class="fas fa-sign-out-alt"></i><span>تسجيل الخروج</span></div>
                    </div>
                </div>
            </div>
        </header>
         <div class="portal-content">
            <section id="student-register-section">
                <h2>تسجيل جديد</h2>
                <input type="text" id="student-register-name" placeholder="الاسم الكامل (باللغة الإنجليزية)" required autocomplete="off">
                <input type="password" id="student-register-password" placeholder="كلمة المرور" required autocomplete="new-password">
                <button id="student-register-btn" class="btn-primary">تسجيل</button><p>هل لديك حساب؟ <a href="#" class="to-login">تسجيل دخول</a></p>
            </section>
            <section id="student-login-section" class="hidden">
                <h2>تسجيل الدخول</h2>
                <input type="text" id="student-login-name" placeholder="الاسم الكامل (باللغة الإنجليزية)" required autocomplete="off">
                <input type="password" id="student-login-password" placeholder="كلمة المرور" required autocomplete="current-password">
                <button id="student-login-btn" class="btn-primary">دخول</button><p>ليس لديك حساب؟ <a href="#" class="to-register">تسجيل جديد</a></p>
            </section>
            <section id="student-dashboard-section" class="hidden">
                <div class="tab-content" id="student-tests-content">
                    <div class="dashboard-header-controls">
                        <h2>الاختبارات المتاحة</h2>
                        <div class="header-buttons">
                             <button id="refresh-tests-btn" class="icon-btn" title="تحديث"><i class="fas fa-sync-alt"></i></button>
                             <button id="show-search-btn" class="icon-btn" title="بحث"><i class="fas fa-search"></i></button>
                        </div>
                    </div>
                    <input type="text" id="search-bar" placeholder="ابحث عن اختبار..." class="hidden" style="margin-bottom:20px;"/>
                    <div id="available-tests-container"></div>
                </div>
                <div class="tab-content hidden" id="student-results-content"><h2>نتائجي السابقة</h2><div id="my-student-results-container-wrapper"><div id="my-student-results-container"></div></div></div>
                <div class="tab-content hidden" id="student-assessments-content">
                    <button id="back-to-dashboard-from-assessments-btn" class="btn-secondary hidden" style="width: auto; padding: 10px 20px !important; margin-bottom:15px;">العودة</button>
                    <h2>التقييمات والأداء</h2>
                    <div id="assessments-container"></div>
                </div>
                 <div class="tab-content hidden" id="student-group-chat-content">
                    <div id="group-chat-body"></div>
                    <div class="chat-input-area">
                        <textarea id="group-chat-message-input" rows="1" placeholder="اكتب رسالتك..."></textarea>
                        <button id="send-group-chat-message-btn" class="chat-action-btn btn-primary"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </section>
            <section id="take-test-section" class="hidden">
                <h2 id="current-test-title"></h2>
                <div id="timer" style="font-size:1.6rem; font-weight:700; color:var(--warning-primary); margin-bottom:8px;"></div>
                <div style="width:100%; height:8px; background:var(--border-secondary); border-radius:4px; overflow:hidden; margin-bottom:20px;"><div id="timer-progress" style="height:100%; width:100%; background:var(--accent-primary-gradient); transition:width .5s linear;"></div></div>
                <div id="questions-display"></div>
                <div id="question-navigation-container" style="display:flex; gap:10px; margin-top: 20px;" class="hidden">
                    <button id="prev-question-btn" class="btn-secondary">السابق</button>
                    <button id="next-question-btn" class="btn-primary">التالي</button>
                </div>
                <button id="submit-test-btn" class="btn-primary" style="margin-top: 20px; background: var(--success-gradient); border-bottom-color: var(--success-border);">تسليم الاختبار</button>
                <button id="cancel-test-btn" class="btn-secondary" style="margin-top: 10px;">إلغاء الاختبار</button>
            </section>
            <section id="test-result-section" class="hidden">
                <h1>نتيجتك</h1>
                <h2 id="final-score" style="font-size:2rem; margin:15px 0;"></h2>
                <div id="feedback-message" style="padding:15px; border-radius:12px; margin-top:15px; font-weight:600; font-size: 1.1rem;"></div>
                <button id="review-answers-btn" class="btn-primary">مراجعة الإجابات</button>
                <button id="back-to-dashboard-btn" class="btn-secondary" style="margin-top: 10px;">العودة للرئيسية</button>
            </section>
            <section id="review-section" class="hidden">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                     <h1>مراجعة الإجابات</h1>
                     <button id="back-to-dashboard-from-review-btn" class="btn-secondary" style="width: auto; padding: 10px 20px !important; margin:0;">العودة</button>
                </div>
                <hr/>
                <div id="review-container"></div>
            </section>
         </div>
         <div id="student-settings-modal" class="modal-overlay">
            <div class="modal-content" style="max-width: 450px;">
                <button class="modal-close-btn">&times;</button>
                <h2>الإعدادات</h2>
                <label for="student-update-name">الاسم (باللغة الإنجليزية):</label>
                <input type="text" id="student-update-name" placeholder="الاسم الكامل الجديد">
                <label for="student-update-password">كلمة المرور الجديدة:</label>
                <input type="password" id="student-update-password" placeholder="اتركها فارغة لعدم التغيير">
                <button id="student-update-btn" class="btn-primary" style="margin-top:10px;">تحديث الحساب</button>
            </div>
        </div>
        <div id="student-chat-list-modal" class="modal-overlay">
            <div class="modal-content" style="max-width: 500px;">
                <button class="modal-close-btn">&times;</button>
                <h2>قائمة المحادثات</h2>
                <div id="student-chat-list-body" class="modal-body"></div>
            </div>
        </div>
    </div>
    
    <!-- ======== Universal Modals ======== -->
    <div id="image-viewer-modal" class="image-modal-overlay">
        <div class="image-viewer-controls">
        </div>
        <button class="modal-close-btn">&times;</button>
        <a href="#" class="image-modal-download-btn" download="image.jpg"><i class="fas fa-download"></i></a>
        <div id="image-viewer-content-wrapper">
             <img src="" alt="Image Preview" class="image-modal-content">
        </div>
    </div>

    <div id="text-chat-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <button class="modal-close-btn">&times;</button>
            <h2 id="chat-modal-title">محادثة مع</h2>
            <div class="chat-body" id="chat-modal-body"></div>
            <div class="modal-footer">
                <p id="message-limit-text" style="font-size: 0.9rem; color: var(--warning-primary); margin-bottom: 10px;"></p>
                <div class="chat-input-area">
                    <button id="speech-to-text-btn" class="chat-action-btn btn-secondary"><i class="fas fa-microphone"></i></button>
                    <textarea id="chat-message-input" rows="1" placeholder="اكتب رسالتك..." style="height: 50px;"></textarea>
                    <button id="send-chat-message-btn" class="chat-action-btn btn-primary"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="teacher-chat-list-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <button class="modal-close-btn">&times;</button>
            <h2>قائمة المحادثات</h2>
            <div id="teacher-chat-list-body" class="modal-body"></div>
        </div>
    </div>

    <!-- ======== Custom Dialogs (Alerts/Confirms) ======== -->
    <div id="custom-alert-container" class="custom-dialog-overlay">
        <div class="custom-dialog">
            <div class="dialog-icon"><i class="fas fa-check-circle"></i></div>
            <h3 id="custom-alert-title"></h3>
            <p id="custom-alert-message"></p>
            <div class="dialog-buttons">
                <button id="custom-alert-close-btn" class="btn-primary">موافق</button>
            </div>
        </div>
    </div>
    <div id="custom-confirm-container" class="custom-dialog-overlay">
        <div class="custom-dialog">
            <div class="dialog-icon"><i class="fas fa-question-circle"></i></div>
            <h3 id="custom-confirm-title"></h3>
            <p id="custom-confirm-message"></p>
            <div class="dialog-buttons">
                <button id="custom-confirm-cancel-btn" class="btn-secondary">إلغاء</button>
                <button id="custom-confirm-ok-btn" class="btn-primary">تأكيد</button>
            </div>
        </div>
    </div>

    <!-- ======== App Install Prompt Modal ======== -->
    <div id="app-install-prompt-modal" class="custom-dialog-overlay">
        <div class="custom-dialog">
            <div class="app-install-header">
                <img src="https://i.postimg.cc/rm50gg3z/Whats-App-Image-2025-10-02-at-4-15-54-PM.jpg" alt="شعار التطبيق">
                <h3>حان الوقت لتجربة أفضل!</h3>
            </div>
            <div class="app-install-body">
                <p>عليك تثبيت التطبيق لرؤية كافة الاختبارات، معرفة درجاتك، والتواصل مع المعلمين بسهولة.</p>
            </div>
            <div class="app-install-footer">
                <a href="https://apk.e-droid.net/apk/app3760290-c4w5f2.apk?v=5" download class="btn-3d btn-install">تثبيت التطبيق الآن</a>
                <button id="app-install-cancel-btn" class="btn-secondary" style="width:100%; padding: 12px 20px;">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- Message Context Menu -->
    <div id="message-context-menu" class="message-context-menu">
        <div data-action="reply">رد</div>
        <div data-action="delete">مسح من عندي</div>
    </div>


    <!-- SVG FILTER DEFINITION -->
    <svg style="display: none">
      <filter id="lg-dist" x="0%" y="0%" width="100%" height="100%">
        <feTurbulence type="fractalNoise" baseFrequency="0.008 0.008" numOctaves="2" seed="92" result="noise" />
        <feGaussianBlur in="noise" stdDeviation="2" result="blurred" />
        <feDisplacementMap in="SourceGraphic" in2="blurred" scale="70" xChannelSelector="R" yChannelSelector="G" />
      </filter>
    </svg>

    <!-- ======== Main JavaScript Logic =======-->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";
        import { getDatabase, ref, set, get, onValue, push, serverTimestamp, remove, update, query, orderByChild, equalTo, off } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDb19zrwV84CCbI8s2q8utFdIhasokmrpQ",
            authDomain: "saif-28e78.firebaseapp.com",
            databaseURL: "https://saif-28e78-default-rtdb.firebaseio.com",
            projectId: "saif-28e78",
            storageBucket: "saif-28e78.appspot.com",
            messagingSenderId: "979905571539",
            appId: "1:979905571539:web:3ff28289e17d3180964226",
            measurementId: "G-47JV5KDDTP"
        };

        const app = initializeApp(firebaseConfig);
        getAnalytics(app);
        const db = getDatabase(app);
        const appUrl = "https://apk.e-droid.net/apk/app3760290-c4w5f2.apk?v=5";

        const mainLandingPage = document.getElementById('main-landing-page');
        const teacherPortal = document.getElementById('teacher-portal');
        const studentPortal = document.getElementById('student-portal');
        let countdownInterval = null;

        document.getElementById('show-teacher-portal').addEventListener('click', (e) => { e.preventDefault(); mainLandingPage.classList.add('hidden'); teacherPortal.classList.remove('hidden'); initTeacherApp(); });
        document.getElementById('show-student-portal').addEventListener('click', (e) => { e.preventDefault(); mainLandingPage.classList.add('hidden'); studentPortal.classList.remove('hidden'); initStudentApp(); });
        
        const getBase64 = (file) => new Promise((resolve, reject) => { const reader=new FileReader();reader.readAsDataURL(file);reader.onload=()=>resolve(reader.result);reader.onerror=e=>reject(e) });
        
        const alertCont = document.getElementById('custom-alert-container');
        const confirmCont = document.getElementById('custom-confirm-container');
        const appInstallPrompt = document.getElementById('app-install-prompt-modal');
        
        const showCustomAlert = (title, message) => { 
            alertCont.querySelector('#custom-alert-title').textContent = title; 
            alertCont.querySelector('#custom-alert-message').innerHTML = message; 
            alertCont.classList.add('show'); 
        };
        alertCont.querySelector('#custom-alert-close-btn').onclick = () => alertCont.classList.remove('show');
        appInstallPrompt.querySelector('#app-install-cancel-btn').onclick = () => appInstallPrompt.classList.remove('show');

        
        const showCustomConfirm = (title, message) => {
            return new Promise(resolve => {
                confirmCont.querySelector('#custom-confirm-title').textContent = title; 
                confirmCont.querySelector('#custom-confirm-message').textContent = message; 
                confirmCont.classList.add('show');
                const okBtn = confirmCont.querySelector('#custom-confirm-ok-btn');
                const cancelBtn = confirmCont.querySelector('#custom-confirm-cancel-btn');
                
                const newOkBtn = okBtn.cloneNode(true);
                okBtn.parentNode.replaceChild(newOkBtn, okBtn);
                const newCancelBtn = cancelBtn.cloneNode(true);
                cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

                const cleanup = (result) => { 
                    confirmCont.classList.remove('show'); 
                    resolve(result); 
                };
                newOkBtn.addEventListener('click', () => cleanup(true), { once: true });
                newCancelBtn.addEventListener('click', () => cleanup(false), { once: true });
            });
        };


        async function sharePlatform() {
            try {
                if (navigator.share) {
                    await navigator.share({ text: `تفضل رابط التطبيق: ${appUrl}` });
                } else {
                    await navigator.clipboard.writeText(appUrl);
                    showCustomAlert('تم النسخ', 'تم نسخ رابط التطبيق بنجاح!');
                }
            } catch (err) {
                console.error("Share failed:", err);
            }
        }
        
        const themeToggleButtons = document.querySelectorAll('.theme-toggle-btn');
        const body = document.body;

        function applyTheme(theme) {
            themeToggleButtons.forEach(button => {
                const icon = button.querySelector('i');
                if (theme === 'desert') {
                    body.classList.add('desert-mode');
                    icon.classList.remove('fa-sun');
                    icon.classList.add('fa-moon');
                } else {
                    body.classList.remove('desert-mode');
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                }
            });
        }

        function toggleTheme() {
            const currentTheme = body.classList.contains('desert-mode') ? 'desert' : 'night';
            const newTheme = currentTheme === 'desert' ? 'night' : 'desert';
            applyTheme(newTheme);
            localStorage.setItem('preferredTheme', newTheme);
        }

        function initializeTheme() {
            const savedTheme = localStorage.getItem('preferredTheme');
            if (savedTheme) {
                applyTheme(savedTheme);
            } else {
                const hour = new Date().getHours();
                if (hour >= 6 && hour < 18) {
                    applyTheme('desert');
                } else {
                    applyTheme('night');
                }
            }
        }
        
        themeToggleButtons.forEach(button => button.addEventListener('click', toggleTheme));
        initializeTheme();


        function initTeacherApp() {
            const allSections = teacherPortal.querySelectorAll('section'), dashboardSection = teacherPortal.querySelector('#teacher-dashboard-section'), loginSection = teacherPortal.querySelector('#teacher-login-section'), registerSection = teacherPortal.querySelector('#teacher-register-section');
            const portalHeader = teacherPortal.querySelector('.portal-header-controls'), menuIcon = teacherPortal.querySelector('#teacher-menu-icon'), dropdownMenu = teacherPortal.querySelector('#teacher-dropdown-menu');
            const settingsModal = teacherPortal.querySelector('#teacher-settings-modal');
            const teacherNameSpan = teacherPortal.querySelector("#teacher-name"), topNav = teacherPortal.querySelector('#teacher-top-nav'), myTestsContainer = teacherPortal.querySelector("#my-tests-container");
            const resultsTestSelector = teacherPortal.querySelector("#results-test-selector"), studentResultsContainer = teacherPortal.querySelector("#student-results-container");
            const createContent = document.getElementById('teacher-create-content');
            const createTestSection = teacherPortal.querySelector('#teacher-create-test-content'), testNameInput = teacherPortal.querySelector("#test-name"), testGradeSelect = teacherPortal.querySelector("#test-grade"), testDurationInput = teacherPortal.querySelector("#test-duration");
            const preventGoBackCheckbox = teacherPortal.querySelector("#prevent-go-back-checkbox"), shuffleQuestionsCheckbox = teacherPortal.querySelector('#shuffle-questions-checkbox'), fatefulTestCheckbox = document.getElementById('fateful-test-checkbox');
            const questionText = teacherPortal.querySelector("#question-text"), optionInputs = teacherPortal.querySelectorAll(".option-input"), questionPointsInput = teacherPortal.querySelector("#question-points");
            const questionsListContainer = teacherPortal.querySelector("#questions-list-container"), questionImageInput = teacherPortal.querySelector("#question-image-input"), modelAnswerImageInput = teacherPortal.querySelector("#model-answer-image-input");
            const addQuestionBtn = teacherPortal.querySelector('#add-question-btn'), cancelQuestionEditBtn = teacherPortal.querySelector('#cancel-question-edit-btn'), saveTestBtn = teacherPortal.querySelector('#save-test-btn'), cancelTestEditBtn = teacherPortal.querySelector('#cancel-test-edit-btn');
            const reviewModal = teacherPortal.querySelector('#teacher-review-modal'), reviewModalBody = teacherPortal.querySelector('#review-modal-body'), reviewModalTitle = teacherPortal.querySelector('#review-modal-title'), reviewModalFooter = teacherPortal.querySelector('#review-modal-footer'), finalizeGradesBtn = teacherPortal.querySelector('#finalize-grades-btn');
            const updateNameInput = teacherPortal.querySelector('#teacher-update-name'), updatePasswordInput = teacherPortal.querySelector('#teacher-update-password'), updateBtn = teacherPortal.querySelector('#teacher-update-btn');
            const teacherRefreshBtn = document.getElementById('teacher-refresh-btn');
            const teacherShowSearchBtn = document.getElementById('teacher-show-search-btn');
            const teacherSearchBar = document.getElementById('teacher-search-bar');
            const createAssessmentSection = document.getElementById('teacher-create-assessment-content');
            const saveAssessmentBtn = document.getElementById('save-assessment-btn');
            const assessmentImageInput = document.getElementById('assessment-image-input');
            const assessmentText = document.getElementById('assessment-text');
            let currentAssessmentImageBase64 = null;
            let currentCorrectAnswer = 0;


            let currentUser = null, myTests = {}, questionsArray = [], currentQuestionImageBase64 = null, currentModelAnswerImageBase64 = null, currentQuestionType = 'mcq', currentEditingTestId = null, currentEditingQuestionIndex = -1;
            
            const loggedInUser = localStorage.getItem('loggedInTeacher');
            if (loggedInUser) { currentUser = loggedInUser; showSection(dashboardSection); updateDashboard(); } else { showSection(loginSection); }

            function showSection(section) { 
                allSections.forEach(s=>s.classList.add('hidden')); 
                if(section) section.classList.remove('hidden'); 
                const isDashboard = section && section.id === 'teacher-dashboard-section';
                topNav.classList.toggle('hidden', !isDashboard); 
                portalHeader.classList.toggle('hidden', !isDashboard);
                teacherPortal.classList.toggle('auth-view', section === loginSection || section === registerSection);
            };
            const showLoadingSpinner = (container) => { container.innerHTML = `<div class="spinner"></div>`; };
            const navButtons = teacherPortal.querySelectorAll('.nav-btn');
            navButtons.forEach(button => { button.addEventListener('click', () => { navButtons.forEach(btn=>btn.classList.remove('active')); teacherPortal.querySelectorAll('.tab-content').forEach(c=>c.classList.add('hidden')); button.classList.add('active'); teacherPortal.querySelector(`#${button.dataset.target}`).classList.remove('hidden'); if(button.dataset.target === 'teacher-create-content' && !currentEditingTestId) resetCreateFormState(); }); });
            const setDefaultTab = () => navButtons[0].click();
            
            createContent.querySelectorAll('.switch-button-container .switch-button').forEach(btn => btn.addEventListener('click', (e) => {
                const container = e.target.parentElement;
                // Deactivate all buttons in the same container first
                container.querySelectorAll('.switch-button').forEach(b => {
                    b.classList.remove('active');
                    b.style.background = 'var(--border-secondary)';
                    b.style.color = 'var(--text-primary)';
                });
                // Activate the clicked button
                e.target.classList.add('active');
                e.target.style.background = 'var(--accent-primary)';
                e.target.style.color = '#fff';

                if (container.id === 'question-type-switcher') {
                     currentQuestionType = e.target.dataset.type;
                     teacherPortal.querySelector("#mcq-fields").classList.toggle('hidden', currentQuestionType !== 'mcq');
                     teacherPortal.querySelector("#essay-fields").classList.toggle('hidden', currentQuestionType !== 'essay');
                } else {
                    const type = e.target.dataset.type;
                    createTestSection.classList.toggle('hidden', type !== 'test');
                    createAssessmentSection.classList.toggle('hidden', type !== 'assessment');
                }
            }));

            const mcqFields = document.getElementById('mcq-fields');
            mcqFields.addEventListener('click', (e) => {
                if (e.target.classList.contains('correct-answer-selector')) {
                    mcqFields.querySelectorAll('.correct-answer-selector').forEach(sel => sel.classList.remove('selected'));
                    e.target.classList.add('selected');
                    currentCorrectAnswer = parseInt(e.target.dataset.index);
                }
            });

            const clearQuestionForm = () => { questionText.value=""; questionImageInput.value=""; modelAnswerImageInput.value=""; currentQuestionImageBase64=null; currentModelAnswerImageBase64=null; teacherPortal.querySelectorAll('.image-preview-container').forEach(c=>{c.classList.add('hidden'); c.querySelector('img').src = '#'}); optionInputs.forEach(i=>i.value=""); mcqFields.querySelectorAll('.correct-answer-selector').forEach(sel => sel.classList.remove('selected')); currentCorrectAnswer=0; questionPointsInput.value = ""; currentEditingQuestionIndex = -1; addQuestionBtn.textContent = 'إضافة سؤال للقائمة'; cancelQuestionEditBtn.classList.add('hidden'); };
            
            async function updateDashboard() { if(!currentUser) return; teacherNameSpan.textContent = currentUser; setDefaultTab(); showLoadingSpinner(myTestsContainer); const testsRef = ref(db, `tests/${currentUser}`); onValue(testsRef, (snapshot) => { myTests = snapshot.exists() ? snapshot.val() : {}; renderMyTests(); populateResultsSelector(); }); initChatSystem(currentUser, 'teacher'); }
            
            teacherRefreshBtn.onclick = updateDashboard;
            teacherShowSearchBtn.addEventListener('click', () => {
                teacherSearchBar.classList.toggle('hidden');
                teacherShowSearchBtn.classList.toggle('active');
                if (!teacherSearchBar.classList.contains('hidden')) {
                    teacherSearchBar.focus();
                } else {
                    renderMyTests('');
                    teacherSearchBar.value = '';
                }
            });
            teacherSearchBar.addEventListener('input', e => renderMyTests(e.target.value));


            function renderMyTests(filter = '') {
                myTestsContainer.innerHTML = "";
                if (countdownInterval) clearInterval(countdownInterval);
                const activeTests = Object.entries(myTests).filter(([id, test]) => (Date.now() - test.timestamp < 48 * 60 * 60 * 1000));
                
                if (activeTests.length === 0) { myTestsContainer.innerHTML = "<p>لم تقم بإنشاء أي اختبارات نشطة.</p>"; return; }
                
                let found = false;
                activeTests.sort((a,b) => b[1].timestamp - a[1].timestamp).forEach(([testId, test]) => {
                    const searchStr = `${test.name}${test.grade}`.toLowerCase();
                    if(filter && !searchStr.includes(filter.toLowerCase())) return;
                    found = true;

                    const testCard = document.createElement('div'); testCard.className = 'list-item';
                    testCard.style.cssText = `flex-direction: column; align-items: stretch; padding: 12px; gap: 10px;`;
                    testCard.innerHTML = `
                        <div style="font-weight: bold; font-size: 1.1rem; text-align: right;">${test.name}</div>
                        <div style="font-size: 0.9rem; color: var(--text-secondary); text-align: right;">${test.grade} - ${test.duration} دقيقة</div>
                        <div class="test-countdown" data-timestamp="${test.timestamp}"></div>
                        <div style="display: flex; gap: 8px; margin-top: 10px;">
                            <button class="action-btn btn-secondary" data-action="share" title="مشاركة" style="flex-grow: 1;"><i class="fas fa-share-alt"></i></button>
                            <button class="action-btn btn-secondary" data-action="results" title="النتائج" style="flex-grow: 1;"><i class="fas fa-poll-h"></i></button>
                            <button class="action-btn btn-secondary" data-action="edit" title="تعديل" style="flex-grow: 1;"><i class="fas fa-edit"></i></button>
                            <button class="action-btn btn-secondary btn-danger" data-action="delete" title="حذف" style="flex-grow: 1;"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    testCard.querySelector('[data-action="share"]').onclick = () => shareTest(test.name);
                    testCard.querySelector('[data-action="results"]').onclick = () => { navButtons[1].click(); resultsTestSelector.value = testId; loadStudentResultsForTest(testId); };
                    testCard.querySelector('[data-action="edit"]').onclick = () => startEditingTest(testId, test);
                    testCard.querySelector('[data-action="delete"]').onclick = async () => { if (await showCustomConfirm("تأكيد الحذف", "هل أنت متأكد من حذف هذا الاختبار نهائيًا؟ سيتم حذف جميع نتائج الطلاب المرتبطة به.")) deleteTest(testId); };
                    myTestsContainer.appendChild(testCard);
                });

                if (!found && filter) {
                     myTestsContainer.innerHTML = "<p>لا توجد نتائج مطابقة لبحثك.</p>";
                }
                startCountdownTimers();
            }

            function startCountdownTimers(){
                const update = () => {
                    document.querySelectorAll('.test-countdown').forEach(el => {
                        const timestamp = parseInt(el.dataset.timestamp);
                        const endTime = timestamp + 48 * 60 * 60 * 1000;
                        const remaining = endTime - Date.now();
                        if(remaining > 0){
                            const hours = Math.floor(remaining / (1000 * 60 * 60));
                            const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                            el.textContent = `ينتهي خلال: ${hours} س و ${minutes} د`;
                        } else {
                            el.textContent = "انتهى";
                            el.parentElement.style.opacity = '0.5';
                        }
                    });
                };
                update();
                countdownInterval = setInterval(update, 60000);
            }

            async function deleteTest(testId) { try { await remove(ref(db, `tests/${currentUser}/${testId}`)); await remove(ref(db, `results/${currentUser}/${testId}`)); showCustomAlert("نجاح", "تم حذف الاختبار بنجاح."); } catch (e) { showCustomAlert("خطأ", "حدث خطأ أثناء حذف الاختبار."); } }
            
            function startEditingTest(testId, testData) {
                navButtons[2].click(); currentEditingTestId = testId;
                createTestSection.querySelector('#create-edit-title').textContent = "تعديل الاختبار"; saveTestBtn.textContent = "تحديث الاختبار"; cancelTestEditBtn.classList.remove('hidden');
                testNameInput.value = testData.name; testGradeSelect.value = testData.grade; testDurationInput.value = testData.duration;
                preventGoBackCheckbox.checked = !!testData.preventGoBack; shuffleQuestionsCheckbox.checked = !!testData.shuffle; fatefulTestCheckbox.checked = !!testData.fateful;
                questionsArray = [...(testData.questions || [])]; renderQuestionsList();
            }

            function resetCreateFormState() { currentEditingTestId = null; createTestSection.querySelector('#create-edit-title').textContent = "إنشاء اختبار جديد"; saveTestBtn.textContent = "حفظ الاختبار"; cancelTestEditBtn.classList.add('hidden'); testNameInput.value = ""; testGradeSelect.value = ""; testDurationInput.value = ""; preventGoBackCheckbox.checked=false; shuffleQuestionsCheckbox.checked=false; fatefulTestCheckbox.checked=false; questionsArray = []; renderQuestionsList(); clearQuestionForm(); }
            cancelTestEditBtn.onclick = resetCreateFormState;

            async function loadStudentResultsForTest(testId) {
                studentResultsContainer.innerHTML = "";
                if (!testId) return;

                showLoadingSpinner(studentResultsContainer);
                const snapshot = await get(ref(db, `results/${currentUser}/${testId}`));
                if (!snapshot.exists()) { studentResultsContainer.innerHTML = "<p>لا توجد نتائج لهذا الاختبار بعد.</p>"; return; }
                studentResultsContainer.innerHTML = "";
                Object.entries(snapshot.val()).forEach(([studentName, result]) => {
                    const div = document.createElement('div'); div.className = 'list-item';
                    const pendingIndicator = result.status === 'pending' ? `<span style="color:var(--warning-primary); font-weight:bold; margin-inline:10px;">(قيد المراجعة)</span>` : '';
                    div.innerHTML = `<span style="flex-grow:1; text-align: right;">الطالب: <strong>${studentName}</strong></span><span>الدرجة: <strong>${result.score}</strong></span>${pendingIndicator}<i class="fas fa-comment-dots" title="مراسلة الطالب" style="margin: 0 15px; color: var(--accent-secondary); cursor: pointer; font-size: 1.2rem;"></i><button class="action-btn btn-secondary" data-action="details">التفاصيل</button>`;
                    div.querySelector('[data-action="details"]').onclick = () => showStudentAnswerReview(studentName, testId, result);
                    div.querySelector('.fa-comment-dots').onclick = () => openChatModal(currentUser, studentName);
                    studentResultsContainer.appendChild(div);
                });
            }

            function showStudentAnswerReview(studentName, testId, result) {
                const test = myTests[testId], answers = result.answers; reviewModalTitle.textContent = `مراجعة إجابات: ${studentName}`; reviewModalBody.innerHTML = ''; reviewModalFooter.classList.add('hidden');
                if (result.status === 'pending' && test.questions.some(q => q.type === 'essay')) reviewModalFooter.classList.remove('hidden');
                test.questions.forEach((q, index) => {
                    const studentAnswer = answers[index] || {}; let reviewHtml = '';
                    if (q.type === 'mcq') { 
                        reviewHtml = '<div>' + q.options.map((option, i) => {
                            const optionNum = i + 1;
                            let classes = 'review-option';
                            if (optionNum === parseInt(q.correct)) {
                                classes += ' correct-answer-highlight';
                            }
                            if (studentAnswer.answer && parseInt(studentAnswer.answer) === optionNum && optionNum !== parseInt(q.correct)) {
                                classes += ' incorrect-answer-highlight';
                            }
                            return `<div class="${classes}">${option}</div>`;
                        }).join('') + '</div>';
                    } 
                    else { const studentText = studentAnswer.textAnswer || '<em>لم يقدم إجابة نصية.</em>', studentImage = studentAnswer.imageAnswer ? `<p><b>صورته:</b></p><img src="${studentAnswer.imageAnswer}" style="max-width:80%; border-radius:8px; cursor:pointer;">` : '', modelImage = q.modelAnswerImage ? `<p><b>النموذجية:</b></p><img src="${q.modelAnswerImage}" style="max-width:80%; border-radius:8px; cursor:pointer;">` : ''; let gradingInput = (result.status === 'pending') ? `<div style="margin-top:15px; text-align: left; display:flex; align-items:center; gap:10px;"><label for="grade-q-${index}" style="margin:0;"><b>ضع الدرجة:</b></label><input type="number" id="grade-q-${index}" data-question-index="${index}" class="essay-grade-input" min="0" max="${q.points || 1}" style="width:80px; margin:0;"><span>/ ${q.points || 1}</span></div>` : `<p><b>الدرجة النهائية للسؤال:</b> ${studentAnswer.pointsAwarded || 0}/${q.points || 1}</p>`; reviewHtml = `<div><p><b>إجابته النصية:</b></p><div style="background:var(--border-secondary); padding:10px; border-radius:8px; white-space: pre-wrap;">${studentText}</div>${studentImage}${modelImage}${gradingInput}</div>`; }
                    const qDiv = document.createElement('div'); qDiv.className = 'list-item';
                    qDiv.style.cssText = 'flex-direction: column; align-items: flex-start;';
                    qDiv.innerHTML = `<h4 style="margin-bottom:10px;">س ${index+1} (${q.points || 1} درجات): ${q.question}</h4>${q.image ? `<img class="question-image-preview" src="${q.image}">` : ''}${reviewHtml}`;
                    reviewModalBody.appendChild(qDiv);
                });
                finalizeGradesBtn.onclick = () => finalizeGrades(studentName, testId, test, result); reviewModal.classList.add('visible');
            }

            async function finalizeGrades(studentName, testId, test, originalResult) {
                let totalEssayScore = 0, allGraded = true; const updatedAnswers = [...originalResult.answers];
                reviewModalBody.querySelectorAll('.essay-grade-input').forEach(input => {
                    const questionIndex = parseInt(input.dataset.questionIndex), points = parseInt(input.value), maxPoints = test.questions[questionIndex].points || 1;
                    if (isNaN(points) || points < 0 || points > maxPoints) { showCustomAlert("خطأ", `الرجاء إدخال درجة صحيحة للسؤال المقالي رقم ${questionIndex + 1}.`); allGraded = false; return; }
                    totalEssayScore += points; updatedAnswers[questionIndex] = {...(updatedAnswers[questionIndex] || {type: 'essay'}), pointsAwarded: points};
                });
                if (!allGraded) return;
                const finalScore = originalResult.mcqScore + totalEssayScore, totalTestPoints = test.questions.reduce((sum, q) => sum + (q.points || 1), 0);
                const finalResult = { ...originalResult, score: `${finalScore} / ${totalTestPoints}`, status: 'graded', answers: updatedAnswers };
                try { await update(ref(db), { [`results/${currentUser}/${testId}/${studentName}`]: finalResult, [`studentResults/${studentName}/${testId}`]: finalResult }); showCustomAlert("نجاح", "تم حفظ الدرجات بنجاح."); reviewModal.classList.remove('visible'); loadStudentResultsForTest(testId); } catch (e) { showCustomAlert("خطأ", "حدث خطأ أثناء حفظ الدرجات."); }
            }
            reviewModal.querySelector('.modal-close-btn').onclick = () => reviewModal.classList.remove('visible');

            const populateResultsSelector = () => { resultsTestSelector.innerHTML = '<option value="">اختر اختبارًا</option>'; Object.entries(myTests).forEach(([testId, test]) => resultsTestSelector.innerHTML += `<option value="${testId}">${test.name}</option>`); };
            const handleImagePreview = (input, container, previewImg, storageVarSetter) => { const f=input.files[0]; if(f) getBase64(f).then(d=>{ storageVarSetter(d); previewImg.src=d; container.classList.remove('hidden'); }) };
            questionImageInput.onchange = () => handleImagePreview(questionImageInput, questionImageInput.nextElementSibling, questionImageInput.nextElementSibling.querySelector('img'), (val) => currentQuestionImageBase64 = val);
            modelAnswerImageInput.onchange = () => handleImagePreview(modelAnswerImageInput, modelAnswerImageInput.nextElementSibling, modelAnswerImageInput.nextElementSibling.querySelector('img'), (val) => currentModelAnswerImageBase64 = val);
            assessmentImageInput.onchange = () => handleImagePreview(assessmentImageInput, assessmentImageInput.nextElementSibling, assessmentImageInput.nextElementSibling.querySelector('img'), (val) => currentAssessmentImageBase64 = val);

            const renderQuestionsList = () => {
                questionsListContainer.innerHTML = questionsArray.length > 0 ? "<h3>الأسئلة المضافة:</h3>" : "";
                questionsArray.forEach((q, i) => {
                    const d=document.createElement('div'); d.className='list-item';
                    d.innerHTML=`<span style="flex-grow:1; text-align:right;">${i+1}. [${q.type==='mcq'?'اختياري':'مقالي'}] ${q.question ? q.question.substring(0,30) : 'سؤال بصورة'}... (${q.points} درجات)</span><div style="display:flex; gap: 5px;"><button data-index="${i}" class="action-btn btn-secondary edit-q-btn" title="تعديل"><i class="fas fa-edit"></i></button><button data-index="${i}" class="action-btn btn-secondary btn-danger delete-q-btn" title="حذف"><i class="fas fa-trash"></i></button></div>`;
                    questionsListContainer.appendChild(d);
                    d.querySelector('.delete-q-btn').onclick = () => { questionsArray.splice(i,1); renderQuestionsList(); };
                    d.querySelector('.edit-q-btn').onclick = () => startEditingQuestion(i);
                });
            };

            const startEditingQuestion = (index) => {
                const q = questionsArray[index];
                if (!q) return;
                currentEditingQuestionIndex = index;
                questionText.value = q.question || '';
                questionPointsInput.value = q.points || 1;
                
                const typeButton = teacherPortal.querySelector(`#question-type-switcher .switch-button[data-type="${q.type}"]`);
                if(typeButton) typeButton.click();

                currentQuestionImageBase64 = q.image || null;
                const qImgPreviewContainer = questionImageInput.nextElementSibling;
                if (q.image) {
                    qImgPreviewContainer.querySelector('img').src = q.image;
                    qImgPreviewContainer.classList.remove('hidden');
                } else {
                    qImgPreviewContainer.classList.add('hidden');
                }

                if (q.type === 'mcq') {
                    optionInputs.forEach((input, i) => input.value = q.options[i] || '');
                    currentCorrectAnswer = q.correct || 0;
                    mcqFields.querySelectorAll('.correct-answer-selector').forEach(sel => {
                        sel.classList.toggle('selected', parseInt(sel.dataset.index) === currentCorrectAnswer);
                    });
                } else if (q.type === 'essay') {
                    currentModelAnswerImageBase64 = q.modelAnswerImage || null;
                    const mImgPreviewContainer = modelAnswerImageInput.nextElementSibling;
                     if (q.modelAnswerImage) {
                        mImgPreviewContainer.querySelector('img').src = q.modelAnswerImage;
                        mImgPreviewContainer.classList.remove('hidden');
                    } else {
                        mImgPreviewContainer.classList.add('hidden');
                    }
                }

                addQuestionBtn.textContent = "تحديث السؤال";
                cancelQuestionEditBtn.classList.remove('hidden');
                questionText.scrollIntoView({ behavior: 'smooth' });
            };
            cancelQuestionEditBtn.onclick = clearQuestionForm;

            addQuestionBtn.onclick = () => {
                const q = questionText.value.trim(), points = parseInt(questionPointsInput.value);
                if ((!q && !currentQuestionImageBase64) || !points || points < 1) { showCustomAlert("خطأ", "يرجى كتابة نص السؤال أو إرفاق صورة، وتحديد درجة صحيحة للسؤال."); return; }
                
                let questionData = { question: q, type: currentQuestionType, image: currentQuestionImageBase64, points: points };
                
                if (currentQuestionType === 'mcq') {
                    const opts = Array.from(optionInputs).map(i => i.value.trim());
                    if (opts.some(o => o === "")) { showCustomAlert("خطأ", "يرجى ملء جميع الخيارات الأربعة."); return; }
                    if (currentCorrectAnswer === 0) { showCustomAlert("خطأ", "يرجى تحديد الإجابة الصحيحة بالضغط على علامة الصح."); return; }
                    questionData = { ...questionData, options: opts, correct: currentCorrectAnswer };
                } else { 
                    questionData.modelAnswerImage = currentModelAnswerImageBase64; 
                }
                
                if (currentEditingQuestionIndex > -1) {
                    questionsArray[currentEditingQuestionIndex] = questionData;
                } else {
                    questionsArray.push(questionData);
                }
                
                renderQuestionsList(); 
                clearQuestionForm();
            };

            saveTestBtn.onclick = (e) => {
                const button = e.target, originalText = button.textContent;
                const n = testNameInput.value.trim(), g = testGradeSelect.value, d = testDurationInput.value.trim();
                if (!n || !g || !d || questionsArray.length === 0) {
                    showCustomAlert("خطأ", "يرجى ملء تفاصيل الاختبار وإضافة سؤال واحد على الأقل.");
                    return;
                }
                button.disabled = true;
                button.textContent = "جاري الحفظ...";
                window.location.href = 'go:1';
                setTimeout(async () => {
                    const p = preventGoBackCheckbox.checked, s = shuffleQuestionsCheckbox.checked, f = fatefulTestCheckbox.checked;
                    const testData = { name: n, grade: g, duration: parseInt(d), preventGoBack: p, shuffle: s, fateful: f, questions: questionsArray, timestamp: Date.now() };
                    try {
                        if (currentEditingTestId) {
                            await set(ref(db, `tests/${currentUser}/${currentEditingTestId}`), testData);
                        } else {
                            await push(ref(db, `tests/${currentUser}`), testData);
                        }
                        showCustomAlert("نجاح", `تم ${currentEditingTestId ? 'تحديث' : 'حفظ'} الاختبار بنجاح!`);
                        resetCreateFormState();
                        setDefaultTab();
                    } catch (error) {
                        showCustomAlert("خطأ", "حدث خطأ أثناء الحفظ.");
                    } finally {
                        button.disabled = false;
                        button.textContent = originalText;
                    }
                }, 5000);
            };
            saveAssessmentBtn.onclick = async () => {
                const text = assessmentText.value.trim();
                if (!currentAssessmentImageBase64) {
                    showCustomAlert("خطأ", "الرجاء اختيار صورة للتقييم.");
                    return;
                }
                const assessmentData = {
                    imageUrl: currentAssessmentImageBase64,
                    text: text,
                    teacher: currentUser,
                    timestamp: serverTimestamp()
                };
                try {
                    await push(ref(db, 'assessments'), assessmentData);
                    showCustomAlert("نجاح", "تم حفظ التقييم بنجاح!");
                    // Clear form for next upload
                    assessmentImageInput.value = '';
                    assessmentText.value = '';
                    currentAssessmentImageBase64 = null;
                    assessmentImageInput.nextElementSibling.classList.add('hidden');
                    assessmentImageInput.nextElementSibling.querySelector('img').src = '#';
                } catch (e) {
                    showCustomAlert("خطأ", "حدث خطأ أثناء حفظ التقييم.");
                    console.error(e);
                }
            };
            
            async function authUser(name, password, isRegister) { 
                if (!name || !password) { showCustomAlert("خطأ", "الرجاء تعبئة كل الحقول"); return; }
                if (!/^[a-zA-Z0-9\s]+$/.test(name)) { showCustomAlert("خطأ", "الرجاء استخدام الحروف والأرقام الإنجليزية فقط في الاسم."); return; }
                const userRef = ref(db, `users/${name}`); const snapshot = await get(userRef); 
                if (isRegister) { if (snapshot.exists()) { showCustomAlert("خطأ", "اسم المستخدم هذا موجود بالفعل."); return; } await set(userRef, { password }); currentUser = name; } 
                else { if (!snapshot.exists() || snapshot.val().password !== password) { showCustomAlert("خطأ", "اسم المستخدم أو كلمة المرور غير صحيحة."); return; } currentUser = name; }
                localStorage.setItem("loggedInTeacher", currentUser); showSection(dashboardSection); updateDashboard(); 
            }
            
            teacherPortal.querySelector('#teacher-login-btn').onclick = () => authUser(teacherPortal.querySelector("#teacher-login-name").value.trim(), teacherPortal.querySelector("#teacher-login-password").value.trim(), false);
            teacherPortal.querySelector('#teacher-register-btn').onclick = () => authUser(teacherPortal.querySelector("#teacher-register-name").value.trim(), teacherPortal.querySelector("#teacher-register-password").value.trim(), true);
            
            menuIcon.addEventListener('click', () => dropdownMenu.classList.toggle('show'));
            document.addEventListener('click', (e) => { if (!menuIcon.contains(e.target) && !dropdownMenu.contains(e.target) && !e.target.closest('.theme-toggle-btn')) dropdownMenu.classList.remove('show'); });
            
            dropdownMenu.querySelector('#teacher-settings-btn').onclick = () => { dropdownMenu.classList.remove('show'); updateNameInput.value = currentUser; updatePasswordInput.value = ''; settingsModal.classList.add('visible'); };
            dropdownMenu.querySelector('#teacher-logout-btn').onclick = async () => { dropdownMenu.classList.remove('show'); if (await showCustomConfirm("تأكيد", "هل أنت متأكد من رغبتك في تسجيل الخروج؟")) { localStorage.clear(); sessionStorage.clear(); window.location.href = window.location.pathname; } };
            dropdownMenu.querySelector('#teacher-chat-btn').onclick = () => { dropdownMenu.classList.remove('show'); openChatList(teacherChatListModal, document.getElementById('teacher-chat-list-body'), 'teacher'); };
            dropdownMenu.querySelector('#teacher-share-platform-btn').onclick = () => { dropdownMenu.classList.remove('show'); sharePlatform(); };
            
            settingsModal.querySelector('.modal-close-btn').onclick = () => settingsModal.classList.remove('visible');
            resultsTestSelector.onchange = (e) => loadStudentResultsForTest(e.target.value);
            teacherPortal.querySelectorAll('.to-login').forEach(el=>el.onclick=e=>{e.preventDefault();showSection(loginSection)});
            teacherPortal.querySelectorAll('.to-register').forEach(el=>el.onclick=e=>{e.preventDefault();showSection(registerSection)});

            updateBtn.onclick = async () => {
                const newName = updateNameInput.value.trim(), newPassword = updatePasswordInput.value.trim();
                if (!newName) { showCustomAlert("خطأ", "لا يمكن أن يكون الاسم فارغًا."); return; }
                if (!/^[a-zA-Z0-9\s]+$/.test(newName)) { showCustomAlert("خطأ", "الرجاء استخدام الحروف والأرقام الإنجليزية فقط في الاسم."); return; }
                if (newName === currentUser && !newPassword) { settingsModal.classList.remove('visible'); return; }
                try {
                    const updates = {}; if(newPassword) updates.password = newPassword;
                    if (newName !== currentUser) {
                        if ((await get(ref(db, `users/${newName}`))).exists()) { showCustomAlert("خطأ", "هذا الاسم مستخدم بالفعل."); return; }
                        const oldData = (await get(ref(db, `users/${currentUser}`))).val();
                        const dataToMove = { [`users/${newName}`]: { ...oldData, ...updates }, [`users/${currentUser}`]: null };
                        for (const path of ['tests', 'results', 'messageLimits', 'assessments']) {
                            const snap = await get(ref(db, `${path}/${currentUser}`));
                            if (snap.exists()) { dataToMove[`${path}/${newName}`] = snap.val(); dataToMove[`${path}/${currentUser}`] = null; }
                        }
                        await update(ref(db), dataToMove);
                        localStorage.setItem('loggedInTeacher', newName); 
                        showCustomAlert("نجاح", "تم تحديث الحساب بنجاح! سيتم إعادة تحميل الصفحة.");
                        setTimeout(() => window.location.href = window.location.pathname, 1500);
                    } else { await update(ref(db, `users/${currentUser}`), updates); showCustomAlert("نجاح", "تم تحديث كلمة المرور بنجاح!"); settingsModal.classList.remove('visible'); }
                } catch (e) { showCustomAlert("خطأ", "حدث خطأ أثناء تحديث الحساب."); }
            };
        }

        async function initStudentApp() {
            const allSections=studentPortal.querySelectorAll('section'),[registerSection,loginSection,dashboard,takeTest,result,review]=allSections, nameSpan=studentPortal.querySelector('#student-name');
            const portalHeader = studentPortal.querySelector('.portal-header-controls'), menuIcon = studentPortal.querySelector('#student-menu-icon'), dropdownMenu = studentPortal.querySelector('#student-dropdown-menu');
            const settingsModal = studentPortal.querySelector('#student-settings-modal');
            const testsContainer=studentPortal.querySelector('#available-tests-container'), resultsContainer=studentPortal.querySelector('#my-student-results-container'), searchBar=studentPortal.querySelector('#search-bar');
            const timerDisplay=studentPortal.querySelector('#timer'), timerProgress=studentPortal.querySelector('#timer-progress'), testTitle=studentPortal.querySelector('#current-test-title'), questionsDisplay=studentPortal.querySelector('#questions-display');
            const finalScore=studentPortal.querySelector('#final-score'), feedbackMsg=studentPortal.querySelector('#feedback-message'), topNav=studentPortal.querySelector('#student-top-nav');
            const qNavContainer=studentPortal.querySelector('#question-navigation-container'), [prevQBtn,nextQBtn]=[studentPortal.querySelector('#prev-question-btn'),studentPortal.querySelector('#next-question-btn')], submitBtn=studentPortal.querySelector('#submit-test-btn');
            const reviewContainer=studentPortal.querySelector('#review-container'), updateNameInput = studentPortal.querySelector('#student-update-name'), updatePasswordInput = studentPortal.querySelector('#student-update-password'), updateBtn = studentPortal.querySelector('#student-update-btn');
            const showSearchBtn = studentPortal.querySelector('#show-search-btn');
            const refreshBtn = studentPortal.querySelector('#refresh-tests-btn');
            const backToDashboardBtn = studentPortal.querySelector('#back-to-dashboard-btn');
            const backFromReviewBtn = studentPortal.querySelector('#back-to-dashboard-from-review-btn');
            const assessmentsContainer = document.getElementById('assessments-container');
            const backFromAssessmentsBtn = document.getElementById('back-to-dashboard-from-assessments-btn');
            const groupChatBody = document.getElementById('group-chat-body');
            const groupChatMessageInput = document.getElementById('group-chat-message-input');
            const sendGroupChatMessageBtn = document.getElementById('send-group-chat-message-btn');
            const messageContextMenu = document.getElementById('message-context-menu');
            let currentMessageElementForMenu = null;


            let currentStudent=null,takenTests={},allTests={},currentTest=null,testInterval=null,totalSec=0,remainSec=0,answers=[], qIndex=0, isDeepLinkSession = false;

            async function showLastSubmittedResult({ testId, teacherId }) {
                const testRef = ref(db, `tests/${teacherId}/${testId}`);
                const testSnap = await get(testRef);
                if (!testSnap.exists()) {
                    sessionStorage.removeItem('lastSubmittedTest');
                    showSection(dashboard);
                    loadDashboard();
                    return;
                }
                currentTest = { ...testSnap.val(), id: testId, teacherId, isPractice: false };

                const resultRef = ref(db, `studentResults/${currentStudent}/${testId}`);
                const resultSnap = await get(resultRef);
                if (!resultSnap.exists()) {
                     sessionStorage.removeItem('lastSubmittedTest');
                     showSection(dashboard);
                     loadDashboard();
                     return;
                }
                const resultData = resultSnap.val();
                finalScore.textContent = `درجتك: ${resultData.score}`;

                if (resultData.status === 'pending') {
                    feedbackMsg.style.cssText = "background: rgba(255, 193, 7, 0.2); color: var(--warning-primary);";
                    feedbackMsg.textContent = "تم إرسال إجاباتك المقالية للمراجعة! هذه نتيجتك المبدئية.";
                } else {
                    const finalScoreValue = parseFloat(resultData.score.split('/')[0]);
                    const totalTestPoints = parseFloat(resultData.score.split('/')[1]);
                    const percentage = totalTestPoints > 0 ? (finalScoreValue / totalTestPoints) * 100 : 0;
                    feedbackMsg.style.background = 'var(--bg-tertiary)';
                    feedbackMsg.style.color = 'var(--text-primary)';
                    feedbackMsg.style.textAlign = 'center';
                    if (percentage < 60) {
                        feedbackMsg.innerHTML = `
                            <p style="margin-bottom: 10px;">يا لهوي اعمل ايه معاك تاني بقى... حاول تحسن من نفسك شويه</p>
                            <img src="https://i.postimg.cc/HntKF5f2/download-13.png" style="max-width: 150px; border-radius: 8px;">
                        `;
                    } else {
                        feedbackMsg.innerHTML = `
                            <p style="margin-bottom: 10px;">مش بطال يلا ماشي</p>
                            <img src="https://i.postimg.cc/2862CPvY/download-12.png" style="max-width: 150px; border-radius: 8px;">
                        `;
                    }
                }
                showSection(result);
            }
            
            const loggedInUser = localStorage.getItem('loggedInStudent');
            if(loggedInUser){
                currentStudent = loggedInUser;
                const lastSubmittedJSON = sessionStorage.getItem('lastSubmittedTest');
                const savedExamStateJSON = sessionStorage.getItem('activeExamState');
                if (lastSubmittedJSON) {
                    showLastSubmittedResult(JSON.parse(lastSubmittedJSON));
                } else if (savedExamStateJSON) {
                    const savedState = JSON.parse(savedExamStateJSON);
                    if (await showCustomConfirm("استئناف الامتحان", `لديك امتحان "${savedState.currentTest.name}" غير مكتمل. هل تود استئنافه؟`)) {
                        resumeTest(savedState);
                    } else {
                        sessionStorage.removeItem('activeExamState');
                        showSection(dashboard);
                        loadDashboard();
                    }
                } else if (sessionStorage.getItem('deepLinkTest')) {
                    startDeepLinkTest();
                } else {
                    showSection(dashboard);
                    loadDashboard();
                }
            } else {
                showSection(loginSection);
            }

            function showSection(s){
                allSections.forEach(e=>e.classList.add('hidden'));
                if(s) s.classList.remove('hidden');
                const isDashboard = s && s.id==='student-dashboard-section';
                topNav.classList.toggle('hidden', !isDashboard || isDeepLinkSession);
                portalHeader.classList.toggle('hidden', !isDashboard || isDeepLinkSession);
                studentPortal.classList.toggle('auth-view', s === loginSection || s === registerSection);
            };
            const showLoading=c=>{c.innerHTML='<div class="spinner"></div>'};
            
            async function loadDashboard(){
                if(!currentStudent)return;
                nameSpan.textContent=currentStudent;
                setDefaultTab();
                showLoading(testsContainer);
                showLoading(resultsContainer);
                refreshBtn.classList.add('loading');
                const resultsSnap=await get(ref(db,`studentResults/${currentStudent}`));
                takenTests=resultsSnap.exists()?resultsSnap.val():{};
                renderStudentResults();
                const testsRef=ref(db,'tests');
                onValue(testsRef,snap=>{
                    allTests=snap.exists()?snap.val():{};
                    renderAvailableTests();
                    refreshBtn.classList.remove('loading');
                }); 
                initChatSystem(currentStudent, 'student'); 
                initGroupChat();
                loadAssessments();
            }
            
            refreshBtn.onclick = () => {
                 refreshBtn.classList.add('loading');
                 loadDashboard();
            };

            function renderAvailableTests(filter=''){
                testsContainer.innerHTML='<div class="spinner"></div>';
                let found=false;
                const testEntries = [];
                Object.entries(allTests).forEach(([teacherId, teacherTests]) => {
                    Object.entries(teacherTests)
                        .filter(([testId, test]) => (Date.now() - test.timestamp < 48 * 60 * 60 * 1000))
                        .forEach(([testId, test]) => { testEntries.push({ teacherId, testId, test }); }); 
                });
                
                testsContainer.innerHTML='';
                if (testEntries.length === 0) {
                     testsContainer.innerHTML='<div style="text-align:center; padding: 40px 0;"><p>لا توجد اختبارات متاحة حاليًا.</p><button id="center-refresh-btn" class="btn-secondary" style="width:auto; padding: 10px 20px !important;">تحديث</button></div>';
                     document.getElementById('center-refresh-btn').onclick = loadDashboard;
                     refreshBtn.style.display = 'none';
                     return;
                }
                refreshBtn.style.display = 'flex';

                testEntries.sort((a, b) => b.test.timestamp - a.test.timestamp);

                testEntries.forEach(({teacherId, testId, test}) => {
                    const isTaken = !!takenTests[testId];
                    const searchStr = `${test.name}${test.grade}${teacherId}`.toLowerCase();
                    if(filter && !searchStr.includes(filter.toLowerCase())) return;
                    found = true;

                    const itemContainer = document.createElement('div');
                    itemContainer.className = 'student-test-item-container';

                    const actionsBar = document.createElement('div');
                    actionsBar.className = 'student-test-actions-bar';

                    const startOrReviewIcon = document.createElement('div');
                    startOrReviewIcon.className = 'action-icon';
                    startOrReviewIcon.innerHTML = isTaken ? `<i class="fas fa-poll-h"></i>` : `<i class="fas fa-play"></i>`;
                    startOrReviewIcon.title = isTaken ? 'مراجعة النتيجة' : 'ابدأ الاختبار';
                    startOrReviewIcon.onclick = () => isTaken ? openStudentReview(testId) : startTest(teacherId, testId, test, false);
                    
                    const retakeIcon = document.createElement('div');
                    retakeIcon.className = 'action-icon';
                    retakeIcon.innerHTML = `<i class="fas fa-redo"></i>`;
                    retakeIcon.title = 'إعادة (تدريب)';
                    retakeIcon.style.display = isTaken ? 'flex' : 'none';
                    retakeIcon.onclick = () => startTest(teacherId, testId, test, true);

                    const teacherIcon = document.createElement('div');
                    teacherIcon.className = 'action-icon';
                    teacherIcon.innerHTML = `<i class="fas fa-chalkboard-teacher"></i>`;
                    teacherIcon.title = `مراسلة ${teacherId}`;
                    teacherIcon.onclick = (e) => { e.stopPropagation(); openChatModal(currentStudent, teacherId); };

                    const shareIcon = document.createElement('div');
                    shareIcon.className = 'action-icon';
                    shareIcon.innerHTML = `<i class="fas fa-share-alt"></i>`;
                    shareIcon.title = 'مشاركة رابط الاختبار';
                    shareIcon.onclick = (e) => { e.stopPropagation(); shareTest(test.name); };

                    actionsBar.append(startOrReviewIcon, retakeIcon, teacherIcon, shareIcon);
                    
                    const card = document.createElement('div');
                    card.className = 'student-test-card';
                    
                    const expiryTime = new Date(test.timestamp + 48 * 60 * 60 * 1000);
                    const formattedExpiry = `ينتهي: ${expiryTime.toLocaleDateString('ar-EG')} ${expiryTime.toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit'})}`;

                    card.innerHTML = `
                        <div class="test-main-info">
                            <span class="test-grade-badge">${test.grade || 'عام'}</span>
                            <div class="test-name" title="${test.name}">${test.name}</div>
                        </div>
                        <div class="test-expiry">${formattedExpiry}</div>`;
                    
                    itemContainer.append(actionsBar, card);
                    testsContainer.appendChild(itemContainer);
                });
                if(!found && filter) testsContainer.innerHTML='<p>لا توجد نتائج مطابقة لبحثك.</p>';
            }

            function renderStudentResults(){resultsContainer.innerHTML='';const results=Object.values(takenTests).sort((a,b)=>b.timestamp-a.timestamp);if(results.length===0){resultsContainer.innerHTML='<p>لم تقم بإجراء أي اختبار بعد.</p>';return}results.forEach(r=>{const d=new Date(r.timestamp).toLocaleString('ar-EG'), pendingIndicator = r.status === 'pending' ? `<span style="color:var(--warning-primary); font-weight:bold; font-size: 0.8rem;">(قيد المراجعة)</span>` : '';const div=document.createElement('div');div.className='test-item';div.innerHTML=`<div style="text-align:right; flex-grow:1;"><strong>${r.testName}</strong><br><small>الدرجة: <strong>${r.score}</strong> ${pendingIndicator}</small></div><small>${d}</small>`;resultsContainer.appendChild(div)})}
            
            function startTest(teacherId, testId, testData, isPractice = false) {
                if (isDeepLinkSession) {
                    topNav.classList.add('hidden');
                    portalHeader.classList.add('hidden');
                }
                if (!testData.questions || testData.questions.length === 0) {
                    showCustomAlert("خطأ", "هذا الاختبار لا يحتوي على أسئلة ولا يمكن بدؤه.");
                    return;
                }
                currentTest = { ...testData, id: testId, teacherId, isPractice };
                if (currentTest.shuffle) currentTest.questions.sort(() => Math.random() - 0.5);
                totalSec = currentTest.duration * 60;
                remainSec = totalSec;
                answers = new Array(currentTest.questions.length).fill(null);
                qIndex = 0;
                
                setupTestUI();
            }

            function resumeTest(savedState) {
                currentTest = savedState.currentTest;
                remainSec = savedState.remainSec;
                totalSec = currentTest.duration * 60;
                answers = savedState.answers;
                qIndex = savedState.qIndex;
                isDeepLinkSession = savedState.isDeepLinkSession;
                
                setupTestUI();
            }

            function setupTestUI() {
                testTitle.textContent = currentTest.name + (currentTest.isPractice ? ' (وضع التدريب)' : '');
                
                if (testInterval) clearInterval(testInterval);
                testInterval = setInterval(() => {
                    remainSec--;
                    timerDisplay.textContent = formatTime(remainSec);
                    timerProgress.style.width = ((remainSec / totalSec) * 100) + '%';
                    
                    sessionStorage.setItem('activeExamState', JSON.stringify({
                        currentTest, remainSec, answers, qIndex, isDeepLinkSession
                    }));

                    if (remainSec <= 0) {
                        clearInterval(testInterval);
                        submitTest(true);
                    }
                }, 1000);

                if (currentTest.preventGoBack) {
                    submitBtn.classList.add('hidden');
                    qNavContainer.classList.remove('hidden');
                    renderQuestion(qIndex);
                } else {
                    submitBtn.classList.remove('hidden');
                    qNavContainer.classList.add('hidden');
                    renderAllQuestions();
                }
                showSection(takeTest);
            }

            async function openStudentReview(testId) {
                const result = takenTests[testId]; if (!result) return;
                const testRef = ref(db, `tests/${result.teacherName}/${testId}`), testSnap = await get(testRef);
                if (!testSnap.exists()) { showCustomAlert('خطأ', 'لم يعد هذا الاختبار متاحًا للمراجعة.'); return; }
                renderReview(testSnap.val(), result.answers);
                showSection(review);
            }

            function renderAllQuestions(){questionsDisplay.innerHTML='';currentTest.questions?.forEach((q,idx)=>{const qDiv=document.createElement('div');qDiv.style.marginBottom='25px';let ansHtml='';const savedAns=answers[idx];if(q.type==='mcq'){ansHtml=`<div class="question-options">${q.options.map((o,i)=>{const checked=savedAns&&savedAns.answer===(i+1)?'checked':'';return`<label><input type="radio" name="question-${idx}" value="${i+1}" onchange="saveAnswer(${idx},this.value,'mcq')" ${checked}><span>${o}</span></label>`}).join('')}</div>`}else{const textVal=savedAns&&savedAns.textAnswer?savedAns.textAnswer:'';const imgUploaded=savedAns&&savedAns.imageAnswer;ansHtml=`<div><label>إجابتك:</label><textarea id="text-answer-${idx}" oninput="saveAnswer(${idx}, this.value, 'essay-text')">${textVal}</textarea><label for="image-answer-${idx}" class="file-input-label"><i class="fas ${imgUploaded?'fa-check-circle':'fa-upload'}"></i> ${imgUploaded?'تم الرفع':'رفع صورة'}</label><input type="file" id="image-answer-${idx}" accept="image/*" class="hidden" onchange="handleEssayImageUpload(${idx}, this)"></div>`}qDiv.innerHTML=`<h4 style="text-align:right;margin-bottom:15px;">س ${idx+1}: ${q.question}</h4>${q.image?`<img class="question-image-preview" src="${q.image}">`:''}${ansHtml}`;questionsDisplay.appendChild(qDiv)})}
            function renderQuestion(index){const q=currentTest.questions[index];let ansHtml='';const saved=answers[index];if(q.type==='mcq'){ansHtml=`<div class="question-options">${q.options.map((o,i)=>{const checked=saved&&saved.answer===(i+1)?'checked':'';return`<label><input type="radio" name="question-${index}" value="${i+1}" ${checked}/><span>${o}</span></label>`}).join('')}</div>`}else{const text=saved&&saved.textAnswer?saved.textAnswer:'';const uploaded=saved&&saved.imageAnswer;ansHtml=`<div><label>إجابتك:</label><textarea id="text-answer-${index}">${text}</textarea><label for="image-answer-${index}" class="file-input-label"><i class="fas ${uploaded?'fa-check-circle':'fa-upload'}"></i> ${uploaded?'تغيير الصورة':'رفع صورة'}</label><input type="file" id="image-answer-${index}" accept="image/*" class="hidden"></div>`}questionsDisplay.innerHTML=`<h4 style="margin-bottom:15px;">س ${index+1}/${currentTest.questions.length}: ${q.question}</h4>${q.image?`<img class="question-image-preview" src="${q.image}">`:''}${ansHtml}`;if(q.type==='essay'){document.getElementById(`image-answer-${index}`).onchange=()=>handleEssayImageUpload(index,document.getElementById(`image-answer-${index}`))}prevQBtn.disabled=index===0;nextQBtn.classList.toggle('hidden',index===currentTest.questions.length-1);submitBtn.classList.toggle('hidden',index!==currentTest.questions.length-1)}
            
            window.saveAnswer=(idx,val,type)=>{if(type==='mcq')answers[idx]={type:'mcq',answer:parseInt(val)};else if(type==='essay-text'){if(!answers[idx])answers[idx]={type:'essay'};answers[idx].textAnswer=val}};
            window.handleEssayImageUpload=async(idx,input)=>{const file=input.files[0];if(file){const b64=await getBase64(file);if(!answers[idx])answers[idx]={type:'essay'};answers[idx].imageAnswer=b64;input.previousElementSibling.innerHTML=`<i class="fas fa-check-circle"></i> تم الرفع!`}};
            function saveCurrentAnswer(){const q=currentTest.questions[qIndex];if(q.type==='mcq'){const c=questionsDisplay.querySelector(`input[name="question-${qIndex}"]:checked`);if(c)answers[qIndex]={type:'mcq',answer:parseInt(c.value)}}else{const t=questionsDisplay.querySelector(`#text-answer-${qIndex}`).value;if(t.trim()!==''||(answers[qIndex]&&answers[qIndex].imageAnswer)){if(!answers[qIndex])answers[qIndex]={type:'essay'};answers[qIndex].textAnswer=t}}}
            nextQBtn.onclick=()=>{if(qIndex<currentTest.questions.length-1){saveCurrentAnswer();qIndex++;renderQuestion(qIndex)}};
            prevQBtn.onclick=()=>{if(qIndex>0){saveCurrentAnswer();qIndex--;renderQuestion(qIndex)}};
            
            async function submitTest(timeUp=false){
                sessionStorage.removeItem('activeExamState'); 
                clearInterval(testInterval);
                if(timeUp) showCustomAlert('انتهى الوقت!','تم تسليم إجاباتك الحالية.');
                if(currentTest.preventGoBack) saveCurrentAnswer();
                let mcqScore = 0;
                const hasEssays = currentTest.questions.some(q => q.type === 'essay');
                const totalTestPoints = currentTest.questions.reduce((s, q) => s + (q.points || 1), 0);
                
                currentTest.questions.forEach((q, idx) => {
                    if (q.type === 'mcq') { 
                        if (answers[idx] && parseInt(answers[idx].answer) === parseInt(q.correct)) {
                            mcqScore += (q.points || 1);
                        }
                    }
                });
                
                const scoreString = hasEssays ? `${mcqScore} / ${totalTestPoints} (مبدئي)` : `${mcqScore} / ${totalTestPoints}`;
                finalScore.textContent = `درجتك: ${scoreString}`;
                
                const promptShown = localStorage.getItem('appInstallPromptShown');
                if (!currentTest.isPractice && !promptShown) {
                    appInstallPrompt.classList.add('show');
                    localStorage.setItem('appInstallPromptShown', 'true');
                }

                if(currentTest.isPractice){
                    feedbackMsg.style.cssText = "background: #17a2b8; color: #fff;";
                    feedbackMsg.textContent = "هذه نتيجة تدريبك. لن يتم حفظ هذه الدرجة.";
                } else {
                    const resultObj = { testId: currentTest.id, testName: currentTest.name, teacherName: currentTest.teacherId, timestamp: serverTimestamp(), answers: answers, mcqScore: mcqScore, status: hasEssays ? 'pending' : 'graded', score: scoreString };
                    await set(ref(db, `studentResults/${currentStudent}/${currentTest.id}`), resultObj); 
                    await set(ref(db, `results/${currentTest.teacherId}/${currentTest.id}/${currentStudent}`), resultObj);
                    takenTests[currentTest.id] = { ...resultObj, timestamp: Date.now() }; // Add timestamp for local sorting
                    
                    sessionStorage.setItem('lastSubmittedTest', JSON.stringify({
                        testId: currentTest.id,
                        teacherId: currentTest.teacherId
                    }));
                    
                    if (hasEssays) { 
                        feedbackMsg.style.cssText = "background: rgba(255, 193, 7, 0.2); color: var(--warning-primary);"; 
                        feedbackMsg.textContent = "تم إرسال إجاباتك المقالية للمراجعة! هذه نتيجتك المبدئية."; 
                    } else { 
                        const percentage = totalTestPoints > 0 ? (mcqScore / totalTestPoints) * 100 : 0;
                        feedbackMsg.style.background = 'var(--bg-tertiary)';
                        feedbackMsg.style.color = 'var(--text-primary)';
                        feedbackMsg.style.textAlign = 'center';
                        if (percentage < 60) {
                            feedbackMsg.innerHTML = `
                                <p style="margin-bottom: 10px;">يا لهوي اعمل ايه معاك تاني بقى... حاول تحسن من نفسك شويه</p>
                                <img src="https://i.postimg.cc/HntKF5f2/download-13.png" style="max-width: 150px; border-radius: 8px;">
                            `;
                        } else {
                            feedbackMsg.innerHTML = `
                                <p style="margin-bottom: 10px;">مش بطال يلا ماشي</p>
                                <img src="https://i.postimg.cc/2862CPvY/download-12.png" style="max-width: 150px; border-radius: 8px;">
                            `;
                        }
                    }
                }

                if (isDeepLinkSession) {
                    backToDashboardBtn.textContent = 'الخروج';
                    backFromReviewBtn.textContent = 'الخروج';
                } else {
                    backToDashboardBtn.textContent = 'العودة للرئيسية';
                    backFromReviewBtn.textContent = 'العودة';
                }

                showSection(result);
            }
            submitBtn.onclick=async (e)=>{ 
                const button = e.target;
                if (await showCustomConfirm('تأكيد التسليم', 'هل أنت متأكد من رغبتك في تسليم الاختبار؟')) { 
                    button.disabled = true;
                    submitTest(false);
                    button.disabled = false;
                } 
            };
            
            const handleExitTestSession = () => {
                window.location.href = 'go:1';
                setTimeout(() => {
                    sessionStorage.removeItem('lastSubmittedTest');
                    if (isDeepLinkSession) {
                        localStorage.removeItem('loggedInStudent');
                        sessionStorage.clear();
                        window.location.href = window.location.pathname;
                    } else {
                        showSection(dashboard);
                        loadDashboard();
                    }
                }, 7000);
            };

            function renderReview(testData, studentAnswers){
                reviewContainer.innerHTML = '';
                testData.questions.forEach((q,i) => {
                    const ans = studentAnswers[i] || {};
                    let html='';
                    if (q.type === 'mcq') {
                        html = '<div>' + q.options.map((option, idx) => {
                            const optionNum = idx + 1;
                            let classes = 'review-option';
                            // Check if this option is the correct answer
                            if (optionNum === parseInt(q.correct)) {
                                classes += ' correct-answer-highlight';
                            }
                            // Check if this option was the student's incorrect answer
                            if (ans.answer && parseInt(ans.answer) === optionNum && parseInt(ans.answer) !== parseInt(q.correct)) {
                                classes += ' incorrect-answer-highlight';
                            }
                            return `<div class="${classes}">${option}</div>`;
                        }).join('') + '</div>';
                    } else { // Essay
                        const txt = ans.textAnswer || '<em>لم تقدم إجابة نصية.</em>';
                        const img = ans.imageAnswer ? `<p><b>صورتك:</b></p><img src="${ans.imageAnswer}" style="max-width:80%;border-radius:8px; cursor:pointer;">` : '';
                        const model = q.modelAnswerImage ? `<p><b>الإجابة النموذجية:</b></p><img src="${q.modelAnswerImage}" style="max-width:80%;border-radius:8px; cursor:pointer;">` : '';
                        html=`<div><p><b>إجابتك النصية:</b></p><div style="background:var(--border-secondary);padding:10px;border-radius:8px; white-space:pre-wrap;">${txt}</div>${img}${model}</div>`;
                    }
                    const qDiv = document.createElement('div');
                    qDiv.className = 'list-item';
                    qDiv.style.cssText = 'flex-direction: column; align-items: flex-start;';
                    qDiv.innerHTML = `<h4 style="margin-bottom:10px;">س ${i+1}: ${q.question}</h4>${q.image ? `<img class="question-image-preview" src="${q.image}">` : ''}${html}`;
                    reviewContainer.appendChild(qDiv);
                });
            }
            
            async function authUser(name,pass,isRegister){
                if(!name||!pass) { showCustomAlert('خطأ','الرجاء ملء جميع الحقول'); return; }
                if (!/^[a-zA-Z0-9\s]+$/.test(name)) { showCustomAlert("خطأ", "الرجاء استخدام الحروف والأرقام الإنجليزية فقط في الاسم."); return; }
                const userRef=ref(db,`students/${name}`); const snap=await get(userRef);
                if(isRegister){ if(snap.exists()) { showCustomAlert('خطأ','اسم المستخدم موجود.'); return; } await set(userRef,{password:pass}); currentStudent = name; } 
                else { if(!snap.exists()||snap.val().password!==pass) { showCustomAlert('خطأ','بيانات الدخول غير صحيحة.'); return; } currentStudent=name; }
                localStorage.setItem('loggedInStudent',currentStudent);
                if(sessionStorage.getItem('deepLinkTest')){await startDeepLinkTest()}else{showSection(dashboard);loadDashboard()}
            }

            async function startDeepLinkTest(){
                isDeepLinkSession = true;
                const dataJSON=sessionStorage.getItem('deepLinkTest');
                if(!dataJSON)return;
                const{teacherId,testId}=JSON.parse(dataJSON);
                sessionStorage.removeItem('deepLinkTest');
                const testRef=ref(db,`tests/${teacherId}/${testId}`);
                const testSnap=await get(testRef);
                if(testSnap.exists()){
                    startTest(teacherId,testId,testSnap.val(), false)
                }else{
                    showCustomAlert('خطأ','الاختبار غير موجود أو لم يعد متاحًا.');
                    handleExitTestSession();
                }
            }
            
            async function loadAssessments() {
                assessmentsContainer.innerHTML = '<div class="spinner"></div>';
                const assessmentsRef = ref(db, 'assessments');
                const snapshot = await get(assessmentsRef);
                assessmentsContainer.innerHTML = '';
                if (snapshot.exists()) {
                    snapshot.forEach(childSnap => {
                        const assessment = childSnap.val();
                        const item = document.createElement('div');
                        item.className = 'list-item';
                        item.style.flexDirection = 'column';
                        item.style.alignItems = 'flex-start';
                        item.innerHTML = `
                            <img src="${assessment.imageUrl}" class="question-image-preview" style="max-height: 300px;">
                            ${assessment.text ? `<p style="text-align: right; margin-top: 10px; white-space: pre-wrap;">${assessment.text}</p>` : ''}
                            <small style="align-self: flex-end; color: var(--text-secondary); margin-top: 10px;">من: ${assessment.teacher}</small>
                        `;
                        assessmentsContainer.prepend(item); // Show newest first
                    });
                } else {
                    assessmentsContainer.innerHTML = '<p>لا توجد تقييمات متاحة حاليًا.</p>';
                }
            }
            backFromAssessmentsBtn.onclick = () => navButtons[0].click();


            const formatTime=s=>{const m=Math.floor(s/60),r=s%60;return`${m.toString().padStart(2,'0')}:${r.toString().padStart(2,'0')}`};
            
            const navButtons=studentPortal.querySelectorAll('.nav-btn');
            navButtons.forEach(b=>{b.addEventListener('click',()=>{navButtons.forEach(btn=>btn.classList.remove('active'));studentPortal.querySelectorAll('.tab-content').forEach(c=>c.classList.add('hidden'));b.classList.add('active');studentPortal.querySelector(`#${b.dataset.target}`).classList.remove('hidden');})});
            const setDefaultTab=()=>navButtons[0].click();
            studentPortal.querySelector('#student-register-btn').onclick=()=>authUser(studentPortal.querySelector('#student-register-name').value.trim(),studentPortal.querySelector('#student-register-password').value.trim(),true);
            studentPortal.querySelector('#student-login-btn').onclick=()=>authUser(studentPortal.querySelector('#student-login-name').value.trim(),studentPortal.querySelector('#student-login-password').value.trim(),false);
            studentPortal.querySelectorAll('.to-login').forEach(el=>el.onclick=e=>{e.preventDefault();showSection(loginSection)});
            studentPortal.querySelectorAll('.to-register').forEach(el=>el.onclick=e=>{e.preventDefault();showSection(registerSection)});
            backToDashboardBtn.onclick = handleExitTestSession;
            studentPortal.querySelector('#cancel-test-btn').onclick= async ()=>{ if(await showCustomConfirm('تأكيد', 'هل أنت متأكد من إلغاء الاختبار؟ لن يتم حفظ تقدمك.')){ clearInterval(testInterval); sessionStorage.removeItem('activeExamState'); handleExitTestSession(); } };
            studentPortal.querySelector('#review-answers-btn').onclick = () => { if (currentTest.isPractice) { renderReview(currentTest, answers); showSection(review); } else { openStudentReview(currentTest.id); } };
            backFromReviewBtn.onclick = handleExitTestSession;
            
            showSearchBtn.addEventListener('click', () => {
                searchBar.classList.toggle('hidden');
                showSearchBtn.classList.toggle('active');
                if (!searchBar.classList.contains('hidden')) {
                    searchBar.focus();
                } else {
                    renderAvailableTests('');
                    searchBar.value = '';
                }
            });
            searchBar.addEventListener('input',e=>renderAvailableTests(e.target.value));
            
            menuIcon.addEventListener('click', () => dropdownMenu.classList.toggle('show'));
            document.addEventListener('click', (e) => { 
                if (!menuIcon.contains(e.target) && !dropdownMenu.contains(e.target) && !e.target.closest('.theme-toggle-btn')) {
                    dropdownMenu.classList.remove('show'); 
                }
                if (!e.target.closest('.message-context-menu') && !e.target.closest('.group-chat-message')) {
                    messageContextMenu.style.display = 'none';
                }
            });
            
            dropdownMenu.querySelector('#student-settings-btn').onclick = () => { dropdownMenu.classList.remove('show'); updateNameInput.value = currentStudent; updatePasswordInput.value = ''; settingsModal.classList.add('visible'); };
            dropdownMenu.querySelector('#student-logout-btn').onclick = async () => { dropdownMenu.classList.remove('show'); if (await showCustomConfirm("تأكيد", "هل أنت متأكد من رغبتك في تسجيل الخروج؟")) { localStorage.clear(); sessionStorage.clear(); window.location.href = window.location.pathname; } };
            dropdownMenu.querySelector('#student-chat-btn').onclick = () => { dropdownMenu.classList.remove('show'); openChatList(studentChatListModal, document.getElementById('student-chat-list-body'), 'student'); };
            dropdownMenu.querySelector('#student-share-platform-btn').onclick = () => { dropdownMenu.classList.remove('show'); sharePlatform(); };
            
            settingsModal.querySelector('.modal-close-btn').onclick = () => settingsModal.classList.remove('visible');
            
            updateBtn.onclick = async () => {
                const newName = updateNameInput.value.trim(), newPassword = updatePasswordInput.value.trim();
                if (!newName) { showCustomAlert("خطأ", "لا يمكن أن يكون الاسم فارغًا."); return; }
                if (!/^[a-zA-Z0-9\s]+$/.test(newName)) { showCustomAlert("خطأ", "الرجاء استخدام الحروف والأرقام الإنجليزية فقط في الاسم."); return; }
                if (newName === currentStudent && !newPassword) { settingsModal.classList.remove('visible'); return; }
                try {
                    const updates = {}; if(newPassword) updates.password = newPassword;
                    if (newName !== currentStudent) {
                        if ((await get(ref(db, `students/${newName}`))).exists()) { showCustomAlert("خطأ", "هذا الاسم مستخدم بالفعل."); return; }
                        const oldData = (await get(ref(db, `students/${currentStudent}`))).val();
                        const dataToMove = { [`students/${newName}`]: { ...oldData, ...updates }, [`students/${currentStudent}`]: null };
                        for (const path of ['studentResults', 'messageLimits']) {
                            const snap = await get(ref(db, `${path}/${currentStudent}`));
                            if (snap.exists()) { dataToMove[`${path}/${newName}`] = snap.val(); dataToMove[`${path}/${currentStudent}`] = null; }
                        }
                        await update(ref(db), dataToMove);
                        localStorage.setItem('loggedInStudent', newName); 
                        showCustomAlert("نجاح", "تم تحديث الحساب بنجاح! سيتم إعادة تحميل الصفحة.");
                        setTimeout(() => window.location.href = window.location.pathname, 1500);
                    } else { await update(ref(db, `students/${currentStudent}`), updates); showCustomAlert("نجاح", "تم تحديث كلمة المرور بنجاح!"); settingsModal.classList.remove('visible'); }
                } catch (e) { showCustomAlert("خطأ", "حدث خطأ أثناء تحديث الحساب."); console.error(e) }
            };

            function initGroupChat() {
                const groupChatRef = ref(db, 'groupChat');
                onValue(groupChatRef, (snapshot) => {
                    groupChatBody.innerHTML = '';
                    if (snapshot.exists()) {
                        snapshot.forEach(childSnap => {
                            const msg = childSnap.val();
                            const msgKey = childSnap.key;
                            renderGroupMessage(msg, msgKey);
                        });
                    }
                    groupChatBody.scrollTop = groupChatBody.scrollHeight;
                });
            }

            sendGroupChatMessageBtn.onclick = () => {
                const text = groupChatMessageInput.value.trim();
                if (!text) return;
                const message = {
                    sender: currentStudent,
                    text: text,
                    timestamp: serverTimestamp()
                };
                push(ref(db, 'groupChat'), message);
                groupChatMessageInput.value = '';
            };
            
            function renderGroupMessage(msg, key) {
                const msgDiv = document.createElement('div');
                msgDiv.dataset.key = key;
                msgDiv.className = `group-chat-message ${msg.sender === currentStudent ? 'sent' : 'received'}`;
                
                if (msg.sender === currentStudent) {
                     msgDiv.innerHTML = `<div class="msg-text">${msg.text}</div>`;
                } else {
                    msgDiv.innerHTML = `
                        <div class="msg-sender"><i class="fas fa-user-circle"></i> ${msg.sender}</div>
                        <div class="msg-text">${msg.text}</div>
                    `;
                }

                msgDiv.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    currentMessageElementForMenu = e.currentTarget;
                    messageContextMenu.style.top = `${e.clientY}px`;
                    messageContextMenu.style.left = `${e.clientX}px`;
                    messageContextMenu.style.display = 'block';
                });
                groupChatBody.appendChild(msgDiv);
            }

            messageContextMenu.addEventListener('click', (e) => {
                const action = e.target.dataset.action;
                if (!currentMessageElementForMenu) return;

                if (action === 'reply') {
                    const sender = currentMessageElementForMenu.querySelector('.msg-sender')?.textContent.trim() || 'أنا';
                    const text = currentMessageElementForMenu.querySelector('.msg-text').textContent;
                    groupChatMessageInput.value = `ردًا على (${sender}): "${text.substring(0, 20)}..." \n`;
                    groupChatMessageInput.focus();
                } else if (action === 'delete') {
                    currentMessageElementForMenu.remove();
                }
            });


        }

        async function shareTest(testName) {
            const shareText = `ابحث بهذا الاسم: ${testName}\nوهذا رابط التطبيق إذا لم يكن عندك: ${appUrl}`;
            try {
                if (navigator.share) {
                    await navigator.share({ text: shareText });
                } else {
                    await navigator.clipboard.writeText(shareText);
                    showCustomAlert('تم النسخ', 'تم نسخ بيانات الاختبار بنجاح!');
                }
            } catch (err) {
                console.error("Share failed:", err);
                await navigator.clipboard.writeText(shareText);
                showCustomAlert('تم النسخ', 'فشلت المشاركة، ولكن تم نسخ البيانات بنجاح!');
            }
        }
        
        const imageViewerModal = document.getElementById('image-viewer-modal');
        const imageWrapper = document.getElementById('image-viewer-content-wrapper');
        const modalImage = imageViewerModal.querySelector('.image-modal-content');
        const modalDownloadBtn = imageViewerModal.querySelector('.image-modal-download-btn');

        let scale = 1, panning = false, start = { x: 0, y: 0 }, transform = { x: 0, y: 0 };
        let initialDistance = null, lastTap = 0;

        function setTransform() { modalImage.style.transform = `translate(${transform.x}px, ${transform.y}px) scale(${scale})`; }
        
        function resetZoom() { 
            scale = 1; 
            transform = { x: 0, y: 0 }; 
            modalImage.style.transition = 'transform 0.2s ease-out';
            setTransform(); 
            setTimeout(() => modalImage.style.transition = 'none', 200);
        }

        function getDistance(p1, p2) { return Math.sqrt(Math.pow(p2.clientX - p1.clientX, 2) + Math.pow(p2.clientY - p1.clientY, 2)); }

        function openImageViewer(src) {
            if (!src || src.endsWith('#')) return;
            resetZoom();
            modalImage.src = src;
            modalDownloadBtn.href = src;
            imageViewerModal.classList.add('visible');
        }

        function closeImageViewer() {
            imageViewerModal.classList.remove('visible');
            setTimeout(() => { modalImage.src = ''; resetZoom(); }, 300);
        }

        imageWrapper.addEventListener('wheel', (e) => {
            e.preventDefault();
            const rect = imageWrapper.getBoundingClientRect();
            const xs = (e.clientX - rect.left - transform.x) / scale;
            const ys = (e.clientY - rect.top - transform.y) / scale;
            const delta = -e.deltaY;
            const newScale = delta > 0 ? scale * 1.2 : scale / 1.2;
            const clampedScale = Math.min(Math.max(1, newScale), 10);
            
            transform.x -= xs * (clampedScale - scale);
            transform.y -= ys * (clampedScale - scale);

            scale = clampedScale;
            if (scale === 1) transform = { x: 0, y: 0 };
            
            modalImage.style.transition = 'none';
            setTransform();
        }, { passive: false });

        imageWrapper.addEventListener('pointerdown', (e) => {
            const pointers = e.touches || [e];
            if (pointers.length === 1) {
                e.preventDefault();
                start = { x: pointers[0].clientX - transform.x, y: pointers[0].clientY - transform.y };
                panning = true;
                imageWrapper.style.cursor = 'grabbing';
                modalImage.style.transition = 'none';
            }
            if (pointers.length === 2) {
                panning = false;
                initialDistance = getDistance(pointers[0], pointers[1]);
            }
        });
        
        imageWrapper.addEventListener('pointerup', (e) => {
            panning = false;
            imageWrapper.style.cursor = 'grab';
            initialDistance = null;
        });

        imageWrapper.addEventListener('pointerleave', () => {
            panning = false;
            imageWrapper.style.cursor = 'grab';
            initialDistance = null;
        });
        
        imageWrapper.addEventListener('pointermove', (e) => {
            const pointers = e.touches || [e];
            if (panning && pointers.length === 1) {
                e.preventDefault();
                transform.x = pointers[0].clientX - start.x;
                transform.y = pointers[0].clientY - start.y;
                setTransform();
            }
            if (pointers.length === 2 && initialDistance) {
                 e.preventDefault();
                const newDist = getDistance(pointers[0], pointers[1]);
                const scaleMultiplier = newDist / initialDistance;
                const newScale = Math.min(Math.max(1, scale * scaleMultiplier), 10);
                
                const rect = imageWrapper.getBoundingClientRect();
                const pinchCenterX = (pointers[0].clientX + pointers[1].clientX) / 2;
                const pinchCenterY = (pointers[0].clientY + pointers[1].clientY) / 2;

                const xs = (pinchCenterX - rect.left - transform.x) / scale;
                const ys = (pinchCenterY - rect.top - transform.y) / scale;

                transform.x -= xs * (newScale - scale);
                transform.y -= ys * (newScale - scale);

                scale = newScale;
                initialDistance = newDist;
                modalImage.style.transition = 'none';
                setTransform();
            }
        });
        
        imageWrapper.addEventListener('dblclick', (e) => {
            e.preventDefault();
            modalImage.style.transition = 'transform 0.3s ease-out';
            if (scale > 1) {
                resetZoom();
            } else {
                const rect = imageWrapper.getBoundingClientRect();
                const xs = (e.clientX - rect.left - transform.x) / scale;
                const ys = (e.clientY - rect.top - transform.y) / scale;
                scale = 3;
                transform.x -= xs * (scale - 1);
                transform.y -= ys * (scale - 1);
                setTransform();
            }
        });
        
        imageWrapper.addEventListener('touchend', (e) => {
            const currentTime = new Date().getTime();
            if (currentTime - lastTap < 300) {
                e.preventDefault();
                modalImage.style.transition = 'transform 0.3s ease-out';
                if (scale > 1) {
                    resetZoom();
                } else {
                    const rect = imageWrapper.getBoundingClientRect();
                    const touch = e.changedTouches[0];
                    const xs = (touch.clientX - rect.left - transform.x) / scale;
                    const ys = (touch.clientY - rect.top - transform.y) / scale;
                    scale = 3;
                    transform.x -= xs * (scale - 1);
                    transform.y -= ys * (scale - 1);
                    setTransform();
                }
            }
            lastTap = currentTime;
        });

        document.addEventListener('click', (e) => { if (e.target.tagName === 'IMG' && e.target.closest('.portal-container, .modal-content')) { if (e.target.src && (e.target.src.startsWith('data:image') || e.target.src.includes('firebase'))) { e.preventDefault(); openImageViewer(e.target.src); } } });
        imageViewerModal.querySelector('.modal-close-btn').addEventListener('click', closeImageViewer);
        imageViewerModal.addEventListener('click', (e) => { if (e.target === imageViewerModal) closeImageViewer(); });
        
        
        const textChatModal = document.getElementById('text-chat-modal'), chatModalTitle = document.getElementById('chat-modal-title'), chatModalBody = document.getElementById('chat-modal-body'), messageInput = document.getElementById('chat-message-input');
        const sendMessageBtn = document.getElementById('send-chat-message-btn'), speechBtn = document.getElementById('speech-to-text-btn');
        const teacherChatListModal = document.getElementById('teacher-chat-list-modal'), studentChatListModal = document.getElementById('student-chat-list-modal');

        let currentUserId, currentUserType, recognition;
        let activeChatPartnerId = null, chatMessagesListener = null;

        function initChatSystem(userId, userType) {
            currentUserId = userId; currentUserType = userType; initSpeechRecognition();
            const badge = document.querySelector(`#${userType}-portal .notification-badge`);
            listenForUnreadMessages(userId, badge);
            if (userType === 'teacher') {
                teacherChatListModal.querySelector('.modal-close-btn').onclick = () => teacherChatListModal.classList.remove('visible');
            } else {
                studentChatListModal.querySelector('.modal-close-btn').onclick = () => studentChatListModal.classList.remove('visible');
            }
        }
        
        function listenForUnreadMessages(userId, badgeElement) {
            const chatsRef = query(ref(db, 'chats'), orderByChild(`participants/${userId}`), equalTo(true));
            onValue(chatsRef, (snapshot) => {
                let hasUnread = false;
                if (snapshot.exists()) {
                    snapshot.forEach(chatSnap => {
                        const metadata = chatSnap.val().metadata;
                        if (metadata && metadata.hasUnread && metadata.hasUnread[userId]) { hasUnread = true; }
                    });
                }
                badgeElement.style.display = hasUnread ? 'block' : 'none';
            });
        }

        async function openChatList(modal, listBody, userType) {
            modal.classList.add('visible'); listBody.innerHTML = '<div class="spinner"></div>';
            const chatsRef = query(ref(db, 'chats'), orderByChild(`participants/${currentUserId}`), equalTo(true));
            const snapshot = await get(chatsRef);
            if (!snapshot.exists()) { listBody.innerHTML = `<p>لا توجد محادثات حتى الآن. ${userType === 'student' ? 'يمكنك بدء محادثة من صفحة الاختبارات.' : ''}</p>`; return; }
            listBody.innerHTML = '';
            snapshot.forEach(chatSnap => {
                const partnerId = Object.keys(chatSnap.val().participants).find(p => p !== currentUserId);
                if (partnerId) {
                    const listItem = document.createElement('div');
                    listItem.className = 'list-item chat-list-item';
                    listItem.textContent = partnerId;
                    listItem.onclick = () => { modal.classList.remove('visible'); openChatModal(currentUserId, partnerId); };
                    listBody.appendChild(listItem);
                }
            });
        }
        
        function initSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if(!SpeechRecognition) { speechBtn.style.display = 'none'; return; }
            recognition = new SpeechRecognition();
            recognition.continuous = false; recognition.lang = 'ar-EG'; recognition.interimResults = false;
            recognition.onresult = (event) => { messageInput.value += event.results[0][0].transcript; };
            recognition.onend = () => speechBtn.classList.remove('listening');
            recognition.onerror = (event) => { speechBtn.classList.remove('listening'); console.error(event.error); };
        }
        speechBtn.onclick = () => { if (recognition) { if (speechBtn.classList.contains('listening')) { recognition.stop(); } else { recognition.start(); speechBtn.classList.add('listening'); } } };

        async function openChatModal(userId, partnerId) {
            if (chatMessagesListener) off(chatMessagesListener);
            activeChatPartnerId = partnerId; chatModalTitle.textContent = `محادثة مع ${partnerId}`; chatModalBody.innerHTML = ''; messageInput.value = '';
            textChatModal.classList.add('visible');
            
            if(currentUserType === 'student') await checkMessageLimit(userId);
            else { document.getElementById('message-limit-text').textContent = ''; sendMessageBtn.disabled = false; messageInput.disabled = false; }

            const chatId = [userId, partnerId].sort().join('_');
            const metadataRef = ref(db, `chats/${chatId}/metadata/hasUnread/${userId}`);
            await set(metadataRef, null);
            
            const messagesRef = query(ref(db, `chats/${chatId}/messages`), orderByChild('timestamp'));
            chatMessagesListener = onValue(messagesRef, (snapshot) => {
                chatModalBody.innerHTML = '';
                if (snapshot.exists()) {
                    const now = Date.now();
                    const expiryPeriod = 48 * 60 * 60 * 1000;
                    let messageFound = false;
                    snapshot.forEach(child => {
                        const msg = child.val();
                        if (now - msg.timestamp < expiryPeriod) {
                             messageFound = true;
                             const msgDiv = document.createElement('div');
                             msgDiv.className = `chat-message ${msg.sender === currentUserId ? 'sent' : 'received'}`;
                             const time = new Date(msg.timestamp).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
                             msgDiv.innerHTML = `<span>${msg.text}</span><span class="msg-time">${time}</span>`;
                             chatModalBody.appendChild(msgDiv);
                        }
                    });
                    
                    if(messageFound) {
                        chatModalBody.scrollTop = chatModalBody.scrollHeight;
                    } else {
                        chatModalBody.innerHTML = '<p>لا توجد رسائل حديثة. ابدأ المحادثة!</p>';
                    }

                } else { chatModalBody.innerHTML = '<p>ابدأ المحادثة!</p>'; }
            });
        }

        async function checkMessageLimit(userId) {
            const limitRef = ref(db, `messageLimits/${userId}`), snapshot = await get(limitRef), now = Date.now(), limitPeriod = 48 * 60 * 60 * 1000;
            let recentMessages = 0; const updates = {};
            if (snapshot.exists()) {
                snapshot.forEach(child => { if (now - child.val() < limitPeriod) recentMessages++; else updates[child.key] = null; });
                if(Object.keys(updates).length > 0) update(limitRef, updates);
            }
            const remaining = 3 - recentMessages, canSend = remaining > 0, limitText = document.getElementById('message-limit-text');
            limitText.textContent = canSend ? `لديك ${remaining} رسائل متبقية.` : "لقد وصلت إلى الحد الأقصى للرسائل (3 كل 48 ساعة).";
            sendMessageBtn.disabled = !canSend; messageInput.disabled = !canSend;
            return canSend;
        }
        
        sendMessageBtn.onclick = async () => {
            const text = messageInput.value.trim();
            if (text === '' || !activeChatPartnerId) return;
            if (currentUserType === 'student' && !(await checkMessageLimit(currentUserId))) {
                showCustomAlert("خطأ", "لقد تجاوزت حد الرسائل المسموح به.");
                return;
            }
            const chatId = [currentUserId, activeChatPartnerId].sort().join('_');
            const messageData = { sender: currentUserId, text: text, timestamp: serverTimestamp() };
            const chatRef = ref(db, `chats/${chatId}`);
            
            try {
                await push(ref(db, `chats/${chatId}/messages`), messageData);
                const updates = {};
                updates[`participants/${currentUserId}`] = true;
                updates[`participants/${activeChatPartnerId}`] = true;
                updates[`metadata/hasUnread/${activeChatPartnerId}`] = true;
                updates[`metadata/lastSender`] = currentUserId;
                await update(chatRef, updates);

                if(currentUserType === 'student'){
                     await push(ref(db, `messageLimits/${currentUserId}`), serverTimestamp());
                     await checkMessageLimit(currentUserId);
                }
                
                messageInput.value = ''; messageInput.focus();
            } catch (e) { showCustomAlert("خطأ", "لم يتم إرسال الرسالة."); console.error(e); }
        };
        textChatModal.querySelector('.modal-close-btn').onclick = () => {
            textChatModal.classList.remove('visible'); activeChatPartnerId = null; if (chatMessagesListener) off(chatMessagesListener, 'value');
        };

        const sloganWidget = document.getElementById('slogan-widget');
        
        const handleInitialLoad = () => {
            const savedTeacher = localStorage.getItem('loggedInTeacher');
            const savedStudent = localStorage.getItem('loggedInStudent');
            
            if(window.location.hash.startsWith('#test/')){
                const parts = window.location.hash.split('/');
                if(parts.length === 3) {
                    sessionStorage.setItem('deepLinkTest',JSON.stringify({teacherId:decodeURIComponent(parts[1]),testId:decodeURIComponent(parts[2])}));
                    history.pushState("", document.title, window.location.pathname + window.location.search);
                }
                studentPortal.classList.remove('hidden'); 
                initStudentApp();
                return;
            }
            
            if (savedTeacher) { 
                teacherPortal.classList.remove('hidden'); 
                initTeacherApp(); 
            } 
            else if (savedStudent) { 
                studentPortal.classList.remove('hidden'); 
                initStudentApp(); 
            } 
            else { 
                mainLandingPage.classList.remove('hidden'); 
                sloganWidget.classList.remove('hidden'); // Show slogan only on main landing
                loadSloganWidgetData();
            }
        };

        handleInitialLoad();

        if (sloganWidget) {
            sloganWidget.addEventListener('click', () => {
                const sloganImage = sloganWidget.querySelector('img');
                if (sloganImage && sloganImage.src) {
                    openImageViewer(sloganImage.src);
                }
            });
        }
         async function loadSloganWidgetData() {
            const sloganImage = document.getElementById('slogan-image');
            const sloganText = document.getElementById('slogan-text');
            try {
                const sloganRef = ref(db, 'config/sloganWidget');
                const snapshot = await get(sloganRef);
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    if (data.imageUrl) {
                        sloganImage.src = data.imageUrl;
                        sloganImage.alt = data.text || 'شعار';
                    }
                    if (data.text) {
                        sloganText.textContent = data.text;
                    }
                }
            } catch (error) {
                console.error("Could not load slogan widget data:", error);
            }
        }


    </script>

    <!-- Screenshot Prevention Script -->
    <script>
        document.addEventListener('contextmenu', event => event.preventDefault());
        document.addEventListener('keydown', function(e) {
            if (e.key === 'PrintScreen' || (e.ctrlKey && e.shiftKey && e.key === 'I') || (e.ctrlKey && e.shiftKey && e.key === 'C') || e.key === 'F12' || (e.ctrlKey && e.key === 'U')) {
                e.preventDefault();
            }
        });
    </script>
</body>
</html>
