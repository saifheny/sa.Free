<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<!-- 1. تم تغيير الاسم إلى NeoFlow (مطلوب) -->
<title>⚡ NeoFlow</title>

<!-- (جديد) إضافات لجعل الموقع كتطبيق (PWA) (مطلوب) -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- (ملاحظة: لإظهار أيقونة التطبيق، أضف) <link rel="apple-touch-icon" href="/icon.png"> -->

<!-- خط القاهرة و Font Awesome للآيقونات -->
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

<style>
  /* ====== المتغيرات والتنسيارات الأساسية ====== */
  :root {
    --background-color: #000000; /* 2. خلفية سوداء داكنة (مطلوب) */
    --primary-color: #00bcd4; /* سماوي افتراضي */
    --primary-accent: #00bcd4;
    --primary-accent-dark: #008c9e;
    --sky-blue-like: #00bfff;
    --glass-bg-light: rgba(255, 255, 255, 0.07); 
    --glass-bg-dark: rgba(255, 255, 255, 0.03); 
    --text-color-primary: #eee; 
    --text-color-secondary: var(--primary-color);
    --border-radius-main: 1.5rem; 
    --border-radius-small: 1rem; 
    --skeleton-bg: #222;
    --delete-color: #ff4d4f;
    --dislike-color: #808080;
  }

  /* 2. تأثير الخلفية (الدخان الأبيض السائل) (مطلوب) */
  @keyframes whiteSmoke {
    0% {
      opacity: 0;
      transform: scale(0.8) translate(-20%, -20%);
    }
    25% {
      opacity: 0.04; /* خفيف جدًا */
    }
    75% {
      opacity: 0.02;
    }
    100% {
      opacity: 0;
      transform: scale(2.5) translate(20%, 20%);
    }
  }

  body::before {
    content: '';
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    background-image: radial-gradient(circle at top left, rgba(255, 255, 255, 1) 0%, transparent 40%),
                      radial-gradient(circle at bottom right, rgba(255, 255, 255, 1) 0%, transparent 50%);
    background-size: 150% 150%;
    animation: whiteSmoke 25s infinite alternate ease-in-out;
    will-change: transform, opacity;
  }

  /* (جديد) لإعطاء إحساس التطبيق الأصلي ومنع التظليل عند اللمس (مطلوب) */
  html {
    -webkit-tap-highlight-color: transparent;
  }

  body { 
    margin: 0; 
    padding: 0; 
    background: var(--background-color); 
    font-family: 'Cairo', sans-serif; 
    color: var(--text-color-primary); 
    transition: background 0.5s ease;
    overflow-x: hidden;
  }
  
  /* ====== الشاشة الرئيسية والتسجيل ====== */
  #login-screen, #app { display: none; flex-direction: column; width: 100%; max-width: 900px; min-height: 100vh; margin: 0 auto; padding: 1rem 1rem 5rem; box-sizing: border-box; }
  #login-screen { justify-content: center; align-items: center; gap: 1rem; }
  /* 1. تم تغيير الاسم (مطلوب) */
  #login-screen h2 { color: var(--text-color-secondary); text-align: center; }
  #login-screen input[type="text"] { border: none; border-radius: var(--border-radius-main); padding: 0.7rem 1rem; font-size: 1.3rem; outline: none; background: #222; color: #fff; text-align: center; width: 90%; max-width: 350px; }
  #login-screen button { background: var(--primary-accent); border: none; border-radius: 1.5rem; padding: 0.7rem 2.5rem; color: #000; font-weight: bold; transition: background-color 0.3s ease; cursor: pointer;}
  #login-screen button:hover:not(:disabled) { background: var(--primary-accent-dark); }
  
  /* 4. نظام التسجيل والجنس (مطلوب) */
  .gender-selection { display: flex; gap: 1rem; margin-top: 0.5rem; }
  .gender-selection label { cursor: pointer; display: flex; align-items: center; gap: 0.5rem; background: var(--glass-bg-dark); padding: 0.5rem 1rem; border-radius: var(--border-radius-main); transition: background 0.3s; }
  .gender-selection label:hover { background: rgba(255, 255, 255, 0.15); }
  .gender-selection input[type="radio"] { display: none; }
  .gender-selection input[type="radio"]:checked + i { color: var(--primary-accent); }

  /* 5. اختيار الألوان (مطلوب) */
  .color-selection { display: flex; gap: 1rem; margin-top: 0.5rem; }
  .color-option { width: 40px; height: 40px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s; user-select: none; /* (جديد) */ }
  .color-option:hover { transform: scale(1.1); }
  .color-option.active { border-color: white; transform: scale(1.1); }
  
  /* ====== رأس التطبيق والمنشورات ====== */
  header { 
    position: sticky; 
    top: 0; 
    background: rgba(0,0,0,0.8); 
    backdrop-filter: blur(10px); 
    -webkit-backdrop-filter: blur(10px); 
    padding: 1rem 0; 
    margin: 0 -1rem 1.5rem; 
    display: flex; 
    align-items: center; 
    justify-content: space-between;
    z-index: 10; 
    width: calc(100% + 2rem); 
    box-sizing: border-box; 
    padding-left: 1rem; /* إضافة padding لليمين واليسار */
    padding-right: 1rem;
  }
  
  .header-left { display: flex; align-items: center; gap: 0.75rem; }
  .header-center { flex: 1; text-align: center; }
  
  /* 1. اسم المنصة (مطلوب) */
  .platform-name {
    font-size: 1.8rem;
    font-weight: 900;
    color: var(--primary-accent);
    /* 1. تأثير الحفر (مطلوب) */
    text-shadow: 0px 1px 0px rgba(255, 255, 255, 0.1), 0px -1px 0px rgba(0, 0, 0, 0.7);
    letter-spacing: 1px;
    padding: 0.5rem 1.5rem;
    border-radius: var(--border-radius-main);
  }
  
  #user-icon-wrapper { cursor: pointer; position: relative; user-select: none; /* (جديد) */ } /* 4. إضافة wrapper */
  #user-icon { 
    width: 44px; height: 44px; border-radius: 50%; background-color: #444; 
    font-weight: 700; font-size: 1.3rem; color: var(--primary-accent); 
    display: flex; justify-content: center; align-items: center; 
    user-select: none; flex-shrink: 0; border: 2px solid var(--primary-accent); 
  }
  
  /* 4. أيقونة الجنس على الصورة (مطلوب) */
  #user-gender-icon {
    position: absolute;
    bottom: -2px;
    right: -2px;
    background: var(--background-color);
    border-radius: 50%;
    width: 18px;
    height: 18px;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 0.8rem;
    border: 1px solid rgba(255,255,255,0.1);
  }
  
  #posts { display: flex; flex-direction: column; gap: 1.5rem; }
  .post { background: var(--glass-bg-light); border-radius: var(--border-radius-main); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); padding: 1rem 1.2rem 1.5rem; animation: slideDownFade 0.5s ease-out forwards; opacity: 0; position: relative; }
  @keyframes slideDownFade { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  
  /* ====== تنسيق رأس المنشور ====== */
  .post-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.8rem; }
  .post-header .avatar { width: 38px; height: 38px; background-color: var(--primary-accent); border-radius: 50%; color: #000; font-weight: 800; display: flex; justify-content: center; align-items: center; user-select: none; }
  .post-header .username { font-weight: 700; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem; }
  .gender-icon { font-size: 0.9rem; margin-left: -0.3rem; }
  .male { color: #5dade2; } .female { color: #f1948a; }
  
  .post-title { background: rgba(255, 255, 255, 0.12); border-radius: var(--border-radius-main); padding: 0.8rem 1rem; font-weight: 800; font-size: 1.15rem; color: var(--text-color-secondary); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); margin-bottom: 1rem; user-select: text; line-height: 1.6; word-break: break-word; }
  .post-images { display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; }
  .post-images img { width: 100%; height: 140px; object-fit: cover; border-radius: var(--border-radius-small); cursor: pointer; }
  .img-wrapper { position: relative; border-radius: var(--border-radius-small); overflow: hidden; }
  .more-overlay { position: absolute; inset: 0; background-color: rgba(0,0,0,0.6); border-radius: var(--border-radius-small); color: #fff; font-size: 1.5rem; font-weight: 900; display: flex; justify-content: center; align-items: center; user-select: none; }
  
  .text-only-post-indicator { height: 7px; width: 100%; border-radius: 0 0 var(--border-radius-main) var(--border-radius-main); position: absolute; bottom: 0; left: 0; transition: all 0.3s; }

  /* ====== شريط التفاعلات (الإعجاب، التعليق، الحذف) ====== */
  .post-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; border-top: 1px solid rgba(255, 255, 255, 0.1); padding-top: 0.7rem; }
  .action-btn { background: var(--glass-bg-dark); border: none; border-radius: 1.5rem; padding: 0.5rem 1rem; color: var(--text-color-primary); font-weight: 700; cursor: pointer; transition: background-color 0.3s; display: flex; align-items: center; gap: 0.5rem; user-select: none; }
  .action-btn i { font-size: 1.1rem; }
  .action-btn:hover { background: rgba(255, 255, 255, 0.15); }
  .like-btn.active { color: var(--sky-blue-like); background: rgba(0, 191, 255, 0.2); }
  .dislike-btn.active { color: var(--dislike-color); background: rgba(128, 128, 128, 0.2); }
  .delete-btn { color: var(--delete-color); }
  .like-dislike-group { display: flex; gap: 0.5rem; }
  
  /* 3. زر إضافة منشور (أيقونة +) (مطلوب) */
  #add-post-btn { 
    position: fixed; 
    bottom: 1.5rem; 
    right: 1.5rem; 
    background: linear-gradient(145deg, var(--primary-accent), var(--primary-accent-dark)); 
    border-radius: 50%; 
    width: 64px; 
    height: 64px; 
    box-shadow: 0 6px 14px rgba(0, 188, 212, 0.7); 
    border: none; 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    color: #000; 
    font-size: 2.8rem; 
    transition: all 0.3s ease; 
    cursor: pointer; 
    user-select: none; 
    z-index: 998; 
  }
  #add-post-btn:hover { box-shadow: 0 8px 22px rgba(0, 188, 212, 0.9); transform: scale(1.05); }
  
  /* 6. نافذة اختيار نوع الرفع (Bottom Sheet) (مطلوب) */
  #upload-choice-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.8); 
    backdrop-filter: blur(6px); display: none; 
    justify-content: center; align-items: flex-end; /* 6. تظهر من الأسفل (مطلوب) */
    z-index: 999;
  }
  #upload-choice-modal {
    background: #111;
    border-top-left-radius: 2rem;
    border-top-right-radius: 2rem;
    width: 100%;
    max-width: 600px;
    padding: 1.5rem 2rem 2rem;
    display: flex; flex-direction: column; gap: 1rem;
    box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
    transform: translateY(100%);
    transition: transform 0.25s ease-out; /* (تم التسريع) */
    box-sizing: border-box;
    border-top: 1px solid rgba(255,255,255,0.1);
  }
  #upload-choice-overlay.active #upload-choice-modal { transform: translateY(0); }
  #upload-choice-modal h2 { margin: 0 0 1rem 0; color: var(--text-color-secondary); user-select: none; text-align: center; }
  .upload-option-btn {
    background: var(--glass-bg-light);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: var(--border-radius-main);
    padding: 1rem;
    color: var(--text-color-primary);
    font-size: 1.2rem;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.3s;
    text-align: center;
    user-select: none; /* (جديد) */
  }
  .upload-option-btn:hover { background: rgba(255,255,255,0.15); }
  .upload-option-btn i { margin-left: 0.5rem; color: var(--text-color-secondary); }

  /* 6. الـ Modal الأساسية (لإضافة منشور) (مطلوب) */
  #modal-overlay { 
    position: fixed; 
    inset: 0; 
    background: rgba(0,0,0,0.8); 
    backdrop-filter: blur(6px); 
    display: none; 
    justify-content: center; 
    align-items: center; /* 6. الوضع الافتراضي للكمبيوتر */
    z-index: 999; 
    padding: 1rem; 
  }
  
  #modal { 
    background: rgba(0, 0, 0, 0.9); 
    border-radius: 2rem; 
    backdrop-filter: blur(20px); 
    -webkit-backdrop-filter: blur(20px); 
    box-shadow: 0 0 20px rgba(0, 188, 212, 0.5); 
    padding: 1.5rem 2rem; 
    width: 100%; 
    max-width: 400px; 
    display: flex;
    flex-direction: column; 
    gap: 1rem; 
    box-sizing: border-box; 
    border: 1px solid rgba(255, 255, 255, 0.1);
    transform: scale(0.95); opacity: 0; /* للظهور التدريجي */
    transition: transform 0.25s ease-out, opacity 0.25s ease-out; /* (تم التسريع) */
  }
  #modal-overlay.active #modal { transform: scale(1); opacity: 1; }
  
  #modal h2 { margin: 0 0 0.3rem 0; color: var(--text-color-secondary); user-select: none; text-align: center; }
  /* 6. تم تحويله إلى textarea لدعم النص الطويل */
  #post-title-input { 
    padding: 0.7rem 1rem; border: none; border-radius: var(--border-radius-main); 
    font-size: 1.1rem; outline: none; background: #222; color: #fff; 
    min-height: 80px; resize: vertical; font-family: 'Cairo', sans-serif;
  }
  #choose-images-btn { padding: 0.7rem 1rem; background: var(--primary-accent); border: none; color: #000; border-radius: var(--border-radius-main); font-weight: 700; user-select: none; transition: background-color 0.3s ease; text-align: center; cursor: pointer; }
  #images-preview { display: flex; flex-wrap: wrap; gap: 6px; max-height: 150px; overflow-y: auto; }
  #images-preview img { width: 60px; height: 60px; border-radius: var(--border-radius-small); object-fit: cover; }
  #publish-btn { margin-top: 1rem; background: var(--primary-accent); border: none; color: #000; font-weight: 800; padding: 0.9rem; border-radius: 2rem; font-size: 1.2rem; cursor: pointer; user-select: none; transition: background-color 0.3s ease; }
  #publish-btn:disabled { background: #555; color: #bbb; cursor: not-allowed; }

  /* ====== معرض الصور (Gallery Viewer) ====== */
  #gallery-viewer-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); backdrop-filter: blur(5px); display: none; z-index: 9999; padding: 2rem 0; box-sizing: border-box; }
  #close-gallery-btn { position: absolute; top: 1rem; left: 1.5rem; background: none; border: none; font-size: 2.5rem; color: #aaa; cursor: pointer; transition: color 0.3s; z-index: 10; }
  #gallery-container { width: 100%; max-width: 700px; margin: 0 auto; height: 100%; overflow-y: auto; display: flex; flex-direction: column; gap: 2rem; padding: 0 1rem; box-sizing: border-box; -webkit-overflow-scrolling: touch; /* (جديد) */ }
  .gallery-item { position: relative; text-align: center; }
  .gallery-item img { max-width: 100%; border-radius: var(--border-radius-small); box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
  .download-btn { position: absolute; bottom: 1rem; left: 1rem; background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; text-decoration: none; transition: background 0.3s; }
  .download-btn:hover { background: var(--primary-accent); color: #000; }
  #load-more-container { text-align: center; margin-top: 1.5rem; }
  #load-more-btn { background: var(--primary-accent); border: none; border-radius: 1.5rem; padding: 0.7rem 2.5rem; color: #000; font-weight: bold; transition: background-color 0.3s ease; cursor: pointer; display: none; }
  
  /* 7. نظام التعليقات (Bottom Sheet) (مطلوب) */
  #comment-modal-overlay { 
    position: fixed; 
    inset: 0; 
    background: rgba(0,0,0,0.85); 
    backdrop-filter: blur(6px); 
    display: none; 
    justify-content: center; 
    align-items: flex-end; /* 7. يظهر من الأسفل (مطلوب) */
    z-index: 1000; 
  }
  
  #comment-modal { 
    background: var(--background-color); 
    border-top-left-radius: 2rem; 
    border-top-right-radius: 2rem; 
    width: 100%; 
    max-width: 600px; 
    height: 70vh; /* 7. ارتفاع 70% (مطلوب) */
    display: flex; 
    flex-direction: column; 
    box-shadow: 0 -5px 20px rgba(0,0,0,0.5); 
    transform: translateY(100%); 
    transition: transform 0.25s ease-out; /* (تم التسريع) */
    border-top: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  #comment-modal-overlay.active #comment-modal { transform: translateY(0); }
  
  #comment-modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
  /* 1. اسم "الأصداء" (مطلوب) */
  #comment-modal-header h3 { margin: 0; font-size: 1.2rem; color: var(--text-color-secondary); }
  #close-comment-btn { background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer; }
  
  #comment-content-area { flex-grow: 1; overflow-y: auto; padding: 0 1.5rem; -webkit-overflow-scrolling: touch; /* (جديد) */ }
  #post-detail-for-comment { padding: 1rem 0; background: var(--glass-bg-dark); margin: 0 -1.5rem; padding: 1rem 1.5rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
  .comment-post-title { font-size: 1rem; font-weight: 700; color: var(--text-color-secondary); line-height: 1.5; }
  
  #comments-list { display: flex; flex-direction: column; gap: 1rem; padding: 1rem 0; }
  .comment-item { background: var(--glass-bg-dark); border-radius: var(--border-radius-small); padding: 0.8rem 1rem; }
  .comment-header { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
  .comment-header .username { font-weight: 700; font-size: 0.95rem; }
  .comment-text { font-size: 0.9rem; line-height: 1.4; word-break: break-word; }
  .comment-actions { display: flex; gap: 0.5rem; margin-top: 0.5rem; font-size: 0.8rem; }
  .comment-actions button { background: none; border: none; color: #bbb; cursor: pointer; padding: 0.2rem 0.5rem; border-radius: 0.5rem; transition: background 0.2s; }
  .comment-actions button:hover { background: rgba(255, 255, 255, 0.1); }
  .comment-actions .like-btn.active { color: var(--sky-blue-like); }
  .comment-actions .dislike-btn.active { color: var(--dislike-color); }
  
  /* 8. عرض الصوت كأرقام (مطلوب) */
  .comment-voice-icon { color: var(--primary-accent); margin-right: 0.5rem; }
  .comment-voice-data {
    font-family: 'Courier New', Courier, monospace;
    font-size: 0.85rem;
    color: var(--primary-accent);
    background: rgba(0,0,0,0.3);
    padding: 0.5rem;
    border-radius: 0.5rem;
    word-break: break-all;
    line-height: 1.2;
    max-height: 100px;
    overflow-y: auto;
    user-select: all;
    direction: ltr; /* لضمان عرض الكود من اليسار لليمين */
    margin-top: 0.5rem;
  }
  
  /* 7. شريط إدخال التعليق (مطلوب) */
  #comment-input-area { 
    padding: 1rem 1rem 0.5rem; 
    border-top: 1px solid rgba(255, 255, 255, 0.1); 
    display: flex; 
    gap: 0.5rem; 
    align-items: flex-end; 
    position: sticky;
    bottom: 0;
    background: var(--background-color);
    box-shadow: 0 -5px 10px rgba(0,0,0,0.5);
  }
  
  #comment-input-container { flex-grow: 1; background: var(--glass-bg-dark); border-radius: 2rem; display: flex; align-items: center; padding: 0.2rem 0.5rem; position: relative; }
  #comment-input { 
    flex-grow: 1; 
    border: none; 
    outline: none; 
    background: transparent; 
    color: #fff; 
    padding: 0.7rem 1rem; 
    font-size: 1rem; 
    line-height: 1.2; 
    resize: none; 
    overflow: hidden; 
    min-height: 38px; 
    max-height: 100px;
    box-sizing: border-box; 
  }
  
  /* 7. عداد الأحرف (مطلوب) */
  #char-count {
    position: absolute;
    bottom: 5px;
    left: 15px; /* تم تعديل المكان ليتناسب مع "rtl" */
    font-size: 0.8rem;
    color: #888;
    direction: ltr; /* لضمان عرض الأرقام بشكل صحيح */
  }
  
  #send-voice-btn { 
    width: 44px; 
    height: 44px; 
    border-radius: 50%; 
    background: var(--primary-accent); 
    color: #000; 
    border: none; 
    font-size: 1.2rem; 
    cursor: pointer; 
    transition: background-color 0.1s; 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    flex-shrink: 0; 
  }
  #send-voice-btn:active { background: var(--primary-accent-dark); }
  /* 8. زر التسجيل (مطلوب) */
  #send-voice-btn.recording { 
    background: var(--delete-color); 
    color: white; 
    animation: pulse 1s infinite; 
  }
  @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 77, 79, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 77, 79, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 77, 79, 0); } }

  /* (جديد) زر إلغاء التسجيل */
  #cancel-voice-btn {
    width: 44px; 
    height: 44px; 
    border-radius: 50%; 
    background: var(--glass-bg-dark);
    color: var(--delete-color);
    border: none; 
    font-size: 1.2rem; 
    cursor: pointer; 
    transition: all 0.2s; 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    flex-shrink: 0;
  }
  #cancel-voice-btn:hover { background: rgba(255, 77, 79, 0.2); }


  /* ====== الهياكل العظمية (Skeletons) ====== */
  .skeleton-post { background: var(--glass-bg-light); border-radius: var(--border-radius-main); padding: 1rem 1.2rem 1.5rem; }
  .skeleton { background-color: var(--skeleton-bg); border-radius: 0.5rem; animation: shimmer 1.5s infinite linear; }
  @keyframes shimmer { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
  .skeleton-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.8rem; }
  .skeleton-avatar { width: 38px; height: 38px; border-radius: 50%; }
  .skeleton-username { width: 100px; height: 20px; }
  .skeleton-title { width: 80%; height: 40px; border-radius: var(--border-radius-main); margin-bottom: 1rem; }
  .skeleton-images { display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; }
  .skeleton-img { width: 100%; height: 140px; border-radius: var(--border-radius-small); }

  /* 5. نافذة الملف الشخصي (مطلوب) */
  #profile-modal-overlay { 
    position: fixed; 
    inset: 0; 
    background: rgba(0,0,0,0.8); 
    backdrop-filter: blur(6px); 
    display: none; 
    justify-content: center; 
    align-items: center; 
    z-index: 1001; 
    padding: 1rem; 
  }
  
  #profile-modal { 
    background: rgba(0, 0, 0, 0.9); 
    border-radius: 2rem; 
    backdrop-filter: blur(20px); 
    -webkit-backdrop-filter: blur(20px); 
    box-shadow: 0 0 20px rgba(0, 188, 212, 0.5); 
    padding: 1.5rem 2rem; 
    width: 100%; 
    max-width: 400px; 
    display: flex; 
    flex-direction: column; 
    gap: 1rem; 
    box-sizing: border-box; 
    border: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  .profile-section { margin-bottom: 1.5rem; }
  .profile-section h3 { color: var(--text-color-secondary); margin-bottom: 0.8rem; }
  .profile-input { width: 100%; padding: 0.7rem 1rem; border: none; border-radius: var(--border-radius-main); background: #222; color: #fff; font-size: 1rem; box-sizing: border-box; }
  .profile-btn { background: var(--primary-accent); border: none; border-radius: var(--border-radius-main); padding: 0.7rem 1.5rem; color: #000; font-weight: bold; cursor: pointer; transition: background-color 0.3s; }
  .profile-btn:hover { background: var(--primary-accent-dark); }

  /* 3. تجاوب مع الموبايل (مطلوب) */
  @media (max-width: 600px) {
    #app { padding: 0.5rem 0.5rem 5rem; }
    /* 3. (تم الإصلاح) لضمان امتداد الشريط العلوي بعرض الشاشة بالكامل */
    header { padding: 1rem 0.5rem; margin: 0 -0.5rem 1.5rem; width: calc(100% + 1rem); }
    .platform-name { font-size: 1.5rem; padding: 0.4rem 1rem; }
    .post, .skeleton-post { padding: 0.8rem 1rem 1.2rem; }
    
    /* 6. نافذة الرفع (Bottom Sheet للموبايل) (مطلوب) */
    #modal-overlay {
      align-items: flex-end; /* تظهر من الأسفل */
      padding: 0;
    }
    #modal-overlay.active #modal {
      transform: translateY(0); /* حركة الدخول */
      opacity: 1;
    }
    #modal {
      border-radius: 1.5rem 1.5rem 0 0;
      max-width: 100%;
      box-shadow: 0 -5px 20px rgba(0, 188, 212, 0.5);
      transform: translateY(100%); /* الوضع الافتراضي (مخفي) */
      opacity: 1; /* يجب أن تكون 1 للسماح بالانتقال */
    }

    /* 7. نافذة التعليقات (Bottom Sheet للموبايل) (مطلوب) */
    #comment-modal-overlay { padding: 0; }
    #comment-modal { border-radius: 1.5rem 1.5rem 0 0; height: 80vh; }
    #comment-input-area { padding-bottom: 0.5rem; }
    
    #profile-modal { padding: 1rem; margin: 1rem; }
  }
</style>
</head>
<body>

<!-- (تم إزالة الخلفية السابقة واستبدالها بـ body::before) -->

<!-- شاشة تسجيل الدخول وإنشاء الحساب -->
<div id="login-screen">
  <!-- 1. تم تغيير الاسم (مطلوب) -->
  <h2>مرحباً في ⚡ NeoFlow</h2>
  <input type="text" id="username-input" placeholder="اسم المستخدم" maxlength="30" autocomplete="off"/>
  <!-- 4. اختيار الجنس (مطلوب) -->
  <div class="gender-selection">
    <label><input type="radio" name="gender" value="male" checked><i class="fas fa-mars male"></i> ذكر</label>
    <label><input type="radio" name="gender" value="female"><i class="fas fa-venus female"></i> أنثى</label>
  </div>
  <!-- 5. اختيار الألوان (مطلوب) -->
  <div class="color-selection">
    <div class="color-option active" style="background-color: #00bcd4;" data-color="#00bcd4"></div>
    <div class="color-option" style="background-color: #ffeb3b;" data-color="#ffeb3b"></div>
    <div class="color-option" style="background-color: #f44336;" data-color="#f44336"></div>
    <div class="color-option" style="background-color: #ffffff;" data-color="#ffffff"></div>
  </div>
  <button id="login-btn" disabled>إنشاء حساب</button>
</div>

<!-- شاشة التطبيق الرئيسية -->
<div id="app">
  <header>
    <div class="header-left">
      <!-- 4. أيقونة المستخدم والجنس (مطلوب) -->
      <div id="user-icon-wrapper" title="ملفي الشخصي">
        <div id="user-icon"></div>
        <span id="user-gender-icon"></span> <!-- 4. أيقونة الجنس (مطلوب) -->
      </div>
    </div>
    <div class="header-center">
      <!-- 1. تم تغيير الاسم (مطلوب) -->
      <div class="platform-name">⚡ NeoFlow</div>
    </div>
    <div class="header-right" style="width: 44px;"></div> <!-- عنصر موازنة -->
  </header>
  <section id="posts"></section>
  <div id="load-more-container">
    <button id="load-more-btn">تحميل المزيد</button>
  </div>
  <!-- 3. زر الرفع (أيقونة +) (مطلوب) -->
  <button id="add-post-btn" aria-label="إضافة Vibe جديد"><i class="fa-solid fa-plus"></i></button>
</div>

<!-- 6. نافذة اختيار نوع الرفع (Bottom Sheet) (مطلوب) -->
<div id="upload-choice-overlay">
  <div id="upload-choice-modal">
    <!-- 1. اسم "Vibe" (مطلوب) -->
    <h2>ابدأ Vibe جديد</h2>
    <button class="upload-option-btn" id="text-only-option">
      <i class="fas fa-font"></i>
      Vibe نصي فقط
    </button>
    <button class="upload-option-btn" id="image-text-option">
      <i class="fas fa-image"></i>
      Vibe (صورة + نص)
    </button>
    <button class="action-btn" id="close-choice-modal-btn" style="background: var(--glass-bg-dark); margin-top: 1rem;">إلغاء</button>
  </div>
</div>

<!-- 6. Modal إضافة منشور (Bottom Sheet للموبايل) (مطلوب) -->
<div id="modal-overlay">
  <div id="modal">
    <!-- 1. اسم "Vibe" (مطلوب) -->
    <h2 id="modal-title">إنشاء Vibe جديد</h2>
    <textarea id="post-title-input" placeholder="اكتب الـ Vibe هنا..." maxlength="500" autocomplete="off"></textarea>
    <!-- 6. قسم الصور (اختياري) (مطلوب) -->
    <div id="image-upload-section" style="display: none;">
      <label for="images-input" id="choose-images-btn" tabindex="0">اختيار صور (اختياري - 6 كحد أقصى)</label>
      <input type="file" id="images-input" accept="image/*" multiple style="display:none" />
      <div id="images-preview"></div>
    </div>
    <button id="publish-btn" disabled>نشر الـ Vibe</button>
    <button class="action-btn" id="close-modal-btn" style="background: var(--glass-bg-dark); margin-top: 0.5rem;">إلغاء</button>
  </div>
</div>

<!-- Modal معرض الصور -->
<div id="gallery-viewer-overlay">
  <button id="close-gallery-btn">×</button>
  <div id="gallery-container"></div>
</div>

<!-- 7. Modal التعليقات (Bottom Sheet) (مطلوب) -->
<div id="comment-modal-overlay">
  <div id="comment-modal">
    <div id="comment-modal-header">
      <!-- 1. اسم "الأصداء" (مطلوب) -->
      <h3 id="comment-count-title">الأصداء (0)</h3>
      <button id="close-comment-btn">×</button>
    </div>
    <div id="comment-content-area">
      <div id="post-detail-for-comment">
        <!-- سيتم حقن تفاصيل المنشور هنا (العنوان) -->
      </div>
      <div id="comments-list">
        <!-- سيتم حقن التعليقات هنا -->
        <p style="text-align:center;color:#666; padding: 1rem 0;">جارٍ تحميل الأصداء...</p>
      </div>
      <div id="load-more-comments-container" style="text-align: center; padding: 1rem;">
        <button id="load-more-comments-btn" class="action-btn" style="display:none;">تحميل المزيد</button>
      </div>
    </div>
    
    <!-- 7. شريط إدخال التعليق (Voice/Text) (مطلوب) -->
    <div id="comment-input-area">
      <div id="comment-input-container">
        <!-- 7. تحديد 150 حرف (مطلوب) -->
        <textarea id="comment-input" placeholder="أضف صدى (نص أو صوت)..." maxlength="150"></textarea>
        <div id="char-count">0/150</div>
      </div>
      <!-- 8. زر التسجيل/الإرسال (مطلوب) -->
      <button id="send-voice-btn" title="اضغط للإرسال، اضغط مطولاً للتسجيل الصوتي">
        <i class="fas fa-microphone"></i>
      </button>
      <!-- (جديد) زر إلغاء التسجيل -->
      <button id="cancel-voice-btn" title="إلغاء التسجيل" style="display: none;">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>
</div>

<!-- 5. Modal الملف الشخصي (مطلوب) -->
<div id="profile-modal-overlay">
  <div id="profile-modal">
    <h2>الملف الشخصي</h2>
    
    <!-- 5. تعديل الاسم (مطلوب) -->
    <div class="profile-section">
      <h3>الاسم</h3>
      <input type="text" class="profile-input" id="profile-username" placeholder="اسم المستخدم">
    </div>
    
    <!-- 5. تعديل الجنس (مطلوب) -->
    <div class="profile-section">
      <h3>الجنس</h3>
      <div class="gender-selection">
        <label><input type="radio" name="profile-gender" value="male" style="display:none;"><i class="fas fa-mars male"></i> ذكر</label>
        <label><input type="radio" name="profile-gender" value="female" style="display:none;"><i class="fas fa-venus female"></i> أنثى</label>
      </div>
    </div>
    
    <!-- 5. تعديل اللون (مطلوب) -->
    <div class="profile-section">
      <h3>لون الواجهة</h3>
      <div class="color-selection" id="profile-color-selection">
        <div class="color-option" style="background-color: #00bcd4;" data-color="#00bcd4"></div>
        <div class="color-option" style="background-color: #ffeb3b;" data-color="#ffeb3b"></div>
        <div class="color-option" style="background-color: #f44336;" data-color="#f44336"></div>
        <div class="color-option" style="background-color: #ffffff;" data-color="#ffffff"></div>
      </div>
    </div>
    
    <button class="profile-btn" id="save-profile-btn">حفظ التغييرات</button>
    <button class="profile-btn" id="close-profile-btn" style="background: #555;">إلغاء</button>
  </div>
</div>

<!-- جلب مكتبات Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
  // تهيئة Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyAjE-2q6PONBkCin9ZN22gDp9Q8pAH9ZW8",
    authDomain: "story-97cf7.firebaseapp.com",
    databaseURL: "https://story-97cf7-default-rtdb.firebaseio.com",
    projectId: "story-97cf7",
    storageBucket: "story-97cf7.firebasestorage.app",
    messagingSenderId: "742801388214",
    appId: "1:742801388214:web:32a305a8057b0582c5ec17",
    measurementId: "G-9DPPWX7CF0"
  };

  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();

  document.addEventListener('DOMContentLoaded', () => {
    
    const USER_ID_KEY = 'neoflow_user_id'; // 1. تم تغيير الاسم
    const USER_COLOR_KEY = 'neoflow_user_color';
    const POSTS_PER_PAGE = 5;
    const COMMENTS_PER_LOAD = 10;
    
    let currentUser = null;
    let lastLoadedPostTimestamp = null;
    let allPostsLoaded = false;
    let isLoading = false;
    let currentPostId = null; 
    let lastLoadedCommentScore = null;
    let allCommentsLoaded = false;
    let isTextOnlyPost = false; // 6. لتحديد نوع المنشور

    // عناصر DOM 
    const loginScreen = document.getElementById('login-screen');
    const app = document.getElementById('app');
    const usernameInput = document.getElementById('username-input');
    const loginBtn = document.getElementById('login-btn');
    const userIconWrapper = document.getElementById('user-icon-wrapper'); // 4. تم تغيير العنصر
    const userIcon = document.getElementById('user-icon');
    const userGenderIcon = document.getElementById('user-gender-icon'); // 4. أيقونة الجنس (جديد)
    const postsContainer = document.getElementById('posts');
    const loadMoreBtn = document.getElementById('load-more-btn');
    const addPostBtn = document.getElementById('add-post-btn');
    
    // 6. عناصر الرفع الجديدة (مطلوب)
    const uploadChoiceOverlay = document.getElementById('upload-choice-overlay');
    const textOnlyOption = document.getElementById('text-only-option');
    const imageTextOption = document.getElementById('image-text-option');
    const closeChoiceModalBtn = document.getElementById('close-choice-modal-btn');
    
    const modalOverlay = document.getElementById('modal-overlay');
    const modal = document.getElementById('modal'); // 6. تم تغيير الاسم
    const modalTitle = document.getElementById('modal-title');
    const postTitleInput = document.getElementById('post-title-input');
    const imageUploadSection = document.getElementById('image-upload-section');
    const imagesInput = document.getElementById('images-input');
    const imagesPreview = document.getElementById('images-preview');
    const publishBtn = document.getElementById('publish-btn');
    const closeModalBtn = document.getElementById('close-modal-btn');
    
    const galleryViewerOverlay = document.getElementById('gallery-viewer-overlay');
    const closeGalleryBtn = document.getElementById('close-gallery-btn');
    
    // 7. عناصر التعليقات (مطلوب)
    const commentModalOverlay = document.getElementById('comment-modal-overlay');
    const closeCommentBtn = document.getElementById('close-comment-btn');
    const commentInput = document.getElementById('comment-input');
    const charCount = document.getElementById('char-count');
    const sendVoiceBtn = document.getElementById('send-voice-btn');
    const cancelVoiceBtn = document.getElementById('cancel-voice-btn'); // (جديد)
    const commentsList = document.getElementById('comments-list');
    const postDetailForComment = document.getElementById('post-detail-for-comment');
    const commentCountTitle = document.getElementById('comment-count-title');
    const loadMoreCommentsBtn = document.getElementById('load-more-comments-btn');
    
    // 5. عناصر الملف الشخصي (مطلوب)
    const profileModalOverlay = document.getElementById('profile-modal-overlay');
    const profileUsername = document.getElementById('profile-username');
    const profileColorSelection = document.getElementById('profile-color-selection');
    const saveProfileBtn = document.getElementById('save-profile-btn');
    const closeProfileBtn = document.getElementById('close-profile-btn');
    const colorOptionsLogin = document.querySelectorAll('#login-screen .color-option');

    let selectedImagesBase64 = [];
    
    // 8. متغيرات تسجيل الصوت (مطلوب)
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;
    // let pressTimer = null; // (تم الحذف) - لا نحتاج للضغطة المطولة
    let postScrollTimer = null;

    // ====== دوال المساعدة ======
    function escapeHTML(str) { const p = document.createElement('p'); p.textContent = str; return p.innerHTML; }
    
    // 4. دالة أيقونة الجنس (مطلوب)
    function getGenderIcon(gender) {
        if (gender === 'male') return `<i class="fas fa-mars gender-icon male"></i>`;
        if (gender === 'female') return `<i class="fas fa-venus female gender-icon"></i>`;
        return '';
    }
    
    // 5. دالة تعيين اللون (مطلوب)
    function setThemeColor(color) {
      document.documentElement.style.setProperty('--primary-color', color);
      document.documentElement.style.setProperty('--primary-accent', color);
      
      // حساب اللون الداكن
      if (!color || color.length < 7) {
        console.warn("Invalid color format:", color);
        document.documentElement.style.setProperty('--primary-accent-dark', '#555');
        document.documentElement.style.setProperty('--text-color-secondary', '#eee');
        return;
      }
      
      const hex = color.replace('#', '');
      const r = parseInt(hex.substr(0, 2), 16);
      const g = parseInt(hex.substr(2, 2), 16);
      const b = parseInt(hex.substr(4, 2), 16);
      
      const darken = (c) => Math.max(0, c - 40);
      const darkColor = `#${darken(r).toString(16).padStart(2, '0')}${darken(g).toString(16).padStart(2, '0')}${darken(b).toString(16).padStart(2, '0')}`;
      
      document.documentElement.style.setProperty('--primary-accent-dark', darkColor);
      document.documentElement.style.setProperty('--text-color-secondary', color);
    }

    // 7. عداد الأحرف (مطلوب)
    function updateCharCount() {
      const count = commentInput.value.length;
      charCount.textContent = `${count}/150`;
      
      if (count > 140) {
        charCount.style.color = '#ff4d4f';
      } else if (count > 120) {
        charCount.style.color = '#ffa500';
      } else {
        charCount.style.color = '#888';
      }
    }

    // 8. تحويل Blob إلى Base64 (للصور والصوت) (مطلوب)
    function blobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = error => reject(error);
        reader.readAsDataURL(blob);
      });
    }

    // 8. تحويل Base64 إلى نص رقمي للعرض (مطلوب)
    function base64ToNumericDisplay(base64) {
        // يزيل رأس البيانات (data:audio/wav;base64,)
        const data = base64.split(',')[1] || base64;
        // يعرض أول 100 حرف ويحولها إلى أرقام
        return data.substring(0, 100).replace(/[A-Za-z]/g, c => c.charCodeAt(0) % 10) + '...';
    }


    // ====== دوال التهيئة والتسجيل ======
    function init() {
      const userId = localStorage.getItem(USER_ID_KEY);
      const savedColor = localStorage.getItem(USER_COLOR_KEY);
      
      if (savedColor) {
        setThemeColor(savedColor);
        colorOptionsLogin.forEach(option => {
          option.classList.toggle('active', option.dataset.color === savedColor);
        });
      } else {
        setThemeColor('#00bcd4'); // اللون الافتراضي
      }
      
      if (userId) {
        showAppSkeletons(); 
        database.ref('users/' + userId).once('value').then(snapshot => {
          if (snapshot.exists()) {
            currentUser = { id: userId, ...snapshot.val() };
            // 5. تطبيق اللون المحفوظ للمستخدم (مطلوب)
            if (currentUser.color) {
              setThemeColor(currentUser.color);
              localStorage.setItem(USER_COLOR_KEY, currentUser.color);
            }
            showApp();
            loadPosts(true);
          } else {
            localStorage.removeItem(USER_ID_KEY);
            localStorage.removeItem(USER_COLOR_KEY);
            showLogin();
          }
        }).catch(error => { console.error("Firebase Error:", error); showLogin(); });
      } else {
        showLogin();
      }
    }
    
    function showLogin() { loginScreen.style.display = 'flex'; app.style.display = 'none'; }
    
    function showApp() { 
        loginScreen.style.display = 'none'; 
        app.style.display = 'flex'; 
        // 4. تحديث الأيقونة بالجنس (مطلوب)
        updateUserIcon(currentUser.username, currentUser.gender); 
        commentInput.addEventListener('input', updateCharCount);
        updateCharCount();
    }
    
    function showAppSkeletons() {
        loginScreen.style.display = 'none';
        app.style.display = 'flex';
        postsContainer.innerHTML = '';
        showSkeletons(POSTS_PER_PAGE);
    }
    
    // 4. تحديث أيقونة المستخدم (مطلوب)
    function updateUserIcon(name, gender) { 
      userIcon.textContent = name.trim()[0].toUpperCase(); 
      userGenderIcon.innerHTML = getGenderIcon(gender); // 4. إضافة أيقونة الجنس
    }
    
    function createAccount() {
      const username = usernameInput.value.trim();
      const gender = document.querySelector('#login-screen input[name="gender"]:checked').value;
      const selectedColor = document.querySelector('#login-screen .color-option.active').dataset.color;
      
      if (username.length === 0) return;
      
      loginBtn.disabled = true;
      loginBtn.textContent = 'جاري الإنشاء...';

      const newUserId = database.ref().child('users').push().key;
      // 4 & 5. حفظ الجنس واللون (مطلوب)
      database.ref('users/' + newUserId).set({ 
        username: username, 
        gender: gender,
        color: selectedColor
      })
        .then(() => {
          localStorage.setItem(USER_ID_KEY, newUserId);
          localStorage.setItem(USER_COLOR_KEY, selectedColor);
          setThemeColor(selectedColor);
          currentUser = { id: newUserId, username: username, gender: gender, color: selectedColor };
          showApp();
          loadPosts(true);
        })
        .catch(error => {
          console.error("Error creating account:", error);
          alert("حدث خطأ أثناء إنشاء الحساب.");
          loginBtn.disabled = false;
          loginBtn.textContent = 'إنشاء حساب';
        });
    }

    // ====== دوال عرض المنشورات الرئيسية ======
    function loadPosts(isInitial = false) {
        if (allPostsLoaded || isLoading) return;
        isLoading = true;
        loadMoreBtn.disabled = true;
        
        if (isInitial) { postsContainer.innerHTML = ''; }
        showSkeletons(isInitial ? POSTS_PER_PAGE : 2); 

        let postsRef = database.ref('posts').orderByChild('timestamp');
        
        if (!isInitial && lastLoadedPostTimestamp) {
            postsRef = postsRef.endAt(lastLoadedPostTimestamp - 1).limitToLast(POSTS_PER_PAGE);
        } else {
            postsRef = postsRef.limitToLast(POSTS_PER_PAGE);
        }

        postsRef.once('value', (snapshot) => {
            const posts = [];
            snapshot.forEach(childSnapshot => {
                posts.push({ id: childSnapshot.key, ...childSnapshot.val() });
            });

            removeSkeletons();

            if (posts.length === 0) {
              allPostsLoaded = true;
              loadMoreBtn.style.display = 'none';
              // 1. اسم "Vibes" (مطلوب)
              if (isInitial) { postsContainer.innerHTML = `<p style="text-align:center;color:#555;">لا توجد Vibes حتى الآن.</p>`; }
              isLoading = false;
              return;
            }
            
            posts.reverse();
            lastLoadedPostTimestamp = posts[posts.length - 1].timestamp;

            if (posts.length < POSTS_PER_PAGE) {
                allPostsLoaded = true;
                loadMoreBtn.style.display = 'none';
            } else {
                loadMoreBtn.style.display = 'block';
                loadMoreBtn.disabled = false;
            }
            renderPosts(posts);
            isLoading = false;
        });
    }

    function renderPosts(posts) {
        posts.forEach((post, index) => {
            const existingPost = document.getElementById(`post-${post.id}`);
            if (existingPost) return; 

            setTimeout(() => {
                const postEl = createPostElement(post);
                postsContainer.appendChild(postEl);
            }, index * 100);
        });
    }

    function createPostElement(post) {
        const postEl = document.createElement('article');
        postEl.className = 'post';
        postEl.id = `post-${post.id}`; 
        
        const likeCount = Object.keys(post.likes || {}).length;
        const dislikeCount = Object.keys(post.dislikes || {}).length;
        const commentCount = post.commentCount || 0;
        const isLiked = post.likes && post.likes[currentUser.id];
        const isDisliked = post.dislikes && post.dislikes[currentUser.id];
        const canDelete = post.userId === currentUser.id;
        const isTextOnly = !post.images || post.images.length === 0;

        let postHTML = `
            <div class="post-header">
                <div class="avatar">${post.username.trim()[0].toUpperCase()}</div>
                <div class="username">${escapeHTML(post.username)} ${getGenderIcon(post.gender || 'unknown')}</div>
            </div>
            <!-- 6. إظهار النص حتى لو كان فارغاً (في حال منشور الصور) (مطلوب) -->
            ${post.title.trim().length > 0 ? `<div class="post-title">${escapeHTML(post.title)}</div>` : ''}
            `;

        if (!isTextOnly) {
            postHTML += `<div class="post-images">`;
            const imagesToShow = post.images.slice(0, 4);

            imagesToShow.forEach((imgStr, idx) => {
                // 8. الصور مخزنة كـ Base64 (مطلوب)
                postHTML += `
                    <div class="img-wrapper" data-index="${idx}">
                        <img src="${imgStr}" alt="صورة ${idx + 1}" loading="lazy" />
                        ${(idx === 3 && post.images.length > 4) ? `<div class="more-overlay">+${post.images.length - 4}</div>` : ''}
                    </div>`;
            });
            postHTML += `</div>`;
        }

        postHTML += `
            <div class="post-actions">
                <div class="like-dislike-group">
                    <button class="action-btn like-btn ${isLiked ? 'active' : ''}" data-type="like" data-post-id="${post.id}">
                        <i class="fas fa-thumbs-up"></i>
                        <span id="like-count-${post.id}">${likeCount}</span>
                    </button>
                    <button class="action-btn dislike-btn ${isDisliked ? 'active' : ''}" data-type="dislike" data-post-id="${post.id}">
                        <i class="fas fa-thumbs-down"></i>
                        <span id="dislike-count-${post.id}">${dislikeCount}</span>
                    </button>
                </div>
                <!-- 1. اسم "الأصداء" (مطلوب) -->
                <button class="action-btn comment-btn" data-post-id="${post.id}" data-post-title="${escapeHTML(post.title)}">
                    <i class="fas fa-comment"></i>
                    <span id="comment-count-${post.id}">${commentCount}</span>
                </button>
                ${canDelete ? `<button class="action-btn delete-btn" data-post-id="${post.id}"><i class="fas fa-trash"></i> حذف</button>` : ''}
            </div>`;
        
        if (isTextOnly) {
             // 5. استخدام لون المستخدم (مطلوب)
             postHTML += `<div class="text-only-post-indicator" style="background-color: ${post.color || '#00bcd4'};"></div>`;
        }
        
        postEl.innerHTML = postHTML;

        postEl.querySelectorAll('.post-images .img-wrapper').forEach(wrapper => {
            wrapper.addEventListener('click', () => openGalleryViewer(post.images, post.id));
        });
        
        postEl.querySelectorAll('.like-btn, .dislike-btn').forEach(btn => {
            btn.addEventListener('click', () => handlePostReaction(post.id, btn.dataset.type));
        });

        postEl.querySelector('.comment-btn').addEventListener('click', (e) => openCommentModal(post.id, post.title));

        if(canDelete) {
            postEl.querySelector('.delete-btn').addEventListener('click', () => deletePost(post.id, post.images));
        }
        
        return postEl;
    }
    
    // 9. دوال تفاعلات المنشور (تحديث فوري) (مطلوب)
    function handlePostReaction(postId, type) {
        if (!currentUser) return;

        const postRef = database.ref(`posts/${postId}`);
        const userId = currentUser.id;
        const otherType = type === 'like' ? 'dislike' : 'like';

        // 9. التحديث الفوري للواجهة (مطلوب)
        const postEl = document.getElementById(`post-${postId}`);
        if (!postEl) return;
        
        const likeCountSpan = document.getElementById(`like-count-${postId}`);
        const dislikeCountSpan = document.getElementById(`dislike-count-${postId}`);
        const typeBtn = postEl.querySelector(`.${type}-btn`);
        const otherBtn = postEl.querySelector(`.${otherType}-btn`);
        
        const isCurrentlyActive = typeBtn.classList.contains('active');

        if (isCurrentlyActive) {
            // إلغاء التفعيل
            if(type === 'like') likeCountSpan.textContent = parseInt(likeCountSpan.textContent) - 1;
            if(type === 'dislike') dislikeCountSpan.textContent = parseInt(dislikeCountSpan.textContent) - 1;
            typeBtn.classList.remove('active');
        } else {
            // تفعيل
            if(type === 'like') likeCountSpan.textContent = parseInt(likeCountSpan.textContent) + 1;
            if(type === 'dislike') dislikeCountSpan.textContent = parseInt(dislikeCountSpan.textContent) + 1;
            typeBtn.classList.add('active');
            
            // إلغاء تفعيل الزر الآخر إذا كان نشطاً
            if (otherBtn.classList.contains('active')) {
                if(otherType === 'like') likeCountSpan.textContent = parseInt(likeCountSpan.textContent) - 1;
                if(otherType === 'dislike') dislikeCountSpan.textContent = parseInt(dislikeCountSpan.textContent) - 1;
                otherBtn.classList.remove('active');
            }
        }

        // إرسال التغييرات إلى Firebase في الخلفية
        postRef.transaction(currentPost => {
            if (currentPost) {
                currentPost.likes = currentPost.likes || {};
                currentPost.dislikes = currentPost.dislikes || {};

                // إزالة التصويت الآخر إن وجد
                if (currentPost[`${otherType}s`] && currentPost[`${otherType}s`][userId]) {
                    delete currentPost[`${otherType}s`][userId];
                }

                // إضافة أو إزالة التصويت الحالي
                if (isCurrentlyActive) { // كان نشطاً، والآن تم إلغاؤه
                    delete currentPost[`${type}s`][userId];
                } else { // لم يكن نشطاً، والآن تم تفعيله
                    currentPost[`${type}s`][userId] = true;
                }
                return currentPost;
            }
            return currentPost;
        });
    }

    function deletePost(postId, images) {
        // 9. استخدام نافذة تأكيد مخصصة بدلاً من confirm()
        if (!window.confirm('هل أنت متأكد من حذف هذا الـ Vibe؟ سيتم حذف جميع الأصداء والبيانات المرتبطة.')) return;

        database.ref(`posts/${postId}`).remove()
            .then(() => {
                return database.ref(`comments/${postId}`).remove();
            })
            .then(() => {
                const postEl = document.getElementById(`post-${postId}`);
                if (postEl) {
                    postEl.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                    postEl.style.opacity = '0';
                    postEl.style.transform = 'scale(0.9)';
                    setTimeout(() => postEl.remove(), 300);
                }
            })
            .catch(error => {
                console.error("Error deleting post:", error);
                alert("حدث خطأ أثناء حذف الـ Vibe.");
            });
    }

    // ====== 7. دوال نظام التعليقات (مطلوب) ======
    function openCommentModal(postId, postTitle) {
        currentPostId = postId;
        lastLoadedCommentScore = null;
        allCommentsLoaded = false;
        
        postDetailForComment.innerHTML = `<p class="comment-post-title">${escapeHTML(postTitle)}</p>`;
        commentsList.innerHTML = `<p style="text-align:center;color:#666; padding: 1rem 0;">جارٍ تحميل الأصداء...</p>`;
        commentInput.value = '';
        updateCharCount();
        
        loadComments(postId, true);
        
        // جلب العدد وتحديثه
        database.ref(`posts/${postId}/commentCount`).on('value', snapshot => {
            const count = snapshot.val() || 0;
            commentCountTitle.textContent = `الأصداء (${count})`;
            // 9. تحديث فوري لعداد المنشور (مطلوب)
            const postCommentCountSpan = document.getElementById(`comment-count-${postId}`);
            if (postCommentCountSpan) {
                postCommentCountSpan.textContent = count;
            }
        });
        
        commentModalOverlay.style.display = 'flex';
        setTimeout(() => { 
            commentModalOverlay.classList.add('active'); 
            commentInput.focus();
        }, 10);
        
        // 7. إخفاء التعليقات عند التمرير (مطلوب)
        document.addEventListener('scroll', hideCommentsOnScroll, { passive: true });
    }
    
    function closeCommentModal() {
        if (currentPostId) {
            database.ref(`posts/${currentPostId}/commentCount`).off(); // إيقاف المستمع
        }
        commentModalOverlay.classList.remove('active');
        setTimeout(() => { commentModalOverlay.style.display = 'none'; }, 300);
        currentPostId = null;
        document.removeEventListener('scroll', hideCommentsOnScroll);
    }
    
    // 7. دالة إخفاء التعليقات (مطلوب)
    function hideCommentsOnScroll() {
        if (commentModalOverlay.style.display === 'flex' && window.scrollY > 20) {
            clearTimeout(postScrollTimer);
            postScrollTimer = setTimeout(() => {
                if (document.activeElement !== commentInput) { // لا تغلق إذا كان المستخدم يكتب
                    closeCommentModal();
                }
            }, 100);
        }
    }

    function loadComments(postId, isInitial = false) {
        if (allCommentsLoaded) return;

        let commentsRef = database.ref(`comments/${postId}`).orderByChild('score');

        if (!isInitial && lastLoadedCommentScore !== null) {
            // جلب المزيد (أقدم من آخر تعليق)
            commentsRef = commentsRef.endAt(lastLoadedCommentScore - 1).limitToLast(COMMENTS_PER_LOAD);
        } else {
            // جلب أحدث التعليقات
            commentsRef = commentsRef.limitToLast(COMMENTS_PER_LOAD);
        }

        commentsRef.once('value', snapshot => {
            let comments = [];
            snapshot.forEach(childSnapshot => {
                // منع إضافة التعليقات المكررة عند "تحميل المزيد"
                if (!document.getElementById(`comment-${childSnapshot.key}`)) {
                    comments.push({ id: childSnapshot.key, ...childSnapshot.val() });
                }
            });

            if (comments.length === 0) {
                allCommentsLoaded = true;
                loadMoreCommentsBtn.style.display = 'none';
                if (isInitial) { commentsList.innerHTML = `<p style="text-align:center;color:#666;">لا توجد أصداء.</p>`; }
                return;
            }
            
            comments.reverse(); // ترتيبها من الأحدث للأقدم

            if (comments.length > 0) {
                lastLoadedCommentScore = comments[comments.length - 1].score;
            }

            if (comments.length < COMMENTS_PER_LOAD) {
                allCommentsLoaded = true;
                loadMoreCommentsBtn.style.display = 'none';
            } else {
                loadMoreCommentsBtn.style.display = 'inline-flex';
            }

            renderComments(comments, isInitial);
        });
    }

    function renderComments(comments, isInitial) {
        if (isInitial) commentsList.innerHTML = '';
        
        comments.forEach(comment => {
            const commentEl = createCommentElement(comment);
            commentsList.appendChild(commentEl);
        });
    }
    
    // 8. إنشاء عنصر التعليق (مع دعم الصوت) (مطلوب)
    function createCommentElement(comment) {
        const commentEl = document.createElement('div');
        commentEl.className = 'comment-item';
        commentEl.id = `comment-${comment.id}`;
        
        const likeCount = Object.keys(comment.likes || {}).length;
        const dislikeCount = Object.keys(comment.dislikes || {}).length;
        const isLiked = comment.likes && comment.likes[currentUser.id];
        const isDisliked = comment.dislikes && comment.dislikes[currentUser.id];
        const isVoice = !!comment.isVoice;
        const canDelete = comment.userId === currentUser.id;

        let contentHTML = '';
        if (isVoice) {
            // 8. عرض الصوت كأرقام (مطلوب)
            contentHTML = `
                <div class="comment-text">
                    <i class="fas fa-microphone comment-voice-icon"></i>
                    <span>صدى صوتي:</span>
                    <div class="comment-voice-data">${base64ToNumericDisplay(comment.text)}</div>
                </div>`;
        } else {
            contentHTML = `<div class="comment-text">${escapeHTML(comment.text)}</div>`;
        }

        commentEl.innerHTML = `
            <div class="comment-header">
                <div class="avatar" style="width: 25px; height: 25px; font-size: 0.8rem; background-color: #333; color: ${comment.gender === 'male' ? '#5dade2' : '#f1948a'};">${comment.username.trim()[0].toUpperCase()}</div>
                <div class="username">${escapeHTML(comment.username)}</div>
            </div>
            ${contentHTML}
            <div class="comment-actions">
                <button class="like-btn ${isLiked ? 'active' : ''}" data-comment-id="${comment.id}" data-type="like">
                    <i class="fas fa-thumbs-up"></i> <span class="count">${likeCount}</span>
                </button>
                <button class="dislike-btn ${isDisliked ? 'active' : ''}" data-comment-id="${comment.id}" data-type="dislike">
                    <i class="fas fa-thumbs-down"></i> <span class="count">${dislikeCount}</span>
                </button>
                ${canDelete ? `<button class="delete-comment-btn" data-comment-id="${comment.id}"><i class="fas fa-trash" style="color:var(--delete-color);"></i></button>` : ''}
            </div>
        `;
        
        commentEl.querySelectorAll('.like-btn, .dislike-btn').forEach(btn => {
            btn.addEventListener('click', () => handleCommentReaction(currentPostId, comment.id, btn.dataset.type));
        });

        if(canDelete) {
            commentEl.querySelector('.delete-comment-btn').addEventListener('click', () => deleteComment(currentPostId, comment.id));
        }

        return commentEl;
    }

    // 9. تفاعل التعليقات (تحديث فوري) (مطلوب)
    function handleCommentReaction(postId, commentId, type) {
        if (!currentUser || !postId) return;

        const commentRef = database.ref(`comments/${postId}/${commentId}`);
        const userId = currentUser.id;
        const otherType = type === 'like' ? 'dislike' : 'like';

        // 9. التحديث الفوري للواجهة (مطلوب)
        const commentEl = document.getElementById(`comment-${commentId}`);
        if (!commentEl) return;
        
        const typeBtn = commentEl.querySelector(`.${type}-btn`);
        const otherBtn = commentEl.querySelector(`.${otherType}-btn`);
        const typeCountSpan = typeBtn.querySelector('.count');
        const otherCountSpan = otherBtn.querySelector('.count');

        const isCurrentlyActive = typeBtn.classList.contains('active');
        
        if (isCurrentlyActive) {
            // إلغاء التفعيل
            typeCountSpan.textContent = parseInt(typeCountSpan.textContent) - 1;
            typeBtn.classList.remove('active');
        } else {
            // تفعيل
            typeCountSpan.textContent = parseInt(typeCountSpan.textContent) + 1;
            typeBtn.classList.add('active');
            
            if (otherBtn.classList.contains('active')) {
                otherCountSpan.textContent = parseInt(otherCountSpan.textContent) - 1;
                otherBtn.classList.remove('active');
            }
        }

        // إرسال التغييرات إلى Firebase في الخلفية
        commentRef.transaction(currentComment => {
            if (currentComment) {
                currentComment.likes = currentComment.likes || {};
                currentComment.dislikes = currentComment.dislikes || {};

                if (currentComment[`${otherType}s`] && currentComment[`${otherType}s`][userId]) {
                    delete currentComment[`${otherType}s`][userId];
                }

                if (isCurrentlyActive) { // كان نشطاً
                    delete currentComment[`${type}s`][userId];
                } else { // لم يكن نشطاً
                    currentComment[`${type}s`][userId] = true;
                }
                
                // تحديث الـ score (للترتيب)
                const likeCount = Object.keys(currentComment.likes).length;
                const dislikeCount = Object.keys(currentComment.dislikes).length;
                currentComment.score = (likeCount - dislikeCount) * 10000000000 + currentComment.timestamp;

                return currentComment;
            }
            return currentComment;
        });
    }

    function deleteComment(postId, commentId) {
        if (!window.confirm('هل أنت متأكد من حذف هذا الصدى؟')) return;

        database.ref(`comments/${postId}/${commentId}`).remove()
            .then(() => {
                // 9. تحديث فوري (مطلوب)
                const commentEl = document.getElementById(`comment-${commentId}`);
                if (commentEl) commentEl.remove();
                return database.ref(`posts/${postId}/commentCount`).transaction(count => (count || 0) - 1);
            })
            .catch(error => {
                console.error("Error deleting comment:", error);
                alert("حدث خطأ أثناء حذف الصدى.");
            });
    }

    // ====== 8. دوال تسجيل الصوت (مطلوب) ======
    
    async function startRecording() {
      if (isRecording) return;
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        isRecording = true;
        audioChunks = [];
        mediaRecorder = new MediaRecorder(stream);
        
        mediaRecorder.ondataavailable = event => {
          audioChunks.push(event.data);
        };
        
        mediaRecorder.onstop = handleRecordingStop;
        mediaRecorder.start();
        
        sendVoiceBtn.classList.add('recording');
        sendVoiceBtn.innerHTML = '<i class="fas fa-stop"></i>';
        cancelVoiceBtn.style.display = 'flex'; // (جديد) إظهار زر الإلغاء
        commentInput.disabled = true;
        commentInput.placeholder = 'جارٍ تسجيل الصدى...'; // (تغيير)
        
      } catch (err) {
        console.error("Error accessing microphone:", err);
        alert("لا يمكن الوصول إلى الميكروفون. يرجى السماح بالوصول.");
      }
    }
    
    // (جديد) تم تعديل الدالة لتقبل متغير
    function stopRecording(shouldSend = true) {
      if (!isRecording || !mediaRecorder) return;
      
      mediaRecorder.shouldSend = shouldSend; // (جديد) تخزين نية الإرسال
      mediaRecorder.stop();
      isRecording = false;
      
      sendVoiceBtn.classList.remove('recording');
      sendVoiceBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; // جاري المعالجة
      sendVoiceBtn.disabled = true; // منع الضغطات المتعددة
      cancelVoiceBtn.style.display = 'none'; // (جديد) إخفاء زر الإلغاء
    }
    
    async function handleRecordingStop() {
      const shouldSend = mediaRecorder.shouldSend; // (جديد) جلب النية
      const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });

      try {
        if (shouldSend) { // (جديد) التحقق قبل الإرسال
          const base64Audio = await blobToBase64(audioBlob);
          // 8. إرسال الصوت (Base64) كتعليق (مطلوب)
          submitComment(base64Audio, true);
        } // إذا كانت false (إلغاء)، لا تفعل شيئاً بالبيانات
      } catch (err) {
        console.error("Error processing audio:", err);
        if (shouldSend) alert("حدث خطأ أثناء معالجة الصوت.");
      } finally {
        commentInput.disabled = false;
        commentInput.placeholder = 'أضف صدى (نص أو صوت)...';
        sendVoiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
        sendVoiceBtn.disabled = false;
        audioChunks = [];
      }
    }

    // ====== 7 & 8. دوال إرسال التعليق (مطلوب) ======
    
    // (جديد) مستمع الضغطة الواحدة
    sendVoiceBtn.addEventListener('click', () => {
        if (isRecording) {
            // الضغطة الثانية: إيقاف وإرسال
            stopRecording(true); 
        } else if (commentInput.value.trim() !== '') {
            // إرسال النص
            submitComment(commentInput.value.trim(), false);
        } else {
            // الضغطة الأولى: بدء التسجيل
            startRecording();
        }
    });

    // (جديد) مستمع زر الإلغاء
    cancelVoiceBtn.addEventListener('click', () => {
        if (isRecording) {
            stopRecording(false); // إيقاف وإلغاء
        }
    });
    
    // (تم الحذف) كل مستمعي mousedown/touchstart/mouseup/touchend
    
    commentInput.addEventListener('input', () => {
        updateCharCount();
        if (isRecording) return; // (جديد) لا تغير الأيقونة أثناء التسجيل
        
        if(commentInput.value.trim() !== '' && !isRecording) {
            sendVoiceBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
        } else if (!isRecording) {
            sendVoiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
        }
    });

    // 8. دالة إرسال التعليق الموحدة (مطلوب)
    function submitComment(content, isVoice = false) {
        if (!currentPostId || !content) return;
        
        if(sendVoiceBtn.disabled && !isVoice) return; // منع الإرسال المتعدد للنص
        
        const commentData = {
            userId: currentUser.id,
            username: currentUser.username,
            gender: currentUser.gender,
            text: content, // 8. (إما نص أو Base64 صوت) (مطلوب)
            isVoice: isVoice, // 8. تحديد النوع (مطلوب)
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            likes: {},
            dislikes: {},
        };
        // 9. Score للترتيب (الأحدث أولاً، ثم حسب التفاعل)
        commentData.score = 0 + (Date.now() * -1); // الأحدث (الأقل) يظهر أولاً

        const commentsPath = `comments/${currentPostId}`;
        const newCommentRef = database.ref(commentsPath).push();
        commentData.id = newCommentRef.key;

        // 9. إضافة التعليق للواجهة فوراً (مطلوب)
        if (isInitialLoad(commentsList)) {
            commentsList.innerHTML = ''; // إزالة رسالة "لا توجد أصداء"
        }
        const commentEl = createCommentElement(commentData);
        commentsList.prepend(commentEl); // إضافة في الأعلى
        commentEl.style.animation = 'slideDownFade 0.5s ease-out';


        newCommentRef.set(commentData)
            .then(() => {
                // تحديث عداد المنشور
                return database.ref(`posts/${currentPostId}/commentCount`).transaction(count => (count || 0) + 1);
            })
            .catch(error => {
                console.error("Error submitting comment:", error);
                alert("حدث خطأ أثناء إرسال الصدى.");
                commentEl.remove(); // إزالة التعليق إذا فشل الإرسال
            });
        
        if (!isVoice) {
            commentInput.value = '';
            updateCharCount();
            sendVoiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
        }
    }
    
    function isInitialLoad(list) {
        return list.children.length === 1 && list.children[0].tagName === 'P';
    }

    // ====== 6. دوال نشر المنشورات (مطلوب) ======
    
    function publishPost() {
      const title = postTitleInput.value.trim();
      
      // 6. التحقق من الصحة (مطلوب)
      if (isTextOnlyPost && title.length === 0) {
        alert("يرجى كتابة الـ Vibe أولاً.");
        return;
      }
      if (!isTextOnlyPost && selectedImagesBase64.length === 0) {
        alert("يرجى اختيار صورة واحدة على الأقل.");
        return;
      }

      publishBtn.disabled = true;
      publishBtn.textContent = 'جاري النشر...';

      const newPost = {
        userId: currentUser.id,
        username: currentUser.username,
        gender: currentUser.gender,
        title: title, // 6. النص (قد يكون فارغاً إذا كان منشور صور) (مطلوب)
        images: selectedImagesBase64, // 6. الصور (قد تكون فارغة إذا كان نصياً) (مطلوب)
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        likes: {},
        dislikes: {},
        commentCount: 0,
        color: currentUser.color // 5. لون المستخدم (مطلوب)
      };

      database.ref('posts').push(newPost)
        .then((newPostRef) => {
          // 9. التحديث الفوري (مطلوب)
          newPost.id = newPostRef.key;
          const postEl = createPostElement(newPost);
          if (isInitialLoad(postsContainer)) {
            postsContainer.innerHTML = ''; // إزالة رسالة "لا توجد Vibes"
          }
          postsContainer.prepend(postEl);
          postEl.style.animation = 'slideDownFade 0.5s ease-out';
          
          closeModal();
        })
        .catch(error => {
          console.error("Error publishing post:", error);
          alert("حدث خطأ أثناء النشر.");
        })
        .finally(() => {
            publishBtn.disabled = false;
            publishBtn.textContent = 'نشر الـ Vibe';
        });
    }

    // 6. دوال نوافذ الرفع (مطلوب)
    function openUploadChoice() {
      uploadChoiceOverlay.style.display = 'flex';
      setTimeout(() => uploadChoiceOverlay.classList.add('active'), 10);
    }
    function closeUploadChoice() {
      uploadChoiceOverlay.classList.remove('active');
      setTimeout(() => uploadChoiceOverlay.style.display = 'none', 300);
    }
    
    function openUploadModal(isTextOnly) {
      closeUploadChoice(); // إغلاق نافذة الاختيار
      isTextOnlyPost = isTextOnly;
      
      postTitleInput.value = '';
      imagesInput.value = '';
      imagesPreview.innerHTML = '';
      selectedImagesBase64 = [];
      
      if (isTextOnly) {
        imageUploadSection.style.display = 'none';
        modalTitle.textContent = 'Vibe نصي فقط';
        postTitleInput.placeholder = 'اكتب الـ Vibe هنا...';
      } else {
        imageUploadSection.style.display = 'block';
        modalTitle.textContent = 'Vibe (صورة + نص)';
        postTitleInput.placeholder = 'اكتب الـ Vibe هنا... (النص اختياري)';
      }
      
      checkPublishEnable(); // تفعيل/تعطيل الزر
      
      modalOverlay.style.display = 'flex';
      setTimeout(() => modalOverlay.classList.add('active'), 10);
      postTitleInput.focus();
    }
    
    function closeModal() { 
      modalOverlay.classList.remove('active');
      setTimeout(() => modalOverlay.style.display = 'none', 300);
    }
    
    function openGalleryViewer(imagesArray, postId) {
      const galleryContainer = document.getElementById('gallery-container');
      galleryContainer.innerHTML = '';
      imagesArray.forEach((imgSrc, index) => {
        const item = document.createElement('div');
        item.className = 'gallery-item';
        const img = document.createElement('img');
        img.src = imgSrc;
        img.alt = `صورة ${index + 1}`;
        const downloadLink = document.createElement('a');
        downloadLink.href = imgSrc;
        downloadLink.download = `neoflow-${postId}-image-${index + 1}.png`;
        downloadLink.className = 'download-btn';
        downloadLink.innerHTML = `<i class="fas fa-download"></i>`;
        item.appendChild(img);
        item.appendChild(downloadLink);
        galleryContainer.appendChild(item);
      });
      galleryViewerOverlay.style.display = 'block';
    }
    
    function closeGalleryViewer() { galleryViewerOverlay.style.display = 'none'; }
    
    // 5. دوال الملف الشخصي (مطلوب)
    function openProfileModal() {
      profileUsername.value = currentUser.username;
      
      document.querySelectorAll('#profile-modal input[name="profile-gender"]').forEach(radio => {
        radio.checked = radio.value === currentUser.gender;
      });
      
      profileColorSelection.querySelectorAll('.color-option').forEach(option => {
        option.classList.toggle('active', option.dataset.color === currentUser.color);
      });
      
      profileModalOverlay.style.display = 'flex';
    }
    
    function closeProfileModal() {
      profileModalOverlay.style.display = 'none';
    }
    
    function saveProfile() {
      const newUsername = profileUsername.value.trim();
      const newGender = document.querySelector('#profile-modal input[name="profile-gender"]:checked').value;
      const newColor = profileColorSelection.querySelector('.color-option.active').dataset.color;
      
      if (newUsername.length === 0) {
        alert('يرجى إدخال اسم مستخدم صحيح');
        return;
      }
      
      // 9. تحديث فوري (مطلوب)
      currentUser.username = newUsername;
      currentUser.gender = newGender;
      currentUser.color = newColor;
      
      localStorage.setItem(USER_COLOR_KEY, newColor);
      setThemeColor(newColor);
      updateUserIcon(newUsername, newGender); // 4. تحديث الأيقونة
      
      saveProfileBtn.disabled = true;
      saveProfileBtn.textContent = 'جاري الحفظ...';

      database.ref('users/' + currentUser.id).update({
        username: newUsername,
        gender: newGender,
        color: newColor
      })
      .then(() => {
        closeProfileModal();
        // (ملاحظة: تحديث الاسم في المنشورات القديمة يتطلب وظائف سحابية،
        // لكن المنشورات الجديدة ستستخدم الاسم المحدث)
      })
      .catch(error => {
        console.error("Error updating profile:", error);
        alert("حدث خطأ أثناء حفظ التغييرات.");
        // (يمكنك إعادة القيم القديمة هنا إذا فشل الحفظ)
      })
      .finally(() => {
        saveProfileBtn.disabled = false;
        saveProfileBtn.textContent = 'حفظ التغييرات';
      });
    }
    
    // 8. معالجة الصور (مطلوب)
    imagesInput.addEventListener('change', async () => {
      const files = Array.from(imagesInput.files).slice(0, 6);
      selectedImagesBase64 = []; 
      imagesPreview.innerHTML = '';
      
      if (files.length === 0) { 
        checkPublishEnable(); 
        return; 
      }

      for (const file of files) {
        if (!file.type.startsWith('image/')) continue;
        
        try {
          // (يمكن إضافة ضغط للصور هنا قبل التحويل لـ Base64)
          const base64 = await blobToBase64(file);
          selectedImagesBase64.push(base64);
          
          const img = document.createElement('img');
          img.src = base64;
          imagesPreview.appendChild(img);
        } catch (error) {
          console.error("Error converting image to base64:", error);
        }
      }
      
      checkPublishEnable();
    });
    
    // 6. التحقق من صلاحية النشر (مطلوب)
    function checkPublishEnable() {
      const titleFilled = postTitleInput.value.trim().length > 0;
      const hasImages = selectedImagesBase64.length > 0;
      
      if (isTextOnlyPost) {
        publishBtn.disabled = !titleFilled; // 6. النص إجباري
      } else {
        publishBtn.disabled = !hasImages; // 6. الصور إجبارية (النص اختياري)
      }
    }
    
    // ====== دوال الهيكل العظمي (Skeletons) ======
    function showSkeletons(count) {
        for (let i = 0; i < count; i++) {
            const skeletonEl = document.createElement('div');
            skeletonEl.className = 'skeleton-post';
            skeletonEl.innerHTML = `
                <div class="skeleton-header">
                    <div class="skeleton skeleton-avatar"></div>
                    <div class="skeleton skeleton-username"></div>
                </div>
                <div class="skeleton skeleton-title"></div>
                <div class="skeleton-images">
                    <div class="skeleton skeleton-img"></div>
                    <div class="skeleton skeleton-img"></div>
                </div>`;
            postsContainer.appendChild(skeletonEl);
        }
    }
    
    function removeSkeletons() {
        const skeletons = postsContainer.querySelectorAll('.skeleton-post');
        skeletons.forEach(s => s.remove());
    }
    
    // ====== مستمعي الأحداث الرئيسية ======
    usernameInput.addEventListener('input', () => { loginBtn.disabled = usernameInput.value.trim().length === 0; });
    loginBtn.addEventListener('click', createAccount);
    userIconWrapper.addEventListener('click', openProfileModal); // 4. تم تغيير العنصر
    addPostBtn.addEventListener('click', openUploadChoice); // 6. تم تغيير الدالة
    loadMoreBtn.addEventListener('click', () => loadPosts(false));
    
    // 6. مستمعو الرفع (جديد)
    uploadChoiceOverlay.addEventListener('click', e => (e.target === uploadChoiceOverlay) && closeUploadChoice());
    closeChoiceModalBtn.addEventListener('click', closeUploadChoice);
    textOnlyOption.addEventListener('click', () => openUploadModal(true));
    imageTextOption.addEventListener('click', () => openUploadModal(false));
    modalOverlay.addEventListener('click', e => (e.target === modalOverlay) && closeModal());
    closeModalBtn.addEventListener('click', closeModal);
    
    galleryViewerOverlay.addEventListener('click', e => (e.target === galleryViewerOverlay) && closeGalleryViewer());
    closeGalleryBtn.addEventListener('click', closeGalleryViewer);
    postTitleInput.addEventListener('input', checkPublishEnable);
    publishBtn.addEventListener('click', publishPost);
    
    // 7. مستمعو التعليقات
    closeCommentBtn.addEventListener('click', closeCommentModal);
    commentModalOverlay.addEventListener('click', e => (e.target === commentModalOverlay) && closeCommentModal());
    loadMoreCommentsBtn.addEventListener('click', () => loadComments(currentPostId, false));
    
    // (تعديل) مستمع Enter لإرسال النص فقط
    commentInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) { 
            e.preventDefault(); 
            if (!isRecording && commentInput.value.trim()) {
                submitComment(commentInput.value.trim(), false);
            }
        }
    });
    
    // 5. مستمعو الملف الشخصي
    saveProfileBtn.addEventListener('click', saveProfile);
    closeProfileBtn.addEventListener('click', closeProfileModal);
    
    // 5. مستمعو الألوان (لصفحتي التسجيل والملف الشخصي)
    document.querySelectorAll('.color-selection').forEach(selection => {
      selection.addEventListener('click', function(e) {
        if (e.target.classList.contains('color-option')) {
          // إزالة 'active' من كل الأزرار داخل هذا الـ container
          this.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('active'));
          // إضافة 'active' للزر المضغوط
          e.target.classList.add('active');
          // 5. تطبيق اللون فوراً (مطلوب)
          const newColor = e.target.dataset.color;
          setThemeColor(newColor);
        }
      });
    });

    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        if (uploadChoiceOverlay.style.display === 'flex') closeUploadChoice();
        if (modalOverlay.style.display === 'flex') closeModal();
        if (galleryViewerOverlay.style.display === 'block') closeGalleryViewer();
        if (commentModalOverlay.style.display === 'flex') closeCommentModal();
        if (profileModalOverlay.style.display === 'flex') closeProfileModal();
      }
    });

    // بدء التطبيق
    init();
  });
</script>
</body>
</html>
